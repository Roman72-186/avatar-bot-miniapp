# Avatar Studio AI — Telegram Mini App

## Стек

| Компонент | Решение |
|---|---|
| Frontend | React + Vite + Telegram Web App SDK |
| Деплой фронта | Vercel (`avatar-bot-miniapp.vercel.app`) |
| Backend / логика | n8n (Timeweb VPS, доступен извне через Traefik) |
| AI-генерация | fal.ai (flux, minimax, birefnet, face-swap и др.) |
| Перевод промптов | OpenAI gpt-4.1-nano (RU -> EN) |
| БД | PostgreSQL 16 (Docker на Timeweb VPS) |
| Хранение файлов | fal.ai storage (upload через REST API) |
| Бот | @those_are_the_gifts_bot |
| Платежи | Telegram Stars через Bot API |

---

## Сделано

### Инфраструктура
- [x] PostgreSQL развёрнут (Docker, БД `avatar_bot`)
- [x] Таблицы: `users` (баланс, лимиты, рефералы), `generations` (история, TTL 24ч)
- [x] n8n доступен извне (`n8n.creativeanalytic.ru`)
- [x] Бот зарегистрирован через BotFather
- [x] fal.ai API key получен
- [x] Vercel подключён к GitHub (auto-deploy)
- [x] Telegram webhook настроен (`allowed_updates: message, pre_checkout_query`)

### Frontend (React)
- [x] React + Vite проект
- [x] Telegram Web App SDK интеграция
- [x] Загрузка фото (камера + галерея) со сжатием через canvas
- [x] Выбор режима генерации (8 режимов, карточки с описанием)
- [x] Экран ожидания с пошаговым статусом
- [x] Экран результата (просмотр, скачать, поделиться)
- [x] Поддержка тёмной темы Telegram
- [x] Баланс звёзд и бесплатные генерации в шапке (per-mode)
- [x] Пополнение звёзд через Telegram Stars (модалка с пакетами)
- [x] История генераций (localStorage кэш + БД, TTL 24ч, удаление)
- [x] Админ-панель (статистика пользователей, генераций, баланса)
- [x] Fix: CORS/blob для видео на Android (прямой URL)
- [x] Человекочитаемые ошибки на русском (таймаут, сеть, баланс, AI)
- [x] Экран реферальной программы (статистика, уровни, последние 10 рефералов, ссылка)

### Backend (n8n workflows) — 18 воркфлоу
- [x] `user-status` — регистрация/проверка юзера, баланс, лимиты (per-mode free)
- [x] `generate` — стилизация (flux/dev/image-to-image), free_stylize
- [x] `generate-multi` — мульти-фото генерация (flux-2-pro/edit)
- [x] `generate-style-transfer` — перенос стиля по референсу
- [x] `generate-video` — фото в видео (minimax/hailuo)
- [x] `generate-face-swap` — замена лица
- [x] `generate-remove-bg` — удаление фона (birefnet), free_remove_bg
- [x] `generate-enhance` — улучшение качества (clarity-upscaler), free_enhance
- [x] `generate-text-to-image` — генерация по текстовому описанию
- [x] `create-invoice` — создание инвойса Telegram Stars
- [x] `bot-start-handler` — /start (реферал), pre_checkout, payment (реферальный бонус)
- [x] `user-generations` — история генераций (SELECT с TTL 24ч)
- [x] `delete-generation` — удаление генерации из БД
- [x] `admin-stats` — статистика для админки
- [x] `daily-free-reset` — cron 00:00, сброс free_stylize/remove_bg/enhance
- [x] `referral-stats` — статистика рефералов (total, paid, earnings, recent 10)
- [x] Перевод промптов RU->EN через OpenAI (text-to-image, multi, video)
- [x] Сохранение генераций в БД (INSERT во всех 8 воркфлоу)

### Монетизация
- [x] Telegram Stars Payments (полный цикл: invoice -> pre_checkout -> payment -> balance update)
- [x] Разные цены за режимы (3-50 звёзд)
- [x] 3 бесплатные генерации в день (стилизация: 1, убрать фон: 1, улучшить: 1)

### Реферальная система
- [x] Deep link: `t.me/those_are_the_gifts_bot?start=ref_USERID`
- [x] Тир-система бонусов (звёзды на баланс реферера):
  - 1–5 рефералов: +1 ⭐ за каждого
  - 6–10: +2 ⭐, 11–15: +3 ⭐, 16–20: +4 ⭐ и т.д.
- [x] Бонус начисляется только при первом пополнении баланса рефералом
- [x] Уведомления реферера: при переходе по ссылке + при первом пополнении
- [x] Экран «Рефералы»: статистика, уровни, последние 10, invite-кнопка

---

## Нужно сделать

### Приоритет 1 — Запуск
- [ ] **Тестирование на реальных устройствах** — iOS + Android, разные модели
- [ ] **Канал бота** — описание, превью, ссылки

### Приоритет 2 — Улучшения
- [ ] **Адаптивная вёрстка** — проверить на мелких экранах, iPad

### Приоритет 3 — Продвижение
- [ ] Записать 3-5 Reels/Shorts (before/after)
- [ ] Подать в каталоги ботов (tAppsCenter и аналоги)
- [ ] Пост на VC.ru / Habr
- [ ] Отслеживать метрики (конверсия, retention, K-factor)

---

## Нерациональные / отложенные идеи

| Идея | Почему не сейчас |
|---|---|
| Водяной знак на бесплатных | Усложняет backend (нужен image processing на сервере), RAM ограничена. Лучше ограничить количество бесплатных |
| Генерация стикерпаков | Сложная интеграция, мало спроса, отвлекает от основного продукта |
| Брендинг на изображениях | Снижает ценность результата для пользователя, отталкивает |
| Запись транзакций в отдельную таблицу | Telegram сам хранит историю платежей. Можно добавить позже если нужна аналитика |
| Премиум-стили (только за Stars) | Все режимы уже платные (кроме 3 с лимитом). Искусственное ограничение не нужно |
| Пакеты со скидкой (15 Stars за 10) | Усложняет UI. Пользователь и так покупает нужное количество звёзд |
| Аналитика (Amplitude) | Overkill для MVP. Достаточно админ-панели |

---

## Ключевые метрики (цели)

| Метрика | Цель |
|---|---|
| Виральный коэффициент (K-factor) | > 1.0 |
| Конверсия в оплату | 3-7% |
| CPA (стоимость привлечения) | < 30 руб |
| LTV (доход с пользователя) | > 50 руб |
| Retention Day 7 | > 15% |

---

## Ограничения сервера

- **RAM:** 1.9 GB — не ставить тяжёлые сервисы
- **Amnezia VPN** — не трогать контейнер `amnezia-awg` (UDP:36415)
- **Traefik** — порт 443, маршрутизация
- **Диск:** ~22 GB свободно. Картинки хранятся на fal.ai, не на сервере
