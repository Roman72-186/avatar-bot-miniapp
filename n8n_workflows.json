{"data":[{"updatedAt":"2026-01-29T07:52:41.975Z","createdAt":"2026-01-29T07:22:11.673Z","id":"QiwOAvX8w3ZiA5Q3DYX2j","name":"–ò–ü –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –ü–æ–º–æ—â–Ω–∏–∫","active":false,"isArchived":false,"nodes":[{"parameters":{"updates":["message"],"additionalFields":{}},"id":"3388fcb8-ddb6-4d3e-95a5-3ab52ea59f33","name":"Telegram Trigger","type":"n8n-nodes-base.telegramTrigger","typeVersion":1.1,"position":[-2032,208],"webhookId":"ip-finance-bot","credentials":{"telegramApi":{"id":"SHdt9cjQ3b6ZCnAM","name":"–§–ò–ù–£–ß–ï–¢"}}},{"parameters":{"conditions":{"options":{"caseSensitive":false,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"voice-check","leftValue":"={{ $json.message.voice }}","rightValue":"","operator":{"type":"object","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"id":"36b87673-ca27-47c2-aad8-4e4992f147a7","name":"–ì–æ–ª–æ—Å–æ–≤–æ–µ?","type":"n8n-nodes-base.if","typeVersion":2,"position":[-1808,208]},{"parameters":{"resource":"file","fileId":"={{ $json.message.voice.file_id }}","additionalFields":{}},"id":"bbbc29fb-2346-406e-b1a3-c7ec1ca7bc27","name":"–ü–æ–ª—É—á–∏—Ç—å —Ñ–∞–π–ª","type":"n8n-nodes-base.telegram","typeVersion":1.2,"position":[-1584,112],"webhookId":"6535c760-b2c3-4259-a96b-9651bb4da48a","credentials":{"telegramApi":{"id":"SHdt9cjQ3b6ZCnAM","name":"–§–ò–ù–£–ß–ï–¢"}}},{"parameters":{"url":"={{ $json.result.file_id }}","options":{}},"id":"1f55e26f-87c3-4ea0-b24d-d4a310edc05a","name":"–°–∫–∞—á–∞—Ç—å –≥–æ–ª–æ—Å–æ–≤–æ–µ","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-1344,224]},{"parameters":{"resource":"audio","operation":"transcribe","options":{"language":"ru","temperature":0}},"id":"12273ccd-1e29-413f-9154-62df55673b40","name":"Whisper –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞","type":"@n8n/n8n-nodes-langchain.openAi","typeVersion":1.3,"position":[-1152,112],"credentials":{"openAiApi":{"id":"P0RwIIFegl7Qbpo2","name":"OpenAi account"}}},{"parameters":{"assignments":{"assignments":[{"id":"merge-text","name":"messageText","value":"={{ $json.text }}","type":"string"},{"id":"chat-id","name":"chatId","value":"={{ $('Telegram Trigger').item.json.message.chat.id }}","type":"number"}]},"options":{}},"id":"0122df20-e15b-412d-9024-5ae04c136298","name":"–¢–µ–∫—Å—Ç –∏–∑ –≥–æ–ª–æ—Å–∞","type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-928,112]},{"parameters":{"assignments":{"assignments":[{"id":"text-msg","name":"messageText","value":"={{ $json.message.text }}","type":"string"},{"id":"chat-id-text","name":"chatId","value":"={{ $json.message.chat.id }}","type":"number"}]},"options":{}},"id":"8e8e8550-164d-4c53-ba47-934eb77de419","name":"–¢–µ–∫—Å—Ç –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è","type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-1584,304]},{"parameters":{},"id":"bc4c8646-29d6-4a19-add4-be168a71942c","name":"–û–±—ä–µ–¥–∏–Ω–∏—Ç—å","type":"n8n-nodes-base.merge","typeVersion":3,"position":[-704,208]},{"parameters":{"modelId":{"__rl":true,"value":"gpt-4.1-nano","mode":"list","cachedResultName":"GPT-4.1-NANO"},"messages":{"values":[{"content":"–¢—ã ‚Äî —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –ò–ü –ø–æ —Ä–µ–º–æ–Ω—Ç—É –æ—Ä–≥—Ç–µ—Ö–Ω–∏–∫–∏. –ê–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –∏–∑–≤–ª–µ–∫–∞–π —Ñ–∏–Ω–∞–Ω—Å–æ–≤—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é.\n\n–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏ –∏ –∏–∑–≤–ª–µ—á—å –¥–∞–Ω–Ω—ã–µ –≤ JSON —Ñ–æ—Ä–º–∞—Ç–µ.\n\n–¢–ò–ü–´ –û–ü–ï–†–ê–¶–ò–ô:\n1. \"income\" ‚Äî –¥–æ—Ö–æ–¥ –æ—Ç —Ä–∞–±–æ—Ç—ã (–∑–∞–ø—Ä–∞–≤–∫–∞, —Ä–µ–º–æ–Ω—Ç, –∑–∞–º–µ–Ω–∞ –¥–µ—Ç–∞–ª–µ–π)\n2. \"expense\" ‚Äî —Ä–∞—Å—Ö–æ–¥ (–ø–æ–∫—É–ø–∫–∞ —Ç–æ–Ω–µ—Ä–∞, –∑–∞–ø—á–∞—Å—Ç–µ–π, —Ä–∞—Å—Ö–æ–¥–Ω–∏–∫–æ–≤)\n3. \"personal\" ‚Äî –ª–∏—á–Ω—ã–µ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è (–ø–µ—Ä–µ–≤–æ–¥—ã –æ—Ç —Ñ–∏–∑–ª–∏—Ü, –Ω–∞ –ò–ü —Å –Ω–∞–ª–æ–≥–æ–º)\n4. \"report\" ‚Äî –∑–∞–ø—Ä–æ—Å —Å–≤–æ–¥–∫–∏/–æ—Ç—á—ë—Ç–∞\n\n–ö–ê–¢–ï–ì–û–†–ò–ò –†–ê–ë–û–¢ (–¥–ª—è income):\n- –ó–∞–ø—Ä–∞–≤–∫–∞ –∫–∞—Ä—Ç—Ä–∏–¥–∂–µ–π\n- –†–µ–º–æ–Ω—Ç –ø—Ä–∏–Ω—Ç–µ—Ä–∞\n- –ó–∞–º–µ–Ω–∞ –ø–µ—á–∫–∏\n- –ó–∞–º–µ–Ω–∞ –±–∞—Ä–∞–±–∞–Ω–∞\n- –ó–∞–º–µ–Ω–∞ —Ä–æ–ª–∏–∫–∞\n- –¢–µ—Ö–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ\n- –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞\n- –ü—Ä–æ—á–µ–µ\n\n–ö–ê–¢–ï–ì–û–†–ò–ò –†–ê–°–•–û–î–û–í (–¥–ª—è expense):\n- –†–∞—Å—Ö–æ–¥–Ω–∏–∫–∏\n- –¢–æ–Ω–µ—Ä\n- –ó–∞–ø—á–∞—Å—Ç–∏\n- –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ\n- –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç\n- –ü—Ä–æ—á–µ–µ\n\n–¢–ò–ü–´ –õ–ò–ß–ù–´–• (–¥–ª—è personal):\n- –õ–∏—á–Ω—ã–µ (–ø—Ä–æ—Å—Ç–æ –ª–∏—á–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥)\n- –ù–∞ –ò–ü (—Å –Ω–∞–ª–æ–≥–æ–º) (–∫–æ–≥–¥–∞ —É–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è –Ω–∞–ª–æ–≥ –∏–ª–∏ \"–Ω–∞ –ò–ü\")\n- –û—Ç –ò–ü (–≤—ã–≤–æ–¥ —Å –ò–ü)\n\n–ü–†–ê–í–ò–õ–ê –ü–ê–†–°–ò–ù–ì–ê:\n- –°—É–º–º—ã –º–æ–≥—É—Ç –±—ã—Ç—å —Å –∫–æ–ø–µ–π–∫–∞–º–∏: \"11500 —Ä—É–±–ª–µ–π 50 –∫–æ–ø–µ–µ–∫\" = 11500.50\n- –ë—Ä–µ–Ω–¥—ã –ø—Ä–∏–Ω—Ç–µ—Ä–æ–≤: Kyocera, Canon, HP, Brother, Xerox, Samsung (\"–∫–∞—É—Å–µ—Ä–∞\" = Kyocera)\n- –ï—Å–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–±–æ—Ç –≤ –æ–¥–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ ‚Äî —Å–æ–∑–¥–∞–π –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–∞–ø–∏—Å–µ–π\n- –î–∞—Ç–∞ ‚Äî —Å–µ–≥–æ–¥–Ω—è, –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–æ –∏–Ω–æ–µ\n\n–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê (—Ç–æ–ª—å–∫–æ JSON, –±–µ–∑ markdown):\n{\n  \"type\": \"income|expense|personal|report\",\n  \"entries\": [\n    {\n      \"client\": \"–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏/–§–ò–û\",\n      \"category\": \"–ö–∞—Ç–µ–≥–æ—Ä–∏—è –∏–∑ —Å–ø–∏—Å–∫–∞\",\n      \"description\": \"–û–ø–∏—Å–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã/—Ç–æ–≤–∞—Ä–∞\",\n      \"quantity\": 1,\n      \"amount\": 11500.50,\n      \"supplier\": \"–ü–æ—Å—Ç–∞–≤—â–∏–∫ (–¥–ª—è —Ä–∞—Å—Ö–æ–¥–æ–≤)\",\n      \"personal_type\": \"–¢–∏–ø –ª–∏—á–Ω–æ–≥–æ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è\",\n      \"note\": \"–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ –µ—Å–ª–∏ –µ—Å—Ç—å\"\n    }\n  ],\n  \"report_period\": \"week|month|custom\",\n  \"confirmation_message\": \"–ö—Ä–∞—Ç–∫–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —á—Ç–æ –∑–∞–ø–∏—Å–∞–Ω–æ\"\n}","role":"system"},{"content":"={{ $json.messageText }}"}]},"jsonOutput":true,"options":{"temperature":0.1}},"id":"62d2d496-8337-4506-a3ae-900dd0d30d0e","name":"OpenAI –ü–∞—Ä—Å–∏–Ω–≥","type":"@n8n/n8n-nodes-langchain.openAi","typeVersion":1.3,"position":[-560,48],"credentials":{"openAiApi":{"id":"P0RwIIFegl7Qbpo2","name":"OpenAi account"}}},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"leftValue":"={{ $json.message.content.type }}","rightValue":"income","operator":{"type":"string","operation":"equals"},"id":"93bdd6d7-4fbb-41d8-b46d-48d5ecd220c5"}],"combinator":"and"},"renameOutput":true,"outputKey":"–î–æ—Ö–æ–¥"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"leftValue":"={{ $json.message.content.type }}","rightValue":"expense","operator":{"type":"string","operation":"equals"},"id":"3be3b712-c48c-458d-9852-ca237968fa56"}],"combinator":"and"},"renameOutput":true,"outputKey":"–†–∞—Å—Ö–æ–¥"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"leftValue":"={{ $json.message.content.type }}","rightValue":"personal","operator":{"type":"string","operation":"equals"},"id":"6b9e05ae-0719-4aea-bc26-ec9cc8d30195"}],"combinator":"and"},"renameOutput":true,"outputKey":"–õ–∏—á–Ω—ã–µ"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"leftValue":"={{ $json.message.content.type }}","rightValue":"report","operator":{"type":"string","operation":"equals"},"id":"24d0131b-b140-4f7f-a620-0e01f579d831"}],"combinator":"and"},"renameOutput":true,"outputKey":"–û—Ç—á—ë—Ç"}]},"options":{}},"id":"754d4433-cabc-427e-8ed1-59051a915938","name":"–¢–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏","type":"n8n-nodes-base.switch","typeVersion":3,"position":[-272,208]},{"parameters":{"operation":"append","documentId":{"__rl":true,"value":"1BQW-MP_nhycMP6lD2k9GBxfI2v-utD803KzqPdw8wi0","mode":"list","cachedResultName":"–ü–ª–∞—Ç–µ–∂–∏","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1BQW-MP_nhycMP6lD2k9GBxfI2v-utD803KzqPdw8wi0/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"–î–æ—Ö–æ–¥—ã","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1BQW-MP_nhycMP6lD2k9GBxfI2v-utD803KzqPdw8wi0/edit#gid=0"},"columns":{"mappingMode":"defineBelow","value":{"–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏":"={{ $json.message.content.entries[0].client }}","–î–∞—Ç–∞ –æ–ø–ª–∞—Ç—ã":"=","–°—É–º–º–∞ –ø–æ—Å–ª–µ –≤—ã—á–µ—Ç–∞ –Ω–∞–ª–æ–≥–∞":"={{ $json.message.content.entries[0].amount }}","–†–∞—Å—Ö–æ–¥—ã":"={{ $json.message.content.entries[0].description }}"},"matchingColumns":[],"schema":[{"id":"telegram_id","displayName":"telegram_id","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏","displayName":"–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"–ù–æ–º–µ—Ä —Å—á–µ—Ç–∞","displayName":"–ù–æ–º–µ—Ä —Å—á–µ—Ç–∞","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"–î–∞—Ç–∞ —Å—á–µ—Ç–∞","displayName":"–î–∞—Ç–∞ —Å—á–µ—Ç–∞","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"–î–∞—Ç–∞ –æ–ø–ª–∞—Ç—ã","displayName":"–î–∞—Ç–∞ –æ–ø–ª–∞—Ç—ã","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"–°—É–º–º–∞ –Ω–∞–ª–æ–≥–∞","displayName":"–°—É–º–º–∞ –Ω–∞–ª–æ–≥–∞","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"–°—É–º–º–∞ –ø–æ—Å–ª–µ –≤—ã—á–µ—Ç–∞ –Ω–∞–ª–æ–≥–∞","displayName":"–°—É–º–º–∞ –ø–æ—Å–ª–µ –≤—ã—á–µ—Ç–∞ –Ω–∞–ª–æ–≥–∞","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"–†–∞—Å—Ö–æ–¥—ã","displayName":"–†–∞—Å—Ö–æ–¥—ã","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"id":"50197bed-50c2-412d-9283-aabcf2435691","name":"–ó–∞–ø–∏—Å–∞—Ç—å –î–æ—Ö–æ–¥","type":"n8n-nodes-base.googleSheets","typeVersion":4.4,"position":[0,0],"credentials":{"googleSheetsOAuth2Api":{"id":"0Xb4rVj6AHGtRoeI","name":"Google Sheets account"}}},{"parameters":{"operation":"append","documentId":{"__rl":true,"mode":"url","value":"https://docs.google.com/spreadsheets/d/1BQW-MP_nhycMP6lD2k9GBxfI2v-utD803KzqPdw8wi0/edit?gid=0#gid=0","__regex":"https:\\/\\/(?:drive|docs)\\.google\\.com(?:\\/.*|)\\/d\\/([0-9a-zA-Z\\-_]+)(?:\\/.*|)"},"sheetName":{"__rl":true,"value":"–†–∞—Å—Ö–æ–¥—ã","mode":"name"},"columns":{"mappingMode":"defineBelow","value":{"–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞/—É—Å–ª—É–≥":"={{ $json.message.content.entries[0].category }}","–°—É–º–º–∞ —Ä–∞—Å—Ö–æ–¥–∞":"={{ $json.message.content.entries[0].amount }}","–æ–ø–∏—Å–∞–Ω–∏–µ":"={{ $json.message.content.entries[0].description }}","–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ":"={{ $json.message.content.entries[0].quantity }}"},"matchingColumns":[],"schema":[{"id":"–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞/—É—Å–ª—É–≥","displayName":"–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞/—É—Å–ª—É–≥","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"–°—É–º–º–∞ —Ä–∞—Å—Ö–æ–¥–∞","displayName":"–°—É–º–º–∞ —Ä–∞—Å—Ö–æ–¥–∞","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"–û–û–û –ò–ü","displayName":"–û–û–û –ò–ü","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"–°—Ç–∞—Ç—É—Ç—Å –æ–ø–ª–∞—Ç—ã","displayName":"–°—Ç–∞—Ç—É—Ç—Å –æ–ø–ª–∞—Ç—ã","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"–û—Å—Ç–∞—Ç–æ–∫ ","displayName":"–û—Å—Ç–∞—Ç–æ–∫ ","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ","displayName":"–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"–æ–ø–∏—Å–∞–Ω–∏–µ","displayName":"–æ–ø–∏—Å–∞–Ω–∏–µ","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"id":"be1db635-4d2f-4b60-a65e-3b2864ef6b9e","name":"–ó–∞–ø–∏—Å–∞—Ç—å –†–∞—Å—Ö–æ–¥","type":"n8n-nodes-base.googleSheets","typeVersion":4.4,"position":[0,160],"credentials":{"googleSheetsOAuth2Api":{"id":"0Xb4rVj6AHGtRoeI","name":"Google Sheets account"}}},{"parameters":{"operation":"append","documentId":{"__rl":true,"value":"1qrQaLkY6WvLen9AdpSIrm4DKf24jPf8ST0nkSkSV31I","mode":"list","cachedResultName":"–õ–ò–ß–ù–´–ï –î–û–•–û–î–´","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1qrQaLkY6WvLen9AdpSIrm4DKf24jPf8ST0nkSkSV31I/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"–õ–∏—Å—Ç1","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1qrQaLkY6WvLen9AdpSIrm4DKf24jPf8ST0nkSkSV31I/edit#gid=0"},"columns":{"mappingMode":"defineBelow","value":{"–æ—Ç –∫–æ–≥–æ":"={{ $json.message.content.entries[0].client }}","–∏–ø –∏–ª–∏ –∫–∞—Ä—Ç–∞":"={{ $json.message.content.entries[0].personal_type }}","—Å—É–º–º–∞":"={{ $json.message.content.entries[0].amount }}"},"matchingColumns":[],"schema":[{"id":"–æ—Ç –∫–æ–≥–æ","displayName":"–æ—Ç –∫–æ–≥–æ","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"–∏–ø –∏–ª–∏ –∫–∞—Ä—Ç–∞","displayName":"–∏–ø –∏–ª–∏ –∫–∞—Ä—Ç–∞","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"—Å—É–º–º–∞","displayName":"—Å—É–º–º–∞","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"id":"6bf61bf0-1842-45c3-8195-edbd270f48d5","name":"–ó–∞–ø–∏—Å–∞—Ç—å –õ–∏—á–Ω—ã–µ","type":"n8n-nodes-base.googleSheets","typeVersion":4.4,"position":[0,304],"credentials":{"googleSheetsOAuth2Api":{"id":"0Xb4rVj6AHGtRoeI","name":"Google Sheets account"}}},{"parameters":{"documentId":{"__rl":true,"mode":"id","value":"1BQW-MP_nhycMP6lD2k9GBxfI2v-utD803KzqPdw8wi0"},"sheetName":{"__rl":true,"value":"–î–æ—Ö–æ–¥—ã","mode":"name"},"options":{}},"id":"e6f8ee67-5a64-421c-a602-3a61a2148b9d","name":"–ß–∏—Ç–∞—Ç—å –î–æ—Ö–æ–¥—ã","type":"n8n-nodes-base.googleSheets","typeVersion":4.4,"position":[0,464],"credentials":{"googleSheetsOAuth2Api":{"id":"0Xb4rVj6AHGtRoeI","name":"Google Sheets account"}}},{"parameters":{"documentId":{"__rl":true,"value":"1BQW-MP_nhycMP6lD2k9GBxfI2v-utD803KzqPdw8wi0","mode":"list","cachedResultName":"–ü–ª–∞—Ç–µ–∂–∏","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1BQW-MP_nhycMP6lD2k9GBxfI2v-utD803KzqPdw8wi0/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":726537771,"mode":"list","cachedResultName":"–†–∞—Å—Ö–æ–¥—ã","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1BQW-MP_nhycMP6lD2k9GBxfI2v-utD803KzqPdw8wi0/edit#gid=726537771"},"options":{}},"id":"c40a558b-a396-4d55-a44d-34a668d0884d","name":"–ß–∏—Ç–∞—Ç—å –†–∞—Å—Ö–æ–¥—ã","type":"n8n-nodes-base.googleSheets","typeVersion":4.4,"position":[0,608],"credentials":{"googleSheetsOAuth2Api":{"id":"0Xb4rVj6AHGtRoeI","name":"Google Sheets account"}}},{"parameters":{"jsCode":"// –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –Ω–æ–¥\nconst incomeData = $('–ß–∏—Ç–∞—Ç—å –î–æ—Ö–æ–¥—ã').all();\nconst expenseData = $('–ß–∏—Ç–∞—Ç—å –†–∞—Å—Ö–æ–¥—ã').all();\nconst reportPeriod = $('OpenAI –ü–∞—Ä—Å–∏–Ω–≥').item.json.message.content.report_period || 'week';\n\n// –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–µ—Ä–∏–æ–¥\nconst now = new Date();\nlet startDate;\n\nif (reportPeriod === 'week') {\n  startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);\n} else if (reportPeriod === 'month') {\n  startDate = new Date(now.getFullYear(), now.getMonth(), 1);\n} else {\n  startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);\n}\n\n// –§—É–Ω–∫—Ü–∏—è –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–∞—Ç—ã dd.MM.yyyy\nfunction parseDate(dateStr) {\n  if (!dateStr) return null;\n  const parts = dateStr.split('.');\n  if (parts.length !== 3) return null;\n  return new Date(parts[2], parts[1] - 1, parts[0]);\n}\n\n// –§–∏–ª—å—Ç—Ä—É–µ–º –∏ —Å—É–º–º–∏—Ä—É–µ–º –¥–æ—Ö–æ–¥—ã\nlet totalIncome = 0;\nlet incomeByCategory = {};\n\nfor (const item of incomeData) {\n  const itemDate = parseDate(item.json['–î–∞—Ç–∞']);\n  if (itemDate && itemDate >= startDate) {\n    const amount = parseFloat(item.json['–°—É–º–º–∞']) || 0;\n    totalIncome += amount;\n    \n    const cat = item.json['–ö–∞—Ç–µ–≥–æ—Ä–∏—è'] || '–ü—Ä–æ—á–µ–µ';\n    incomeByCategory[cat] = (incomeByCategory[cat] || 0) + amount;\n  }\n}\n\n// –§–∏–ª—å—Ç—Ä—É–µ–º –∏ —Å—É–º–º–∏—Ä—É–µ–º —Ä–∞—Å—Ö–æ–¥—ã\nlet totalExpense = 0;\nlet expenseByCategory = {};\n\nfor (const item of expenseData) {\n  const itemDate = parseDate(item.json['–î–∞—Ç–∞']);\n  if (itemDate && itemDate >= startDate) {\n    const amount = parseFloat(item.json['–°—É–º–º–∞']) || 0;\n    totalExpense += amount;\n    \n    const cat = item.json['–ö–∞—Ç–µ–≥–æ—Ä–∏—è'] || '–ü—Ä–æ—á–µ–µ';\n    expenseByCategory[cat] = (expenseByCategory[cat] || 0) + amount;\n  }\n}\n\n// –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç—á—ë—Ç\nconst periodText = reportPeriod === 'week' ? '–Ω–µ–¥–µ–ª—é' : '–º–µ—Å—è—Ü';\nlet report = `üìä –°–í–û–î–ö–ê –ó–ê ${periodText.toUpperCase()}\\n`;\nreport += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\\n\\n`;\n\nreport += `üí∞ –î–û–•–û–î–´: ${totalIncome.toLocaleString('ru-RU')} ‚ÇΩ\\n`;\nfor (const [cat, sum] of Object.entries(incomeByCategory)) {\n  report += `   ‚Ä¢ ${cat}: ${sum.toLocaleString('ru-RU')} ‚ÇΩ\\n`;\n}\n\nreport += `\\nüí∏ –†–ê–°–•–û–î–´: ${totalExpense.toLocaleString('ru-RU')} ‚ÇΩ\\n`;\nfor (const [cat, sum] of Object.entries(expenseByCategory)) {\n  report += `   ‚Ä¢ ${cat}: ${sum.toLocaleString('ru-RU')} ‚ÇΩ\\n`;\n}\n\nconst profit = totalIncome - totalExpense;\nconst profitEmoji = profit >= 0 ? 'üìà' : 'üìâ';\nreport += `\\n${profitEmoji} –ü–†–ò–ë–´–õ–¨: ${profit.toLocaleString('ru-RU')} ‚ÇΩ`;\n\nreturn [{ json: { reportText: report } }];"},"id":"6d0ac7fe-bccc-4b89-9d72-5322b2ede0b1","name":"–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á—ë—Ç","type":"n8n-nodes-base.code","typeVersion":2,"position":[240,608]},{"parameters":{"chatId":"={{ $('–û–±—ä–µ–¥–∏–Ω–∏—Ç—å').item.json.chatId }}","text":"={{ $json['–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏'] }}\n{{ $json['–°—É–º–º–∞ –ø–æ—Å–ª–µ –≤—ã—á–µ—Ç–∞ –Ω–∞–ª–æ–≥–∞'] }}","additionalFields":{"appendAttribution":false}},"id":"600538b9-d819-4fea-98f5-e483ce2afc64","name":"–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –¥–æ—Ö–æ–¥","type":"n8n-nodes-base.telegram","typeVersion":1.2,"position":[224,0],"webhookId":"5a1fbbd7-d176-4dbe-ab02-205423b866b4","credentials":{"telegramApi":{"id":"SHdt9cjQ3b6ZCnAM","name":"–§–ò–ù–£–ß–ï–¢"}}},{"parameters":{"chatId":"={{ $('–û–±—ä–µ–¥–∏–Ω–∏—Ç—å').item.json.chatId }}","text":"={{ $json['–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞/—É—Å–ª—É–≥'] }}\n{{ $json['–°—É–º–º–∞ —Ä–∞—Å—Ö–æ–¥–∞'] }}\n{{ $json['–æ–ø–∏—Å–∞–Ω–∏–µ'] }}\n{{ $json['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ'] }}","additionalFields":{"appendAttribution":false}},"id":"4a69c08e-6268-4bda-ad6d-62c0250b84ab","name":"–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —Ä–∞—Å—Ö–æ–¥","type":"n8n-nodes-base.telegram","typeVersion":1.2,"position":[224,160],"webhookId":"54252482-b6aa-4166-b1f8-b6c8a9cb50eb","credentials":{"telegramApi":{"id":"SHdt9cjQ3b6ZCnAM","name":"–§–ò–ù–£–ß–ï–¢"}}},{"parameters":{"chatId":"={{ $('–û–±—ä–µ–¥–∏–Ω–∏—Ç—å').item.json.chatId }}","text":"={{ $json['–æ—Ç –∫–æ–≥–æ'] }} {{ $json['–∏–ø –∏–ª–∏ –∫–∞—Ä—Ç–∞'] }} {{ $json['—Å—É–º–º–∞'] }}","additionalFields":{"appendAttribution":false}},"id":"db7876f5-4c0e-41a5-a951-bbbedaae922e","name":"–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ª–∏—á–Ω—ã–µ","type":"n8n-nodes-base.telegram","typeVersion":1.2,"position":[224,304],"webhookId":"283377ad-efe0-48ea-bf27-868179951e69","credentials":{"telegramApi":{"id":"SHdt9cjQ3b6ZCnAM","name":"–§–ò–ù–£–ß–ï–¢"}}},{"parameters":{"chatId":"=5444227047","text":"={{ $json.reportText }}","additionalFields":{"appendAttribution":false}},"id":"edac0d5e-af09-4c1c-8ec4-e6b1e9fa479b","name":"–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—á—ë—Ç","type":"n8n-nodes-base.telegram","typeVersion":1.2,"position":[448,528],"webhookId":"f619cbc2-7d2d-4b64-9010-37454737bc34","credentials":{"telegramApi":{"id":"SHdt9cjQ3b6ZCnAM","name":"–§–ò–ù–£–ß–ï–¢"}}},{"parameters":{"assignments":{"assignments":[{"id":"file-url","name":"fileUrl","value":"=https://api.telegram.org/file/bot8385567549:AAEWWQt_VxngXRWIombON0vQcH0O4BExw4E/{{ $json.result.file_path }}","type":"string"},{"id":"file-path","name":"filePath","value":"={{ $json.result.file_path }}","type":"string"}]},"options":{}},"id":"cb15249e-24c6-44ab-8825-16205aa3f3df","name":"–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å URL","type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-1472,-80]},{"parameters":{"updates":["message"],"additionalFields":{}},"id":"42cecb95-9625-45aa-a9c1-627f80246eb9","name":"Telegram Trigger1","type":"n8n-nodes-base.telegramTrigger","typeVersion":1.1,"position":[-2000,1504],"webhookId":"ip-finance-bot","disabled":true},{"parameters":{"conditions":{"options":{"caseSensitive":false,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"voice-check","leftValue":"={{ $json.message.voice }}","rightValue":"","operator":{"type":"object","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"id":"c909a2fd-c84f-44ff-8b3b-6f382ebfe4fb","name":"–ì–æ–ª–æ—Å–æ–≤–æ–µ?1","type":"n8n-nodes-base.if","typeVersion":2,"position":[-1776,1504],"disabled":true},{"parameters":{"resource":"file","fileId":"={{ $json.message.voice.file_id }}","additionalFields":{}},"id":"729407ed-043c-4d23-9d17-9a937832fda3","name":"–ü–æ–ª—É—á–∏—Ç—å —Ñ–∞–π–ª1","type":"n8n-nodes-base.telegram","typeVersion":1.2,"position":[-1552,1408],"webhookId":"bc6deacf-8811-4e5c-b6c9-68510dcc1d87","disabled":true},{"parameters":{"url":"={{ $json.fileUrl }}","options":{"response":{"response":{"responseFormat":"file"}}}},"id":"67e0752c-a871-4e89-b96f-9ac6a09d4e6a","name":"–°–∫–∞—á–∞—Ç—å –≥–æ–ª–æ—Å–æ–≤–æ–µ2","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-1280,-64]},{"parameters":{"resource":"audio","operation":"transcribe","options":{"language":"ru","temperature":0}},"id":"e3def6e2-5d33-44aa-b312-c95694526b99","name":"Whisper –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞1","type":"@n8n/n8n-nodes-langchain.openAi","typeVersion":1.3,"position":[-1120,1408],"disabled":true},{"parameters":{"assignments":{"assignments":[{"id":"merge-text","name":"messageText","value":"={{ $json.text }}","type":"string"},{"id":"chat-id","name":"chatId","value":"={{ $('Telegram Trigger1').item.json.message.chat.id }}","type":"number"}]},"options":{}},"id":"a8e58352-393a-4e2b-acd6-ec53da0a072a","name":"–¢–µ–∫—Å—Ç –∏–∑ –≥–æ–ª–æ—Å–∞1","type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-896,1408],"disabled":true},{"parameters":{"assignments":{"assignments":[{"id":"text-msg","name":"messageText","value":"={{ $json.message.text }}","type":"string"},{"id":"chat-id-text","name":"chatId","value":"={{ $json.message.chat.id }}","type":"number"}]},"options":{}},"id":"6ac8cf84-e86c-4048-bdec-67de6edfdab5","name":"–¢–µ–∫—Å—Ç –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è1","type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-1552,1600],"disabled":true},{"parameters":{},"id":"df710621-e281-4f38-82eb-a8a3df4a22d9","name":"–û–±—ä–µ–¥–∏–Ω–∏—Ç—å1","type":"n8n-nodes-base.merge","typeVersion":3,"position":[-672,1504],"disabled":true},{"parameters":{"modelId":{"__rl":true,"mode":"list","value":""},"messages":{"values":[{"content":"–¢—ã ‚Äî —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –ò–ü –ø–æ —Ä–µ–º–æ–Ω—Ç—É –æ—Ä–≥—Ç–µ—Ö–Ω–∏–∫–∏. –ê–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –∏–∑–≤–ª–µ–∫–∞–π —Ñ–∏–Ω–∞–Ω—Å–æ–≤—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é.\n\n–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏ –∏ –∏–∑–≤–ª–µ—á—å –¥–∞–Ω–Ω—ã–µ –≤ JSON —Ñ–æ—Ä–º–∞—Ç–µ.\n\n–¢–ò–ü–´ –û–ü–ï–†–ê–¶–ò–ô:\n1. \"income\" ‚Äî –¥–æ—Ö–æ–¥ –æ—Ç —Ä–∞–±–æ—Ç—ã (–∑–∞–ø—Ä–∞–≤–∫–∞, —Ä–µ–º–æ–Ω—Ç, –∑–∞–º–µ–Ω–∞ –¥–µ—Ç–∞–ª–µ–π)\n2. \"expense\" ‚Äî —Ä–∞—Å—Ö–æ–¥ (–ø–æ–∫—É–ø–∫–∞ —Ç–æ–Ω–µ—Ä–∞, –∑–∞–ø—á–∞—Å—Ç–µ–π, —Ä–∞—Å—Ö–æ–¥–Ω–∏–∫–æ–≤)\n3. \"personal\" ‚Äî –ª–∏—á–Ω—ã–µ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è (–ø–µ—Ä–µ–≤–æ–¥—ã –æ—Ç —Ñ–∏–∑–ª–∏—Ü, –Ω–∞ –ò–ü —Å –Ω–∞–ª–æ–≥–æ–º)\n4. \"report\" ‚Äî –∑–∞–ø—Ä–æ—Å —Å–≤–æ–¥–∫–∏/–æ—Ç—á—ë—Ç–∞\n\n–ö–ê–¢–ï–ì–û–†–ò–ò –†–ê–ë–û–¢ (–¥–ª—è income):\n- –ó–∞–ø—Ä–∞–≤–∫–∞ –∫–∞—Ä—Ç—Ä–∏–¥–∂–µ–π\n- –†–µ–º–æ–Ω—Ç –ø—Ä–∏–Ω—Ç–µ—Ä–∞\n- –ó–∞–º–µ–Ω–∞ –ø–µ—á–∫–∏\n- –ó–∞–º–µ–Ω–∞ –±–∞—Ä–∞–±–∞–Ω–∞\n- –ó–∞–º–µ–Ω–∞ —Ä–æ–ª–∏–∫–∞\n- –¢–µ—Ö–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ\n- –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞\n- –ü—Ä–æ—á–µ–µ\n\n–ö–ê–¢–ï–ì–û–†–ò–ò –†–ê–°–•–û–î–û–í (–¥–ª—è expense):\n- –†–∞—Å—Ö–æ–¥–Ω–∏–∫–∏\n- –¢–æ–Ω–µ—Ä\n- –ó–∞–ø—á–∞—Å—Ç–∏\n- –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ\n- –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç\n- –ü—Ä–æ—á–µ–µ\n\n–¢–ò–ü–´ –õ–ò–ß–ù–´–• (–¥–ª—è personal):\n- –õ–∏—á–Ω—ã–µ (–ø—Ä–æ—Å—Ç–æ –ª–∏—á–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥)\n- –ù–∞ –ò–ü (—Å –Ω–∞–ª–æ–≥–æ–º) (–∫–æ–≥–¥–∞ —É–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è –Ω–∞–ª–æ–≥ –∏–ª–∏ \"–Ω–∞ –ò–ü\")\n- –û—Ç –ò–ü (–≤—ã–≤–æ–¥ —Å –ò–ü)\n\n–ü–†–ê–í–ò–õ–ê –ü–ê–†–°–ò–ù–ì–ê:\n- –°—É–º–º—ã –º–æ–≥—É—Ç –±—ã—Ç—å —Å –∫–æ–ø–µ–π–∫–∞–º–∏: \"11500 —Ä—É–±–ª–µ–π 50 –∫–æ–ø–µ–µ–∫\" = 11500.50\n- –ë—Ä–µ–Ω–¥—ã –ø—Ä–∏–Ω—Ç–µ—Ä–æ–≤: Kyocera, Canon, HP, Brother, Xerox, Samsung (\"–∫–∞—É—Å–µ—Ä–∞\" = Kyocera)\n- –ï—Å–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–±–æ—Ç –≤ –æ–¥–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ ‚Äî —Å–æ–∑–¥–∞–π –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–∞–ø–∏—Å–µ–π\n- –î–∞—Ç–∞ ‚Äî —Å–µ–≥–æ–¥–Ω—è, –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–æ –∏–Ω–æ–µ\n\n–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê (—Ç–æ–ª—å–∫–æ JSON, –±–µ–∑ markdown):\n{\n  \"type\": \"income|expense|personal|report\",\n  \"entries\": [\n    {\n      \"client\": \"–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏/–§–ò–û\",\n      \"category\": \"–ö–∞—Ç–µ–≥–æ—Ä–∏—è –∏–∑ —Å–ø–∏—Å–∫–∞\",\n      \"description\": \"–û–ø–∏—Å–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã/—Ç–æ–≤–∞—Ä–∞\",\n      \"quantity\": 1,\n      \"amount\": 11500.50,\n      \"supplier\": \"–ü–æ—Å—Ç–∞–≤—â–∏–∫ (–¥–ª—è —Ä–∞—Å—Ö–æ–¥–æ–≤)\",\n      \"personal_type\": \"–¢–∏–ø –ª–∏—á–Ω–æ–≥–æ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è\",\n      \"note\": \"–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ –µ—Å–ª–∏ –µ—Å—Ç—å\"\n    }\n  ],\n  \"report_period\": \"week|month|custom\",\n  \"confirmation_message\": \"–ö—Ä–∞—Ç–∫–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —á—Ç–æ –∑–∞–ø–∏—Å–∞–Ω–æ\"\n}","role":"system"},{"content":"={{ $json.messageText }}"}]},"jsonOutput":true,"options":{"temperature":0.1}},"id":"7988e502-12b2-4754-9015-3eaf11e670e1","name":"OpenAI –ü–∞—Ä—Å–∏–Ω–≥1","type":"@n8n/n8n-nodes-langchain.openAi","typeVersion":1.3,"position":[-464,1504],"disabled":true},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":false,"leftValue":"","typeValidation":"strict"},"conditions":[{"leftValue":"={{ $json.message.content.type }}","rightValue":"income","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"–î–æ—Ö–æ–¥"},{"conditions":{"options":{"caseSensitive":false,"leftValue":"","typeValidation":"strict"},"conditions":[{"leftValue":"={{ $json.message.content.type }}","rightValue":"expense","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"–†–∞—Å—Ö–æ–¥"},{"conditions":{"options":{"caseSensitive":false,"leftValue":"","typeValidation":"strict"},"conditions":[{"leftValue":"={{ $json.message.content.type }}","rightValue":"personal","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"–õ–∏—á–Ω—ã–µ"},{"conditions":{"options":{"caseSensitive":false,"leftValue":"","typeValidation":"strict"},"conditions":[{"leftValue":"={{ $json.message.content.type }}","rightValue":"report","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"–û—Ç—á—ë—Ç"}]},"options":{}},"id":"4326b657-963f-4060-a3a2-db569b106d5f","name":"–¢–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏1","type":"n8n-nodes-base.switch","typeVersion":3,"position":[-240,1504],"disabled":true},{"parameters":{"operation":"append","documentId":{"__rl":true,"value":"YOUR_SPREADSHEET_ID","mode":"id"},"sheetName":{"__rl":true,"value":"–î–æ—Ö–æ–¥—ã","mode":"list"},"columns":{"mappingMode":"defineBelow","value":{"–î–∞—Ç–∞":"={{ $now.format('dd.MM.yyyy') }}","–ö–ª–∏–µ–Ω—Ç":"={{ $json.message.content.entries[0].client }}","–ö–∞—Ç–µ–≥–æ—Ä–∏—è":"={{ $json.message.content.entries[0].category }}","–û–ø–∏—Å–∞–Ω–∏–µ —Ä–∞–±–æ—Ç":"={{ $json.message.content.entries[0].description }}","–ö–æ–ª-–≤–æ":"={{ $json.message.content.entries[0].quantity }}","–°—É–º–º–∞":"={{ $json.message.content.entries[0].amount }}","–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ":"={{ $json.message.content.entries[0].note || '' }}"}},"options":{}},"id":"0e1eb4bf-e014-4444-bc33-43095cee26e2","name":"–ó–∞–ø–∏—Å–∞—Ç—å –î–æ—Ö–æ–¥1","type":"n8n-nodes-base.googleSheets","typeVersion":4.4,"position":[32,1296],"credentials":{"googleSheetsOAuth2Api":{"id":"0Xb4rVj6AHGtRoeI","name":"Google Sheets account"}},"disabled":true},{"parameters":{"operation":"append","documentId":{"__rl":true,"value":"YOUR_SPREADSHEET_ID","mode":"id"},"sheetName":{"__rl":true,"value":"–†–∞—Å—Ö–æ–¥—ã","mode":"list"},"columns":{"mappingMode":"defineBelow","value":{"–î–∞—Ç–∞":"={{ $now.format('dd.MM.yyyy') }}","–ö–∞—Ç–µ–≥–æ—Ä–∏—è":"={{ $json.message.content.entries[0].category }}","–û–ø–∏—Å–∞–Ω–∏–µ":"={{ $json.message.content.entries[0].description }}","–ö–æ–ª-–≤–æ":"={{ $json.message.content.entries[0].quantity }}","–°—É–º–º–∞":"={{ $json.message.content.entries[0].amount }}","–ü–æ—Å—Ç–∞–≤—â–∏–∫":"={{ $json.message.content.entries[0].supplier || '' }}","–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ":"={{ $json.message.content.entries[0].note || '' }}"}},"options":{}},"id":"034646d1-4325-4498-a882-4769dc2e4b15","name":"–ó–∞–ø–∏—Å–∞—Ç—å –†–∞—Å—Ö–æ–¥1","type":"n8n-nodes-base.googleSheets","typeVersion":4.4,"position":[32,1456],"credentials":{"googleSheetsOAuth2Api":{"id":"0Xb4rVj6AHGtRoeI","name":"Google Sheets account"}},"disabled":true},{"parameters":{"operation":"append","documentId":{"__rl":true,"value":"YOUR_SPREADSHEET_ID","mode":"id"},"sheetName":{"__rl":true,"value":"–õ–∏—á–Ω—ã–µ","mode":"list"},"columns":{"mappingMode":"defineBelow","value":{"–î–∞—Ç–∞":"={{ $now.format('dd.MM.yyyy') }}","–ò—Å—Ç–æ—á–Ω–∏–∫":"={{ $json.message.content.entries[0].client }}","–¢–∏–ø":"={{ $json.message.content.entries[0].personal_type }}","–°—É–º–º–∞":"={{ $json.message.content.entries[0].amount }}","–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ":"={{ $json.message.content.entries[0].note || '' }}"}},"options":{}},"id":"f843f30a-267e-4ebe-9bc2-d34c6fb39e06","name":"–ó–∞–ø–∏—Å–∞—Ç—å –õ–∏—á–Ω—ã–µ1","type":"n8n-nodes-base.googleSheets","typeVersion":4.4,"position":[32,1600],"credentials":{"googleSheetsOAuth2Api":{"id":"0Xb4rVj6AHGtRoeI","name":"Google Sheets account"}},"disabled":true},{"parameters":{"documentId":{"__rl":true,"value":"YOUR_SPREADSHEET_ID","mode":"id"},"sheetName":{"__rl":true,"value":"–î–æ—Ö–æ–¥—ã","mode":"list"},"options":{}},"id":"8c797e42-b489-4482-8fcf-a3dbc05213a5","name":"–ß–∏—Ç–∞—Ç—å –î–æ—Ö–æ–¥—ã1","type":"n8n-nodes-base.googleSheets","typeVersion":4.4,"position":[32,1760],"credentials":{"googleSheetsOAuth2Api":{"id":"0Xb4rVj6AHGtRoeI","name":"Google Sheets account"}},"disabled":true},{"parameters":{"documentId":{"__rl":true,"value":"YOUR_SPREADSHEET_ID","mode":"id"},"sheetName":{"__rl":true,"value":"–†–∞—Å—Ö–æ–¥—ã","mode":"list"},"options":{}},"id":"c14964eb-2b01-4976-8168-442f574b73c2","name":"–ß–∏—Ç–∞—Ç—å –†–∞—Å—Ö–æ–¥—ã1","type":"n8n-nodes-base.googleSheets","typeVersion":4.4,"position":[32,1904],"credentials":{"googleSheetsOAuth2Api":{"id":"0Xb4rVj6AHGtRoeI","name":"Google Sheets account"}},"disabled":true},{"parameters":{"jsCode":"// –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –Ω–æ–¥\nconst incomeData = $('–ß–∏—Ç–∞—Ç—å –î–æ—Ö–æ–¥—ã1').all();\nconst expenseData = $('–ß–∏—Ç–∞—Ç—å –†–∞—Å—Ö–æ–¥—ã1').all();\nconst reportPeriod = $('OpenAI –ü–∞—Ä—Å–∏–Ω–≥1').item.json.message.content.report_period || 'week';\n\n// –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–µ—Ä–∏–æ–¥\nconst now = new Date();\nlet startDate;\n\nif (reportPeriod === 'week') {\n  startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);\n} else if (reportPeriod === 'month') {\n  startDate = new Date(now.getFullYear(), now.getMonth(), 1);\n} else {\n  startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);\n}\n\n// –§—É–Ω–∫—Ü–∏—è –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–∞—Ç—ã dd.MM.yyyy\nfunction parseDate(dateStr) {\n  if (!dateStr) return null;\n  const parts = dateStr.split('.');\n  if (parts.length !== 3) return null;\n  return new Date(parts[2], parts[1] - 1, parts[0]);\n}\n\n// –§–∏–ª—å—Ç—Ä—É–µ–º –∏ —Å—É–º–º–∏—Ä—É–µ–º –¥–æ—Ö–æ–¥—ã\nlet totalIncome = 0;\nlet incomeByCategory = {};\n\nfor (const item of incomeData) {\n  const itemDate = parseDate(item.json['–î–∞—Ç–∞']);\n  if (itemDate && itemDate >= startDate) {\n    const amount = parseFloat(item.json['–°—É–º–º–∞']) || 0;\n    totalIncome += amount;\n    \n    const cat = item.json['–ö–∞—Ç–µ–≥–æ—Ä–∏—è'] || '–ü—Ä–æ—á–µ–µ';\n    incomeByCategory[cat] = (incomeByCategory[cat] || 0) + amount;\n  }\n}\n\n// –§–∏–ª—å—Ç—Ä—É–µ–º –∏ —Å—É–º–º–∏—Ä—É–µ–º —Ä–∞—Å—Ö–æ–¥—ã\nlet totalExpense = 0;\nlet expenseByCategory = {};\n\nfor (const item of expenseData) {\n  const itemDate = parseDate(item.json['–î–∞—Ç–∞']);\n  if (itemDate && itemDate >= startDate) {\n    const amount = parseFloat(item.json['–°—É–º–º–∞']) || 0;\n    totalExpense += amount;\n    \n    const cat = item.json['–ö–∞—Ç–µ–≥–æ—Ä–∏—è'] || '–ü—Ä–æ—á–µ–µ';\n    expenseByCategory[cat] = (expenseByCategory[cat] || 0) + amount;\n  }\n}\n\n// –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç—á—ë—Ç\nconst periodText = reportPeriod === 'week' ? '–Ω–µ–¥–µ–ª—é' : '–º–µ—Å—è—Ü';\nlet report = `üìä –°–í–û–î–ö–ê –ó–ê ${periodText.toUpperCase()}\\n`;\nreport += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\\n\\n`;\n\nreport += `üí∞ –î–û–•–û–î–´: ${totalIncome.toLocaleString('ru-RU')} ‚ÇΩ\\n`;\nfor (const [cat, sum] of Object.entries(incomeByCategory)) {\n  report += `   ‚Ä¢ ${cat}: ${sum.toLocaleString('ru-RU')} ‚ÇΩ\\n`;\n}\n\nreport += `\\nüí∏ –†–ê–°–•–û–î–´: ${totalExpense.toLocaleString('ru-RU')} ‚ÇΩ\\n`;\nfor (const [cat, sum] of Object.entries(expenseByCategory)) {\n  report += `   ‚Ä¢ ${cat}: ${sum.toLocaleString('ru-RU')} ‚ÇΩ\\n`;\n}\n\nconst profit = totalIncome - totalExpense;\nconst profitEmoji = profit >= 0 ? 'üìà' : 'üìâ';\nreport += `\\n${profitEmoji} –ü–†–ò–ë–´–õ–¨: ${profit.toLocaleString('ru-RU')} ‚ÇΩ`;\n\nreturn [{ json: { reportText: report } }];"},"id":"0d62ec4c-2805-48ac-81ba-6fb19e427a1d","name":"–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á—ë—Ç1","type":"n8n-nodes-base.code","typeVersion":2,"position":[256,1824],"disabled":true},{"parameters":{"chatId":"={{ $('–û–±—ä–µ–¥–∏–Ω–∏—Ç—å1').item.json.chatId }}","text":"={{ $json.message.content.confirmation_message }}","additionalFields":{}},"id":"42d4862d-4792-41fc-842a-21bea0285437","name":"–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –¥–æ—Ö–æ–¥1","type":"n8n-nodes-base.telegram","typeVersion":1.2,"position":[256,1296],"webhookId":"b0b408ad-69b3-42b3-a081-5cdba608d528","disabled":true},{"parameters":{"chatId":"={{ $('–û–±—ä–µ–¥–∏–Ω–∏—Ç—å1').item.json.chatId }}","text":"={{ $json.message.content.confirmation_message }}","additionalFields":{}},"id":"ce378c99-880f-49d0-b272-b78342667360","name":"–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —Ä–∞—Å—Ö–æ–¥1","type":"n8n-nodes-base.telegram","typeVersion":1.2,"position":[256,1456],"webhookId":"bf84fc4b-a5ed-42a5-8d1b-f8668dad3257","disabled":true},{"parameters":{"chatId":"={{ $('–û–±—ä–µ–¥–∏–Ω–∏—Ç—å1').item.json.chatId }}","text":"={{ $json.message.content.confirmation_message }}","additionalFields":{}},"id":"59eaf9e3-e29d-4c65-a60c-8c52957b0d54","name":"–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ª–∏—á–Ω—ã–µ1","type":"n8n-nodes-base.telegram","typeVersion":1.2,"position":[256,1600],"webhookId":"bd77530a-b435-4c0f-8f4b-cb42ee2639d9","disabled":true},{"parameters":{"chatId":"={{ $('–û–±—ä–µ–¥–∏–Ω–∏—Ç—å1').item.json.chatId }}","text":"={{ $json.reportText }}","additionalFields":{}},"id":"c5c2aeca-50e0-4346-872d-cc697808c6ad","name":"–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—á—ë—Ç1","type":"n8n-nodes-base.telegram","typeVersion":1.2,"position":[480,1824],"webhookId":"052eb1db-31a4-45ba-9852-345557eaeb6a","disabled":true}],"connections":{"Telegram Trigger":{"main":[[{"node":"–ì–æ–ª–æ—Å–æ–≤–æ–µ?","type":"main","index":0}]]},"–ì–æ–ª–æ—Å–æ–≤–æ–µ?":{"main":[[{"node":"–ü–æ–ª—É—á–∏—Ç—å —Ñ–∞–π–ª","type":"main","index":0}],[{"node":"–¢–µ–∫—Å—Ç –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è","type":"main","index":0}]]},"–ü–æ–ª—É—á–∏—Ç—å —Ñ–∞–π–ª":{"main":[[{"node":"–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å URL","type":"main","index":0}]]},"–°–∫–∞—á–∞—Ç—å –≥–æ–ª–æ—Å–æ–≤–æ–µ":{"main":[[]]},"Whisper –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞":{"main":[[{"node":"–¢–µ–∫—Å—Ç –∏–∑ –≥–æ–ª–æ—Å–∞","type":"main","index":0}]]},"–¢–µ–∫—Å—Ç –∏–∑ –≥–æ–ª–æ—Å–∞":{"main":[[{"node":"–û–±—ä–µ–¥–∏–Ω–∏—Ç—å","type":"main","index":0}]]},"–¢–µ–∫—Å—Ç –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è":{"main":[[{"node":"–û–±—ä–µ–¥–∏–Ω–∏—Ç—å","type":"main","index":1}]]},"–û–±—ä–µ–¥–∏–Ω–∏—Ç—å":{"main":[[{"node":"OpenAI –ü–∞—Ä—Å–∏–Ω–≥","type":"main","index":0}]]},"OpenAI –ü–∞—Ä—Å–∏–Ω–≥":{"main":[[{"node":"–¢–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏","type":"main","index":0}]]},"–¢–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏":{"main":[[{"node":"–ó–∞–ø–∏—Å–∞—Ç—å –î–æ—Ö–æ–¥","type":"main","index":0}],[{"node":"–ó–∞–ø–∏—Å–∞—Ç—å –†–∞—Å—Ö–æ–¥","type":"main","index":0}],[{"node":"–ó–∞–ø–∏—Å–∞—Ç—å –õ–∏—á–Ω—ã–µ","type":"main","index":0}],[{"node":"–ß–∏—Ç–∞—Ç—å –î–æ—Ö–æ–¥—ã","type":"main","index":0}]]},"–ó–∞–ø–∏—Å–∞—Ç—å –î–æ—Ö–æ–¥":{"main":[[{"node":"–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –¥–æ—Ö–æ–¥","type":"main","index":0}]]},"–ó–∞–ø–∏—Å–∞—Ç—å –†–∞—Å—Ö–æ–¥":{"main":[[{"node":"–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —Ä–∞—Å—Ö–æ–¥","type":"main","index":0}]]},"–ó–∞–ø–∏—Å–∞—Ç—å –õ–∏—á–Ω—ã–µ":{"main":[[{"node":"–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ª–∏—á–Ω—ã–µ","type":"main","index":0}]]},"–ß–∏—Ç–∞—Ç—å –î–æ—Ö–æ–¥—ã":{"main":[[{"node":"–ß–∏—Ç–∞—Ç—å –†–∞—Å—Ö–æ–¥—ã","type":"main","index":0}]]},"–ß–∏—Ç–∞—Ç—å –†–∞—Å—Ö–æ–¥—ã":{"main":[[{"node":"–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á—ë—Ç","type":"main","index":0}]]},"–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á—ë—Ç":{"main":[[{"node":"–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—á—ë—Ç","type":"main","index":0}]]},"–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å URL":{"main":[[{"node":"–°–∫–∞—á–∞—Ç—å –≥–æ–ª–æ—Å–æ–≤–æ–µ2","type":"main","index":0}]]},"Telegram Trigger1":{"main":[[{"node":"–ì–æ–ª–æ—Å–æ–≤–æ–µ?1","type":"main","index":0}]]},"–ì–æ–ª–æ—Å–æ–≤–æ–µ?1":{"main":[[{"node":"–ü–æ–ª—É—á–∏—Ç—å —Ñ–∞–π–ª1","type":"main","index":0}],[{"node":"–¢–µ–∫—Å—Ç –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è1","type":"main","index":0}]]},"–ü–æ–ª—É—á–∏—Ç—å —Ñ–∞–π–ª1":{"main":[[]]},"–°–∫–∞—á–∞—Ç—å –≥–æ–ª–æ—Å–æ–≤–æ–µ2":{"main":[[{"node":"Whisper –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞","type":"main","index":0}]]},"Whisper –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞1":{"main":[[{"node":"–¢–µ–∫—Å—Ç –∏–∑ –≥–æ–ª–æ—Å–∞1","type":"main","index":0}]]},"–¢–µ–∫—Å—Ç –∏–∑ –≥–æ–ª–æ—Å–∞1":{"main":[[{"node":"–û–±—ä–µ–¥–∏–Ω–∏—Ç—å1","type":"main","index":0}]]},"–¢–µ–∫—Å—Ç –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è1":{"main":[[{"node":"–û–±—ä–µ–¥–∏–Ω–∏—Ç—å1","type":"main","index":1}]]},"–û–±—ä–µ–¥–∏–Ω–∏—Ç—å1":{"main":[[{"node":"OpenAI –ü–∞—Ä—Å–∏–Ω–≥1","type":"main","index":0}]]},"OpenAI –ü–∞—Ä—Å–∏–Ω–≥1":{"main":[[{"node":"–¢–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏1","type":"main","index":0}]]},"–¢–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏1":{"main":[[{"node":"–ó–∞–ø–∏—Å–∞—Ç—å –î–æ—Ö–æ–¥1","type":"main","index":0}],[{"node":"–ó–∞–ø–∏—Å–∞—Ç—å –†–∞—Å—Ö–æ–¥1","type":"main","index":0}],[{"node":"–ó–∞–ø–∏—Å–∞—Ç—å –õ–∏—á–Ω—ã–µ1","type":"main","index":0}],[{"node":"–ß–∏—Ç–∞—Ç—å –î–æ—Ö–æ–¥—ã1","type":"main","index":0}]]},"–ó–∞–ø–∏—Å–∞—Ç—å –î–æ—Ö–æ–¥1":{"main":[[{"node":"–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –¥–æ—Ö–æ–¥1","type":"main","index":0}]]},"–ó–∞–ø–∏—Å–∞—Ç—å –†–∞—Å—Ö–æ–¥1":{"main":[[{"node":"–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —Ä–∞—Å—Ö–æ–¥1","type":"main","index":0}]]},"–ó–∞–ø–∏—Å–∞—Ç—å –õ–∏—á–Ω—ã–µ1":{"main":[[{"node":"–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ª–∏—á–Ω—ã–µ1","type":"main","index":0}]]},"–ß–∏—Ç–∞—Ç—å –î–æ—Ö–æ–¥—ã1":{"main":[[{"node":"–ß–∏—Ç–∞—Ç—å –†–∞—Å—Ö–æ–¥—ã1","type":"main","index":0}]]},"–ß–∏—Ç–∞—Ç—å –†–∞—Å—Ö–æ–¥—ã1":{"main":[[{"node":"–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á—ë—Ç1","type":"main","index":0}]]},"–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á—ë—Ç1":{"main":[[{"node":"–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—á—ë—Ç1","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","availableInMCP":false},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"82300e5d-2b61-45c0-8f4f-8b9b5318d5a4","activeVersionId":null,"triggerCount":0,"shared":[{"updatedAt":"2026-01-29T07:22:11.673Z","createdAt":"2026-01-29T07:22:11.673Z","role":"workflow:owner","workflowId":"QiwOAvX8w3ZiA5Q3DYX2j","projectId":"UnFAqkOZkFc92cC9"}],"activeVersion":null,"tags":[{"updatedAt":"2026-01-29T07:16:43.622Z","createdAt":"2026-01-29T07:16:43.622Z","id":"IS831kOx1kCeya6m","name":"–§–∏–Ω–∞–Ω—Å—ã"},{"updatedAt":"2026-01-29T07:16:43.635Z","createdAt":"2026-01-29T07:16:43.635Z","id":"H0f0H9LsVCgAZqpT","name":"Telegram"}]},{"updatedAt":"2026-01-25T19:12:49.823Z","createdAt":"2026-01-20T04:33:15.852Z","id":"O-yyzDi1vxxansBv-6imS","name":"test","active":false,"isArchived":true,"nodes":[],"connections":{},"settings":{"executionOrder":"v1","availableInMCP":false},"staticData":null,"meta":null,"pinData":{},"versionId":"92d44002-808d-4ba5-a08d-55314dc9b839","activeVersionId":null,"triggerCount":0,"shared":[{"updatedAt":"2026-01-20T04:33:15.852Z","createdAt":"2026-01-20T04:33:15.852Z","role":"workflow:owner","workflowId":"O-yyzDi1vxxansBv-6imS","projectId":"UnFAqkOZkFc92cC9"}],"activeVersion":null,"tags":[]},{"updatedAt":"2026-01-25T12:21:25.663Z","createdAt":"2026-01-21T17:24:09.183Z","id":"KSs-PkKtf-jQFH3rso9dW","name":"–¥–æ–∫—É–º–µ–Ω—Ç—ã","active":false,"isArchived":false,"nodes":[{"parameters":{"updates":["message","*"],"additionalFields":{}},"id":"f019045f-39c2-478f-93ba-71b0f04edb4a","name":"Telegram Trigger","type":"n8n-nodes-base.telegramTrigger","typeVersion":1,"position":[-2992,-128],"webhookId":"141d870a-8094-4740-8fea-20c4a89d5f6d","credentials":{"telegramApi":{"id":"QzsDSnmPNiBaWAAZ","name":"–¥–æ–∫—É–º–µ–Ω—Ç—ã"}}},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"leftValue":"={{ $('Telegram Trigger').item.json.message.text }}","rightValue":"","operator":{"type":"string","operation":"exists","singleValue":true},"id":"fc0dac5a-8ec5-4fc7-ba17-a0a0fb9788f1"}],"combinator":"and"},"renameOutput":true,"outputKey":"text"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"c9834ead-e41f-477b-9a39-a4cab641bd6a","leftValue":"={{ $('Telegram Trigger').item.json.message.voice.file_id }}","rightValue":"","operator":{"type":"string","operation":"exists","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"voice"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.4,"position":[-1712,400],"id":"c258a89e-dce9-4a13-9bf2-fbb4696618ee","name":"Switch"},{"parameters":{"resource":"file","fileId":"={{ $json.message.voice.file_id }}","additionalFields":{}},"type":"n8n-nodes-base.telegram","typeVersion":1.2,"position":[-1520,496],"id":"3f231f83-d543-49be-a1c5-8db7dedff125","name":"Get a file","webhookId":"066ee598-37bb-4525-8919-f6653312682a","credentials":{"telegramApi":{"id":"QzsDSnmPNiBaWAAZ","name":"–¥–æ–∫—É–º–µ–Ω—Ç—ã"}}},{"parameters":{"resource":"audio","operation":"transcribe","options":{}},"type":"@n8n/n8n-nodes-langchain.openAi","typeVersion":2.1,"position":[-1360,496],"id":"f10b5749-551c-4ade-9210-c8fb95adca9e","name":"Transcribe a recording","credentials":{"openAiApi":{"id":"P0RwIIFegl7Qbpo2","name":"OpenAi account"}}},{"parameters":{"assignments":{"assignments":[{"id":"a529721b-637f-430a-b9b2-c2c4df73b07e","name":"text","value":"={{ $json.text }}{{ $json.message.text }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-1232,384],"id":"9c16de18-aabc-4584-9a32-861392fa6b1e","name":"Edit Fields"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"leftValue":"={{ $json.message.text }}","rightValue":"/start","operator":{"type":"string","operation":"equals"},"id":"fc0dac5a-8ec5-4fc7-ba17-a0a0fb9788f1"}],"combinator":"and"},"renameOutput":true,"outputKey":"text"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"d7ae6ecf-611e-4d30-bf4b-f812c3f58e25","leftValue":"={{ $json.callback_query.message.reply_markup.inline_keyboard[0][0].callback_data }}","rightValue":"new_case","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"text"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"30c11e4a-f6f5-411e-a443-0734828d14c8","leftValue":"","rightValue":"","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"}},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"94b201d3-a01b-498e-a3ec-3bc4cffea1b7","leftValue":"={{ $json.callback_query.message.reply_markup.inline_keyboard[0][0].callback_data }}","rightValue":"gotovo","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"}},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"badc7575-ca6e-427f-b733-f8d51259f9e1","leftValue":"={{ $json.callback_query.data }}","rightValue":"generate_doc","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"generate_doc"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"4e713a41-eb2b-48b9-b630-0582cc58884c","leftValue":"={{ $json.callback_query.data }}","rightValue":"cancel","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"cancel"},{"conditions":{"options":{"caseSensitive":false,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"b7d53d60-d618-4cbd-97d9-6d99bc6e1a43","leftValue":"={{ $json.message.text }}","rightValue":"–∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è","operator":{"type":"string","operation":"contains"}}],"combinator":"and"},"renameOutput":true,"outputKey":"consultation"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"70963af2-2fd1-4471-9f64-fa2cfa38396d","leftValue":"={{ $json.callback_query.data }}","rightValue":"confirm_booking","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"confirm_booking"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"761ab10c-37d6-472d-a848-88310399d52e","leftValue":"={{ $json.callback_query.data }}","rightValue":"cancel_booking","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"cancel_booking"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.4,"position":[-2064,352],"id":"fbcea7b2-fb09-4d0b-9546-5fcbb58e5b84","name":"Switch1"},{"parameters":{"chatId":"={{ $json.message.chat.id }}","text":"–ü—Ä–∏–≤–µ—Ç. ","replyMarkup":"inlineKeyboard","inlineKeyboard":{"rows":[{"row":{"buttons":[{"text":"–ù–æ–≤—ã–π –¥–æ–∫—É–º–µ–Ω—Ç","additionalFields":{"callback_data":"new_case"}}]}}]},"additionalFields":{"appendAttribution":false}},"type":"n8n-nodes-base.telegram","typeVersion":1.2,"position":[-1744,96],"id":"1e548111-4088-47a6-9ad3-28a75876dc2e","name":"Send a text message","webhookId":"a018acdd-9d99-4bbe-b393-e98458cd113b","credentials":{"telegramApi":{"id":"QzsDSnmPNiBaWAAZ","name":"–¥–æ–∫—É–º–µ–Ω—Ç—ã"}}},{"parameters":{"chatId":"={{ $('Telegram Trigger').item.json.callback_query.message.chat.id }}","text":"–û—Ç–ø—Ä–∞–≤—å –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤—å –º–Ω–µ —Ç–µ–∫—Å—Ç.","additionalFields":{"appendAttribution":false}},"type":"n8n-nodes-base.telegram","typeVersion":1.2,"position":[-1312,176],"id":"36f91843-012b-49f0-9325-9f539498ce88","name":"Send a text message1","webhookId":"a018acdd-9d99-4bbe-b393-e98458cd113b","credentials":{"telegramApi":{"id":"QzsDSnmPNiBaWAAZ","name":"–¥–æ–∫—É–º–µ–Ω—Ç—ã"}}},{"parameters":{"operation":"deleteMessage","chatId":"={{ $json.callback_query.message.chat.id }}","messageId":"={{ $json.callback_query.message.message_id }}"},"type":"n8n-nodes-base.telegram","typeVersion":1.2,"position":[-1488,176],"id":"9792c48a-36f4-436f-9b7c-5fc7c637db58","name":"Delete a chat message","webhookId":"4b5a6d5a-7ee4-4bfa-ad9c-3d1125f8173d","credentials":{"telegramApi":{"id":"QzsDSnmPNiBaWAAZ","name":"–¥–æ–∫—É–º–µ–Ω—Ç—ã"}}},{"parameters":{"jsCode":"// –í —ç—Ç–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –≤—Å–µ–≥–¥–∞ –∏—Ç–æ–≥–æ–≤—ã–π —Ç–µ–∫—Å—Ç (–≥–æ–ª–æ—Å->—Ç–µ–∫—Å—Ç –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ —Ç–µ–∫—Å—Ç)\nvar text = $json.text;\n\n// –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è\nvar normalized = text\n  .toLowerCase()\n  .replace(/\\s+/g, \" \")\n  .trim();\n\n// –ï—Å—Ç—å —Å–ª–æ–≤–æ \"–≥–æ—Ç–æ–≤–æ\" –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω–æ–µ —Å–ª–æ–≤–æ\nvar hasReady = /\\b–≥–æ—Ç–æ–≤–æ\\b/i.test(normalized);\n\n// –ù–æ –µ—Å–ª–∏ —Å–∫–∞–∑–∞–Ω–æ \"–Ω–µ –≥–æ—Ç–æ–≤–æ\" ‚Äî —ç—Ç–æ –ù–ï –∫–æ–º–∞–Ω–¥–∞\nvar hasNotReady = /\\b–Ω–µ\\s+–≥–æ—Ç–æ–≤–æ\\b/i.test(normalized);\n\nvar isReady = hasReady && !hasNotReady;\n\n// –í–ê–ñ–ù–û: –≤ Run Once for Each Item –≤–æ–∑–≤—Ä–∞—â–∞–µ–º [{ json: {...} }]\nreturn [{\n  json: {\n    text: text.trim(),\n    text_normalized: normalized,\n    is_ready_word: isReady\n  }\n}];\n"},"id":"a7243089-ec9f-4e6a-9653-3e5fee3bb83b","name":"Normalize Message1","type":"n8n-nodes-base.code","typeVersion":2,"position":[-960,576]},{"parameters":{"assignments":{"assignments":[{"id":"4a826648-7bd7-4c57-a0a5-99022763c407","name":"text","value":"={{ $json.text }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-1072,384],"id":"7e936680-8ec0-404a-abf3-14a7dc5cf93a","name":"Edit Fields1"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"leftValue":"={{ $json.is_ready_word }}","rightValue":false,"operator":{"type":"boolean","operation":"equals"},"id":"1ba3e399-b744-4d24-a62d-e107e6965a3f"}],"combinator":"and"}},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"5a3b65f8-ecf2-45e5-8626-730abd1376ad","leftValue":"","rightValue":"","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"}}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.4,"position":[-704,576],"id":"27c460d0-deac-4b6a-b944-5f04a158f336","name":"Switch2"},{"parameters":{"modelId":{"__rl":true,"value":"gpt-4.1-nano","mode":"list","cachedResultName":"GPT-4.1-NANO"},"responses":{"values":[{"role":"system","content":"–¢—ã —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç.\n–û–ø—Ä–µ–¥–µ–ª–∏, –∫–∞–∫–æ–π –¥–æ–∫—É–º–µ–Ω—Ç –Ω—É–∂–µ–Ω: –ø—Ä–µ—Ç–µ–Ω–∑–∏—è / –∏—Å–∫ / –∂–∞–ª–æ–±–∞ / –∑–∞—è–≤–ª–µ–Ω–∏–µ.\n–°–æ—Å—Ç–∞–≤—å —Å–ø–∏—Å–æ–∫ —É—Ç–æ—á–Ω—è—é—â–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤, –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç.\n–û—Ç–≤–µ—á–∞–π —Å—Ç—Ä–æ–≥–æ JSON. –ù–∏–∫–∞–∫–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –≤–Ω–µ JSON.\n"},{"content":"={{ $json.text_normalized }}\n\n–í–µ—Ä–Ω–∏ —Å—Ç—Ä–æ–≥–æ JSON:\n{\n  \"doc_type\":\"–ø—Ä–µ—Ç–µ–Ω–∑–∏—è|–∏—Å–∫|–∂–∞–ª–æ–±–∞|–∑–∞—è–≤–ª–µ–Ω–∏–µ|unknown\",\n  \"is_enough\": true,\n  \"missing_questions\":[]\n}\n\n–ü—Ä–∞–≤–∏–ª–∞:\n- missing_questions –º–∞–∫—Å–∏–º—É–º 7\n- –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ: is_enough=true –∏ missing_questions=[]\n- –µ—Å–ª–∏ —Ç–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞ –Ω–µ—è—Å–µ–Ω: doc_type=\"unknown\" –∏ –ø–µ—Ä–≤—ã–º –≤–æ–ø—Ä–æ—Å–æ–º —É—Ç–æ—á–Ω–∏ —Ç–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞"}]},"builtInTools":{},"options":{}},"type":"@n8n/n8n-nodes-langchain.openAi","typeVersion":2.1,"position":[-528,736],"id":"31332999-1c0f-4e3e-8895-a3df05764b15","name":"Message a model","credentials":{"openAiApi":{"id":"P0RwIIFegl7Qbpo2","name":"OpenAi account"}}},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// –¢–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞ –º–æ–¥–µ–ª–∏ (—Å—Ç—Ä–æ–∫–∞ —Å JSON)\nvar rawText = \"\";\n\n// –í OpenAI node —Ç–µ–∫—Å—Ç –æ–±—ã—á–Ω–æ –ª–µ–∂–∏—Ç —Ç—É—Ç:\nif ($json.content && Array.isArray($json.content)) {\n  rawText = $json.content[0].text;\n} else if ($json.text) {\n  rawText = $json.text;\n}\n\n// –ü–∞—Ä—Å–∏–º JSON\nvar parsed;\ntry {\n  parsed = JSON.parse(rawText);\n} catch (e) {\n  throw new Error(\"–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON –æ—Ç –º–æ–¥–µ–ª–∏: \" + rawText);\n}\n\n// –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π item\nreturn {\n  json: {\n    ...parsed\n  }\n};\n"},"id":"b67ab62a-fffd-4c85-a1cb-94cc341dcecc","name":"Prepare Final Generation1","type":"n8n-nodes-base.code","typeVersion":2,"position":[-144,736]},{"parameters":{"assignments":{"assignments":[{"id":"4a826648-7bd7-4c57-a0a5-99022763c407","name":"text","value":"={{ $json.output[0].content[0].text }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-272,736],"id":"da67ee11-f4ba-4d2c-b58d-01921a5a5b65","name":"Edit Fields2"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"leftValue":"={{ $json.is_enough }}","rightValue":false,"operator":{"type":"boolean","operation":"equals"},"id":"1ba3e399-b744-4d24-a62d-e107e6965a3f"}],"combinator":"and"}},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"5a3b65f8-ecf2-45e5-8626-730abd1376ad","leftValue":"","rightValue":"","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"}}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.4,"position":[0,736],"id":"bff32961-f7ae-4ebf-82ca-bb10a2d5481e","name":"Switch3"},{"parameters":{"chatId":"={{ $('Telegram Trigger').item.json.message.chat.id }}","text":"=–ß—Ç–æ–±—ã –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ, —É—Ç–æ—á–Ω–∏, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞:\n\n{{ ($json.missing_questions || []).map((q, i) => (i+1) + \") \" + q).join(\"\\n\") }}\n\n–ï—Å–ª–∏ –Ω–µ—Ç —É—Ç–æ—á–Ω–µ–Ω–∏–π ‚Äî –Ω–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É ¬´–ì–æ—Ç–æ–≤–æ¬ª.\n","replyMarkup":"inlineKeyboard","inlineKeyboard":{"rows":[{"row":{"buttons":[{"text":"–ì–æ—Ç–æ–≤–æ","additionalFields":{"callback_data":"gotovo"}}]}}]},"additionalFields":{"appendAttribution":false}},"type":"n8n-nodes-base.telegram","typeVersion":1.2,"position":[144,576],"id":"7887eab8-dc2e-4ea0-9f70-1e66b00a5d83","name":"Send a text message2","webhookId":"8055116f-4d18-4406-802f-6c65fe662cdc","credentials":{"telegramApi":{"id":"QzsDSnmPNiBaWAAZ","name":"–¥–æ–∫—É–º–µ–Ω—Ç—ã"}}},{"parameters":{"mode":"runOnceForEachItem","jsCode":"const chatId =\n  $json.message?.chat?.id ??\n  $json.callback_query?.message?.chat?.id;\n\nif (chatId === undefined || chatId === null) {\n  throw new Error(\"chat_id –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å –≤—Ö–æ–¥ Telegram Trigger (message/callback_query).\");\n}\n\nconst chatIdNum = parseInt(String(chatId), 10);\nif (!Number.isFinite(chatIdNum)) {\n  throw new Error(\"chat_id –Ω–µ —á–∏—Å–ª–æ: \" + String(chatId));\n}\n\nreturn {\n  json: {\n    ...$json,\n    chat_id: chatIdNum\n  }\n};\n"},"id":"b12d4f44-c137-40f0-b70e-a097ab031e8a","name":"Resolve chat_id","type":"n8n-nodes-base.code","typeVersion":2,"position":[-2864,-128]},{"parameters":{"operation":"executeQuery","query":"SELECT case_id\nFROM active_cases\nWHERE chat_id = {{$json.chat_id}}\nLIMIT 1;","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-2496,-128],"id":"eb8e26dd-190b-4939-bc88-7edb588fd7c6","name":"Execute a SQL query","alwaysOutputData":true,"credentials":{"postgres":{"id":"bNYxHjx2dgnO3BKs","name":"Postgres account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"e5454cc0-4ac8-4bed-864c-86619978ff85","leftValue":"={{ $json.case_id }}","rightValue":0,"operator":{"type":"string","operation":"notEmpty","singleValue":true}}],"combinator":"or"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.3,"position":[-2336,-128],"id":"659043d4-b64f-4693-a818-7120bc7c566b","name":"If"},{"parameters":{"operation":"executeQuery","query":"WITH new_case AS (\n  INSERT INTO cases (chat_id, status, doc_type)\n  VALUES ($1, 'draft', 'unknown')\n  RETURNING id\n)\nINSERT INTO active_cases (chat_id, case_id, updated_at)\nSELECT $1, id, now()\nFROM new_case\nON CONFLICT (chat_id)\nDO UPDATE SET case_id = EXCLUDED.case_id, updated_at = EXCLUDED.updated_at\nRETURNING case_id;\n","options":{"queryReplacement":"={{ $('Code in JavaScript').item.json.chat_id }}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-2736,144],"id":"3094b6a5-4305-48f6-afe8-b57fd046abf9","name":"Execute a SQL query1","alwaysOutputData":true,"credentials":{"postgres":{"id":"bNYxHjx2dgnO3BKs","name":"Postgres account"}}},{"parameters":{"mode":"runOnceForEachItem","jsCode":"return { json: { chat_id: $json.chat_id } };\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-2688,-128],"id":"06a5504c-eee6-4826-92db-fc225297eab6","name":"Code in JavaScript","alwaysOutputData":true},{"parameters":{"jsCode":"const u = $json;\n\nconst chatId =\n  u.message?.chat?.id ??\n  u.callback_query?.message?.chat?.id ??\n  u.edited_message?.chat?.id ??\n  u.channel_post?.chat?.id ??\n  u.edited_channel_post?.chat?.id;\n\nif (!chatId) throw new Error(\"chat_id –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ callback –≤–µ—Ç–∫–µ\");\n\nreturn {\n  json: {\n    ...u,\n    chat_id: parseInt(String(chatId), 10),\n    text: \"–ì–æ—Ç–æ–≤–æ\",\n    is_ready: true\n  }\n};\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-1920,576],"id":"61464c0a-5aeb-4b8a-926a-0a5a664d11fc","name":"Code in JavaScript1"},{"parameters":{"operation":"executeQuery","query":"SELECT text FROM case_messages WHERE case_id = (SELECT case_id FROM active_cases WHERE chat_id = $1) ORDER BY created_at ASC","options":{"queryReplacement":"={{ $json.chat_id }}"}},"id":"f778e5a9-e8c9-46a0-ae07-9be460ce656e","name":"Get Messages for Summary","type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-1600,800],"credentials":{"postgres":{"id":"bNYxHjx2dgnO3BKs","name":"Postgres account"}}},{"parameters":{"jsCode":"const msgs = $input.all(); let s = \"üìã –í—ã —Ä–∞—Å—Å–∫–∞–∑–∞–ª–∏:\\n\\n\"; msgs.forEach((m,i) => { s += `${i+1}. ${m.json.text}\\n\\n`; }); s += \"–ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç?\"; return {json: {summary: s, chat_id: $(\"Code in JavaScript1\").item.json.chat_id}};"},"id":"509f6f46-8f75-4610-aac9-5300a4750df7","name":"Format Summary","type":"n8n-nodes-base.code","typeVersion":2,"position":[-1440,800]},{"parameters":{"chatId":"={{ $json.chat_id }}","text":"={{ $json.summary }}","replyMarkup":"inlineKeyboard","inlineKeyboard":{"rows":[{}]},"additionalFields":{"appendAttribution":false}},"id":"576bd149-6a2d-4b6b-8755-5eb6bb4e41c9","name":"Send Summary","type":"n8n-nodes-base.telegram","typeVersion":1.2,"position":[-1280,800],"webhookId":"33994f72-e7c5-487b-bfc0-b86cc9c6cc94","credentials":{"telegramApi":{"id":"QzsDSnmPNiBaWAAZ","name":"–¥–æ–∫—É–º–µ–Ω—Ç—ã"}}},{"parameters":{"operation":"executeQuery","query":"SELECT c.id as case_id, c.doc_type FROM cases c JOIN active_cases ac ON c.id = ac.case_id WHERE ac.chat_id = $1","options":{"queryReplacement":"={{ $json.callback_query.message.chat.id }}"}},"id":"48549f37-1c44-42ee-ac81-af5cd2d82099","name":"Get Case for Generation","type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-1120,960],"credentials":{"postgres":{"id":"bNYxHjx2dgnO3BKs","name":"Postgres account"}}},{"parameters":{"operation":"executeQuery","query":"SELECT text FROM case_messages WHERE case_id = '{{ $json.case_id }}' ORDER BY created_at ASC","options":{}},"id":"6c2f53f9-57f9-4bae-b091-de93fff6b0c6","name":"Get All Messages for Doc","type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-960,960],"credentials":{"postgres":{"id":"bNYxHjx2dgnO3BKs","name":"Postgres account"}}},{"parameters":{"jsCode":"const msgs = $input.all(); const info = $(\"Get Case for Generation\").item.json; return {json: {text: msgs.map(m => m.json.text).join(\"\\n\\n\"), doc_type: info.doc_type || \"–¥–æ–∫—É–º–µ–Ω—Ç\", case_id: info.case_id, chat_id: $(\"Get Case for Generation\").first().json.chat_id || $input.first().json.chat_id}};"},"id":"f7275e04-7e49-4f52-9d02-f68367749e4a","name":"Combine Messages","type":"n8n-nodes-base.code","typeVersion":2,"position":[-800,960]},{"parameters":{"modelId":{"__rl":true,"value":"gpt-4.1-mini","mode":"list"},"responses":{"values":[{"role":"system","content":"–¢—ã –æ–ø—ã—Ç–Ω—ã–π —é—Ä–∏—Å—Ç –†–§. –°–æ—Å—Ç–∞–≤—å —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –¥–æ–∫—É–º–µ–Ω—Ç. –°—Ç–∏–ª—å –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π. –°—Ç—Ä—É–∫—Ç—É—Ä–∞: –ö–æ–º—É/–û—Ç –∫–æ–≥–æ, –Ω–∞–∑–≤–∞–Ω–∏–µ, –æ–±—Å—Ç–æ—è—Ç–µ–ª—å—Å—Ç–≤–∞, —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è, –¥–∞—Ç–∞/–ø–æ–¥–ø–∏—Å—å. –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç - –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã [–£–¢–û–ß–ù–ò–¢–¨: ...]. –¢–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞, –±–µ–∑ JSON."},{"content":"=–¢–∏–ø: {{ $json.doc_type }}\\n\\n–î–∞–Ω–Ω—ã–µ:\\n{{ $json.text }}\\n\\n–°–æ—Å—Ç–∞–≤—å –¥–æ–∫—É–º–µ–Ω—Ç."}]},"builtInTools":{},"options":{}},"id":"2dfebca3-79d7-484f-bdd8-b597ea462ce1","name":"Generate Final Document","type":"@n8n/n8n-nodes-langchain.openAi","typeVersion":2.1,"position":[-640,960],"credentials":{"openAiApi":{"id":"P0RwIIFegl7Qbpo2","name":"OpenAi account"}}},{"parameters":{"jsCode":"let text = \"\"; if ($json.output && Array.isArray($json.output) && $json.output[0]?.content) { text = $json.output[0].content[0].text; } else if ($json.text) { text = $json.text; } const info = $(\"Combine Messages\").item.json; return {json: {doc_text: text, case_id: info.case_id, chat_id: info.chat_id, doc_type: info.doc_type, filename: `–î–æ–∫—É–º–µ–Ω—Ç_${info.doc_type}_${new Date().toISOString().split(\"T\")[0]}`}};"},"id":"1055fa82-df9f-4f06-b533-8067caaff59a","name":"Extract Document Text","type":"n8n-nodes-base.code","typeVersion":2,"position":[-480,960]},{"parameters":{"chatId":"={{ $json.chat_id }}","text":"=‚úÖ –î–æ–∫—É–º–µ–Ω—Ç –≥–æ—Ç–æ–≤!\\n\\n{{ $json.doc_text.length > 500 ? $json.doc_text.substring(0, 500) + '...' : $json.doc_text }}\\n\\n–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:","replyMarkup":"inlineKeyboard","inlineKeyboard":{"rows":[{},{}]},"additionalFields":{"appendAttribution":false}},"id":"16baf2d7-9f43-478d-9479-f9646b0d17c8","name":"Send Document","type":"n8n-nodes-base.telegram","typeVersion":1.2,"position":[-320,960],"webhookId":"384adce3-e5f4-4270-b79e-503a6bc63e76","credentials":{"telegramApi":{"id":"QzsDSnmPNiBaWAAZ","name":"–¥–æ–∫—É–º–µ–Ω—Ç—ã"}}},{"parameters":{"operation":"executeQuery","query":"UPDATE cases SET generated_document_text = $1, generated_at = NOW(), generation_status = 'completed' WHERE id = $2::uuid","options":{"queryReplacement":"=[ {{ $json.doc_text }}, {{ $json.case_id }} ]"}},"id":"ec6babd9-a422-4e6b-8a4b-7bedacf58135","name":"Save to DB","type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-160,960],"credentials":{"postgres":{"id":"bNYxHjx2dgnO3BKs","name":"Postgres account"}}},{"parameters":{"operation":"executeQuery","query":"DELETE FROM active_cases WHERE chat_id = $1","options":{"queryReplacement":"={{ $json.callback_query.message.chat.id }}"}},"id":"91d82f43-2396-46aa-90a2-55d32c76a460","name":"Delete Case on Cancel","type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-1120,1120],"credentials":{"postgres":{"id":"bNYxHjx2dgnO3BKs","name":"Postgres account"}}},{"parameters":{"chatId":"={{ $json.callback_query.message.chat.id }}","text":"‚ùå –û–ø–µ—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞.","replyMarkup":"inlineKeyboard","inlineKeyboard":{"rows":[{}]},"additionalFields":{"appendAttribution":false}},"id":"4e4ed034-6db1-47ea-af7c-d41857d817af","name":"Send Cancel Message","type":"n8n-nodes-base.telegram","typeVersion":1.2,"position":[-960,1120],"webhookId":"f8e9b25b-0e10-4eab-8a4e-f0a157382ee1","credentials":{"telegramApi":{"id":"QzsDSnmPNiBaWAAZ","name":"–¥–æ–∫—É–º–µ–Ω—Ç—ã"}}},{"parameters":{"jsCode":"\nconst msg = $json.message?.text || '';\nconst isConsultation = /–∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è/i.test(msg);\nconst chatId = $json.message?.chat?.id;\n\nreturn {\n    json: {\n        is_consultation: isConsultation,\n        chat_id: chatId,\n        original_text: msg\n    }\n};\n"},"id":"a9feacdb-4970-4e1a-a27c-27d291ac2983","name":"Check Consultation","type":"n8n-nodes-base.code","typeVersion":2,"position":[-2208,1408]},{"parameters":{"chatId":"={{ $json.chat_id }}","text":"üìã *–ö–û–ù–°–£–õ–¨–¢–ê–¶–ò–Ø*\n\nüí∞ *–°—Ç–æ–∏–º–æ—Å—Ç—å:* 5 000 —Ä—É–±–ª–µ–π\n‚è± *–§–æ—Ä–º–∞—Ç:* 1 —á–∞—Å\n\n–î–ª—è –∑–∞–ø–∏—Å–∏ –æ—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã:\n\n1Ô∏è‚É£ *–¢–µ–º–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏* ‚Äî –∫—Ä–∞—Ç–∫–æ –æ–ø–∏—à–∏—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å\n2Ô∏è‚É£ *–ñ–µ–ª–∞–µ–º–∞—è –¥–∞—Ç–∞* ‚Äî –Ω–∞–ø—Ä–∏–º–µ—Ä: 25 —è–Ω–≤–∞—Ä—è, –∑–∞–≤—Ç—Ä–∞\n3Ô∏è‚É£ *–ñ–µ–ª–∞–µ–º–æ–µ –≤—Ä–µ–º—è* ‚Äî –Ω–∞–ø—Ä–∏–º–µ—Ä: 14:00\n4Ô∏è‚É£ *–ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å* ‚Äî —ç—Ç–æ –≤—Ä–µ–º—è –ø–æ –ú–°–ö –∏–ª–∏ –ø–æ –≤–∞—à–µ–º—É —á–∞—Å–æ–≤–æ–º—É –ø–æ—è—Å—É?\n\n–ù–∞–ø–∏—à–∏—Ç–µ –≤—Å–µ –æ—Ç–≤–µ—Ç—ã –æ–¥–Ω–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º.","additionalFields":{"appendAttribution":false,"parse_mode":"Markdown"}},"id":"b8c875fd-639a-4895-9e9d-17a9e9f81f1f","name":"Send Consultation Info","type":"n8n-nodes-base.telegram","typeVersion":1.2,"position":[-2000,1408],"webhookId":"d5833f5d-097f-447f-9a5e-b78efeec4403","credentials":{"telegramApi":{"id":"QzsDSnmPNiBaWAAZ","name":"–¥–æ–∫—É–º–µ–Ω—Ç—ã"}}},{"parameters":{"operation":"executeQuery","query":"\nINSERT INTO active_cases (chat_id, case_id, updated_at)\nVALUES ($1, 'consultation_' || $1::text, NOW())\nON CONFLICT (chat_id) DO UPDATE SET case_id = 'consultation_' || $1::text, updated_at = NOW()\n","options":{"queryReplacement":"={{ $json.chat_id }}"}},"id":"36518112-54af-4dbb-a420-7fd62d93427e","name":"Set Consultation State","type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-1808,1408],"credentials":{"postgres":{"id":"bNYxHjx2dgnO3BKs","name":"Postgres account"}}},{"parameters":{"modelId":{"__rl":true,"value":"gpt-4.1-mini","mode":"list"},"responses":{"values":[{"role":"system","content":"–ò–∑–≤–ª–µ–∫–∏ –∏–∑ —Ç–µ–∫—Å—Ç–∞:\n1. –¢–µ–º—É –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏\n2. –î–∞—Ç—É (–ø—Ä–µ–æ–±—Ä–∞–∑—É–π –≤ YYYY-MM-DD)\n3. –í—Ä–µ–º—è (–≤ —Ñ–æ—Ä–º–∞—Ç–µ HH:MM)\n4. –ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å\n\n–ü—Ä–∞–≤–∏–ª–∞ –ø–æ —á–∞—Å–æ–≤–æ–º—É –ø–æ—è—Å—É:\n- \"–ø–æ –ú–°–ö\", \"–º–æ—Å–∫–æ–≤—Å–∫–æ–µ\" ‚Üí timezone = \"MSK\", offset = 0\n- \"+1 –∫ –ú–°–ö\", \"–ú–°–ö+1\" ‚Üí timezone = \"MSK+1\", offset = 1\n- \"+2 –∫ –ú–°–ö\" ‚Üí timezone = \"MSK+2\", offset = 2\n- –ï—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω ‚Üí timezone = null (–Ω—É–∂–Ω–æ —É—Ç–æ—á–Ω–∏—Ç—å)\n\n–í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û JSON:\n{\n  \"topic\": \"—Ç–µ–º–∞\",\n  \"date\": \"YYYY-MM-DD\",\n  \"time\": \"HH:MM\",\n  \"timezone\": \"MSK\" –∏–ª–∏ null,\n  \"offset_hours\": 0,\n  \"needs_clarification\": true/false,\n  \"clarification_question\": \"–≤–æ–ø—Ä–æ—Å –∏–ª–∏ null\"\n}"},{"content":"={{ $json.text }}"}]},"builtInTools":{},"options":{}},"id":"651f87b9-85e1-41ee-bbe2-39397a17375d","name":"Parse Consultation Data","type":"@n8n/n8n-nodes-langchain.openAi","typeVersion":2.1,"position":[-1600,1600],"credentials":{"openAiApi":{"id":"P0RwIIFegl7Qbpo2","name":"OpenAi account"}}},{"parameters":{"jsCode":"\nlet parsed;\ntry {\n    let text = $json.output?.[0]?.content?.[0]?.text || $json.text || '{}';\n    text = text.replace(/```json\\n?/g, '').replace(/```\\n?/g, '').trim();\n    parsed = JSON.parse(text);\n} catch(e) {\n    parsed = {\n        needs_clarification: true,\n        clarification_question: \"–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –¥–∞–Ω–Ω—ã–µ. –£–∫–∞–∂–∏—Ç–µ —Ç–µ–º—É, –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏.\"\n    };\n}\n\nconst chatId = $('Normalize Message1').item.json.chat_id ||\n               $('Telegram Trigger').item.json.message?.chat?.id;\n\n// –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤—Ä–µ–º—è –≤ –ú–°–ö –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω offset\nlet timeMsk = parsed.time;\nif (parsed.offset_hours && parsed.time) {\n    const [h, m] = parsed.time.split(':').map(Number);\n    const mskH = h - parsed.offset_hours;\n    timeMsk = String(mskH).padStart(2, '0') + ':' + String(m).padStart(2, '0');\n}\n\nreturn {\n    json: {\n        ...parsed,\n        time_msk: timeMsk,\n        chat_id: chatId\n    }\n};\n"},"id":"624bcfa4-0ad6-4b55-b799-e068b0cf7a4e","name":"Extract Consultation","type":"n8n-nodes-base.code","typeVersion":2,"position":[-1408,1600]},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"74ddd858-9e8d-415f-b5e1-38f8e736a64e","leftValue":"={{ $json.needs_clarification }}","rightValue":true,"operator":{"type":"boolean","operation":"true"}}],"combinator":"and"},"renameOutput":true,"outputKey":"need_clarify"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"3466fa01-9f5b-4c4a-9c49-6a7073330ee5","leftValue":"={{ $json.needs_clarification }}","rightValue":false,"operator":{"type":"boolean","operation":"false"}}],"combinator":"and"},"renameOutput":true,"outputKey":"data_ok"}]},"options":{"fallbackOutput":"extra"}},"id":"ae7b12ce-938e-4199-853b-c75d4722a860","name":"Switch Clarify","type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[-1200,1600]},{"parameters":{"chatId":"={{ $json.chat_id }}","text":"={{ $json.clarification_question }}","additionalFields":{"appendAttribution":false}},"id":"2801f662-c818-4e7c-aeeb-844a195e83b1","name":"Send Clarification","type":"n8n-nodes-base.telegram","typeVersion":1.2,"position":[-1008,1504],"webhookId":"5d178498-1dd9-4221-95ad-d7b63b6ffebb","credentials":{"telegramApi":{"id":"QzsDSnmPNiBaWAAZ","name":"–¥–æ–∫—É–º–µ–Ω—Ç—ã"}}},{"parameters":{"chatId":"={{ $json.chat_id }}","text":"‚úÖ *–î–∞–Ω–Ω—ã–µ –ø—Ä–∏–Ω—è—Ç—ã!*\n\nüìå *–¢–µ–º–∞:* {{ $json.topic }}\nüìÖ *–î–∞—Ç–∞:* {{ $json.date }}\nüïê *–í—Ä–µ–º—è:* {{ $json.time }}{{ $json.timezone ? ' (' + $json.timezone + ')' : '' }}\n\n‚è≥ –ü—Ä–æ–≤–µ—Ä—è—é –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å...","additionalFields":{"appendAttribution":false,"parse_mode":"Markdown"}},"id":"946a9202-ea91-4858-a2d8-c0a32c6e671e","name":"Confirm Data","type":"n8n-nodes-base.telegram","typeVersion":1.2,"position":[-1008,1712],"webhookId":"2083b083-30ea-44da-bc80-b1db40f34669","credentials":{"telegramApi":{"id":"QzsDSnmPNiBaWAAZ","name":"–¥–æ–∫—É–º–µ–Ω—Ç—ã"}}},{"parameters":{"operation":"getAll","calendar":{"__rl":true,"value":"primary","mode":"list"},"limit":10,"options":{"timeMin":"={{ $json.date }}T00:00:00Z","timeMax":"={{ $json.date }}T23:59:59Z"}},"id":"b7301fca-ddb5-4f29-a3e2-e5b60e0081ae","name":"Check Calendar","type":"n8n-nodes-base.googleCalendar","typeVersion":1.2,"position":[-800,1712],"credentials":{"googleCalendarOAuth2Api":{"id":"GOOGLE_CALENDAR_CREDS_ID","name":"Google Calendar"}}},{"parameters":{"jsCode":"\nconst events = $input.all();\nconst requestedTime = $('Extract Consultation').item.json.time_msk;\nconst requestedDate = $('Extract Consultation').item.json.date;\nconst chatId = $('Extract Consultation').item.json.chat_id;\nconst consultData = $('Extract Consultation').item.json;\n\n// –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ —Å–æ–±—ã—Ç–∏—è–º–∏\nlet isBusy = false;\nconst [reqH, reqM] = requestedTime.split(':').map(Number);\nconst reqStart = reqH * 60 + reqM;\nconst reqEnd = reqStart + 60; // 1 —á–∞—Å\n\nfor (const ev of events) {\n    if (!ev.json.start?.dateTime) continue;\n    const evStart = new Date(ev.json.start.dateTime);\n    const evEnd = new Date(ev.json.end.dateTime);\n    const evStartMin = evStart.getHours() * 60 + evStart.getMinutes();\n    const evEndMin = evEnd.getHours() * 60 + evEnd.getMinutes();\n\n    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è\n    if (reqStart < evEndMin && reqEnd > evStartMin) {\n        isBusy = true;\n        break;\n    }\n}\n\nreturn {\n    json: {\n        calendar_check: isBusy ? 'busy' : 'free',\n        chat_id: chatId,\n        ...consultData\n    }\n};\n"},"id":"32d7ddae-543a-48cf-a4ed-9669e4b3a340","name":"Analyze Calendar","type":"n8n-nodes-base.code","typeVersion":2,"position":[-608,1712]},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"6802e881-d2ee-437e-b440-d074c3ebd784","leftValue":"={{ $json.calendar_check }}","rightValue":"free","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"free"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"33a8c407-e4ca-4300-8faa-4da9a7d0361c","leftValue":"={{ $json.calendar_check }}","rightValue":"busy","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"busy"}]},"options":{"fallbackOutput":"extra"}},"id":"1b2ab777-2f19-4b19-953d-469d195b7bc5","name":"Switch Calendar","type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[-400,1712]},{"parameters":{"chatId":"={{ $json.chat_id }}","text":"‚úÖ *–í—Ä–µ–º—è —Å–≤–æ–±–æ–¥–Ω–æ!*\n\nüìå {{ $json.topic }}\nüóì {{ $json.date }} –≤ {{ $json.time }}\nüí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å: 5 000 —Ä—É–±–ª–µ–π\n\n–ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é?","replyMarkup":"inlineKeyboard","inlineKeyboard":{"rows":[{}]},"additionalFields":{"appendAttribution":false,"parse_mode":"Markdown"}},"id":"a9dceb0c-e7df-43a8-9a55-b607a47741f7","name":"Send Time Free","type":"n8n-nodes-base.telegram","typeVersion":1.2,"position":[-208,1600],"webhookId":"47da468c-5268-46ec-ac06-1ec643075d9a","credentials":{"telegramApi":{"id":"QzsDSnmPNiBaWAAZ","name":"–¥–æ–∫—É–º–µ–Ω—Ç—ã"}}},{"parameters":{"chatId":"={{ $json.chat_id }}","text":"‚ö†Ô∏è –ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è –∑–∞–Ω—è—Ç–æ.\n\n–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥—É—é –¥–∞—Ç—É –∏–ª–∏ –≤—Ä–µ–º—è –∏ –Ω–∞–ø–∏—à–∏—Ç–µ –æ–¥–Ω–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º.","additionalFields":{"appendAttribution":false}},"id":"1d5b91fd-abfd-456c-8b1d-a973b38ce575","name":"Send Time Busy","type":"n8n-nodes-base.telegram","typeVersion":1.2,"position":[-208,1808],"webhookId":"221d4f4d-e05c-488d-beff-3dd08994d6f6","credentials":{"telegramApi":{"id":"QzsDSnmPNiBaWAAZ","name":"–¥–æ–∫—É–º–µ–Ω—Ç—ã"}}},{"parameters":{"calendar":{"__rl":true,"value":"primary","mode":"list"},"start":"={{ $json.date }}T{{ $json.time_msk }}:00","end":"={{ $json.date }}T{{ (parseInt($json.time_msk.split(':')[0]) + 1).toString().padStart(2, '0') }}:{{ $json.time_msk.split(':')[1] }}:00","additionalFields":{"description":"=–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è —Å –∫–ª–∏–µ–Ω—Ç–æ–º\\n–¢–µ–º–∞: {{ $json.topic }}\\nChat ID: {{ $json.chat_id }}","summary":"=–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è: {{ $json.topic }}"}},"id":"31e1247b-4937-48c3-83bb-3d400cbc28dd","name":"Create Calendar Event","type":"n8n-nodes-base.googleCalendar","typeVersion":1.2,"position":[0,1600],"credentials":{"googleCalendarOAuth2Api":{"id":"GOOGLE_CALENDAR_CREDS_ID","name":"Google Calendar"}}},{"parameters":{"chatId":"={{ $json.chat_id }}","text":"‚úÖ *–ó–∞–ø–∏—Å—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞!*\n\n–í–∞—à–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∞.\n\nüì© –î–∞–ª—å–Ω–µ–π—à–∏–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –±—É–¥—É—Ç –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω—ã –æ—Ç–¥–µ–ª—å–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º.\n\n–°–ø–∞—Å–∏–±–æ –∑–∞ –æ–±—Ä–∞—â–µ–Ω–∏–µ!","additionalFields":{"appendAttribution":false,"parse_mode":"Markdown"}},"id":"eaa15858-acc2-4e53-b01c-d2b563ce8547","name":"Send Booking Confirmed","type":"n8n-nodes-base.telegram","typeVersion":1.2,"position":[208,1600],"webhookId":"5a9fd972-f6da-485d-9de4-d99124db2160","credentials":{"telegramApi":{"id":"QzsDSnmPNiBaWAAZ","name":"–¥–æ–∫—É–º–µ–Ω—Ç—ã"}}},{"parameters":{"chatId":"={{ $json.callback_query.message.chat.id }}","text":"‚ùå –ó–∞–ø–∏—Å—å –æ—Ç–º–µ–Ω–µ–Ω–∞.\n\n–ï—Å–ª–∏ –ø–µ—Ä–µ–¥—É–º–∞–µ—Ç–µ ‚Äî –Ω–∞–ø–∏—à–∏—Ç–µ ¬´–∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è¬ª –µ—â—ë —Ä–∞–∑.","additionalFields":{"appendAttribution":false}},"id":"11566377-a677-4b7e-88b7-59df0dd5e990","name":"Send Booking Cancelled","type":"n8n-nodes-base.telegram","typeVersion":1.2,"position":[208,1808],"webhookId":"e427f7c8-ac16-4a45-b24a-89edc143b452","credentials":{"telegramApi":{"id":"QzsDSnmPNiBaWAAZ","name":"–¥–æ–∫—É–º–µ–Ω—Ç—ã"}}},{"parameters":{"operation":"executeQuery","query":"\nSELECT case_id, chat_id FROM active_cases WHERE chat_id = $1 AND case_id LIKE 'consultation_%'\n","options":{"queryReplacement":"={{ $json.callback_query.message.chat.id }}"}},"id":"ca6e0b88-4703-4120-b242-28755a12f5ea","name":"Get Consultation Data","type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-208,2000],"credentials":{"postgres":{"id":"bNYxHjx2dgnO3BKs","name":"Postgres account"}}},{"parameters":{"jsCode":"\n// –ü–æ–ª—É—á–∞–µ–º case_id –∏–∑ –±–∞–∑—ã\nconst caseId = $('Execute a SQL query').item.json.case_id || '';\nconst isConsultationFlow = caseId.toString().startsWith('consultation_');\nconst text = $json.text || $json.text_normalized || '';\n\nreturn {\n    json: {\n        ...$json,\n        is_consultation_flow: isConsultationFlow,\n        case_id: caseId\n    }\n};\n"},"id":"e479ac21-4e85-4a3a-9442-3995eb6be40f","name":"Check Flow Type","type":"n8n-nodes-base.code","typeVersion":2,"position":[-736,1312]},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"2f6bde74-0db9-459a-bb10-af8ec97d621b","leftValue":"={{ $json.is_consultation_flow }}","rightValue":true,"operator":{"type":"boolean","operation":"true"}}],"combinator":"and"},"renameOutput":true,"outputKey":"consultation_flow"}]},"options":{"fallbackOutput":"extra"}},"id":"d4d7472d-90f2-4bca-ab62-9146f8dbcea8","name":"Switch Flow Type","type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[-576,1312]},{"parameters":{"operation":"executeQuery","query":"INSERT INTO case_messages (case_id, role, text)\nSELECT ac.case_id, 'user', {{ $json.text }}\nFROM active_cases ac\nWHERE ac.chat_id = {{ $('Code in JavaScript').item.json.chat_id }}","options":{}},"id":"37d05f43-8de4-496b-82a1-6eb39e1f2a14","name":"Save Message","type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-528,576],"credentials":{"postgres":{"id":"bNYxHjx2dgnO3BKs","name":"Postgres account"}}}],"connections":{"Telegram Trigger":{"main":[[{"node":"Resolve chat_id","type":"main","index":0}]]},"Switch":{"main":[[{"node":"Edit Fields","type":"main","index":0}],[{"node":"Get a file","type":"main","index":0}]]},"Get a file":{"main":[[{"node":"Transcribe a recording","type":"main","index":0}]]},"Switch1":{"main":[[{"node":"Send a text message","type":"main","index":0}],[{"node":"Delete a chat message","type":"main","index":0}],[{"node":"Switch","type":"main","index":0}],[{"node":"Code in JavaScript1","type":"main","index":0}],[{"node":"Get Case for Generation","type":"main","index":0}],[{"node":"Delete Case on Cancel","type":"main","index":0}],[{"node":"Check Consultation","type":"main","index":0}],[{"node":"Get Consultation Data","type":"main","index":0}],[{"node":"Send Booking Cancelled","type":"main","index":0}],[]]},"Send a text message1":{"main":[[]]},"Delete a chat message":{"main":[[{"node":"Send a text message1","type":"main","index":0}]]},"Transcribe a recording":{"main":[[{"node":"Edit Fields","type":"main","index":0}]]},"Edit Fields":{"main":[[{"node":"Edit Fields1","type":"main","index":0}]]},"Edit Fields1":{"main":[[{"node":"Normalize Message1","type":"main","index":0}]]},"Normalize Message1":{"main":[[{"node":"Switch2","type":"main","index":0}]]},"Switch2":{"main":[[{"node":"Save Message","type":"main","index":0}],[]]},"Message a model":{"main":[[{"node":"Edit Fields2","type":"main","index":0}]]},"Edit Fields2":{"main":[[{"node":"Prepare Final Generation1","type":"main","index":0}]]},"Prepare Final Generation1":{"main":[[{"node":"Switch3","type":"main","index":0}]]},"Switch3":{"main":[[{"node":"Send a text message2","type":"main","index":0}]]},"Resolve chat_id":{"main":[[{"node":"Code in JavaScript","type":"main","index":0}]]},"Execute a SQL query":{"main":[[{"node":"If","type":"main","index":0}]]},"If":{"main":[[{"node":"Switch1","type":"main","index":0}],[{"node":"Execute a SQL query1","type":"main","index":0}]]},"Code in JavaScript":{"main":[[{"node":"Execute a SQL query","type":"main","index":0}]]},"Execute a SQL query1":{"main":[[{"node":"Switch1","type":"main","index":0}]]},"Code in JavaScript1":{"main":[[{"node":"Get Messages for Summary","type":"main","index":0}]]},"Get Messages for Summary":{"main":[[{"node":"Format Summary","type":"main","index":0}]]},"Format Summary":{"main":[[{"node":"Send Summary","type":"main","index":0}]]},"Get Case for Generation":{"main":[[{"node":"Get All Messages for Doc","type":"main","index":0}]]},"Get All Messages for Doc":{"main":[[{"node":"Combine Messages","type":"main","index":0}]]},"Combine Messages":{"main":[[{"node":"Generate Final Document","type":"main","index":0}]]},"Generate Final Document":{"main":[[{"node":"Extract Document Text","type":"main","index":0}]]},"Extract Document Text":{"main":[[{"node":"Send Document","type":"main","index":0}]]},"Send Document":{"main":[[{"node":"Save to DB","type":"main","index":0}]]},"Delete Case on Cancel":{"main":[[{"node":"Send Cancel Message","type":"main","index":0}]]},"Check Consultation":{"main":[[{"node":"Send Consultation Info","type":"main","index":0}]]},"Send Consultation Info":{"main":[[{"node":"Set Consultation State","type":"main","index":0}]]},"Parse Consultation Data":{"main":[[{"node":"Extract Consultation","type":"main","index":0}]]},"Extract Consultation":{"main":[[{"node":"Switch Clarify","type":"main","index":0}]]},"Switch Clarify":{"main":[[{"node":"Send Clarification","type":"main","index":0}],[{"node":"Confirm Data","type":"main","index":0}],[]]},"Confirm Data":{"main":[[{"node":"Check Calendar","type":"main","index":0}]]},"Check Calendar":{"main":[[{"node":"Analyze Calendar","type":"main","index":0}]]},"Analyze Calendar":{"main":[[{"node":"Switch Calendar","type":"main","index":0}]]},"Switch Calendar":{"main":[[{"node":"Send Time Free","type":"main","index":0}],[{"node":"Send Time Busy","type":"main","index":0}],[]]},"Get Consultation Data":{"main":[[{"node":"Create Calendar Event","type":"main","index":0}]]},"Create Calendar Event":{"main":[[{"node":"Send Booking Confirmed","type":"main","index":0}]]},"Check Flow Type":{"main":[[{"node":"Switch Flow Type","type":"main","index":0}]]},"Switch Flow Type":{"main":[[{"node":"Parse Consultation Data","type":"main","index":0}],[{"node":"Message a model","type":"main","index":0}]]},"Save Message":{"main":[[{"node":"Message a model","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","availableInMCP":false,"callerPolicy":"workflowsFromSameOwner"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"f3912e95-85e5-4fb4-a6e6-807e7853f25a","activeVersionId":null,"triggerCount":1,"shared":[{"updatedAt":"2026-01-21T17:24:09.183Z","createdAt":"2026-01-21T17:24:09.183Z","role":"workflow:owner","workflowId":"KSs-PkKtf-jQFH3rso9dW","projectId":"UnFAqkOZkFc92cC9"}],"activeVersion":null,"tags":[]},{"updatedAt":"2026-02-02T07:51:25.974Z","createdAt":"2026-01-19T17:42:27.160Z","id":"EJsyXaXI_Pc7ayntR6cml","name":"Telegram Channel Manager","active":true,"isArchived":false,"nodes":[{"parameters":{"updates":["chat_member","message_reaction","message"],"additionalFields":{}},"id":"0f446c1b-672d-4445-8e5f-71d8015f9f64","name":"Telegram Trigger","type":"n8n-nodes-base.telegramTrigger","typeVersion":1,"position":[-1056,224],"webhookId":"your-webhook-id","credentials":{"telegramApi":{"id":"mrDBEGr5w2Hma1j4","name":"xxx"}}},{"parameters":{"dataType":"string","value1":"={{ $json.chat_member.new_chat_member.status }}","rules":{"rules":[{"value2":"member"},{"value2":"left","output":1},{"value2":"kicked","output":1}]}},"id":"1982fe65-8851-47c5-b6da-7ce4c82a3855","name":"Check Status","type":"n8n-nodes-base.switch","typeVersion":1,"position":[-624,-32]},{"parameters":{"chatId":"={{ $('Telegram Trigger').item.json.chat_member.chat.id }}","text":"=@{{ $('Telegram Trigger').item.json.chat_member.new_chat_member.user.username }} –ü—Ä–∏–≤–µ—Ç, –Ω–∞–¥–µ—é—Å—å –Ω–∞–π–¥–µ—à—å –∑–¥–µ—Å—å –æ—Ç–≤–µ—Ç –Ω–∞ —Å–≤–æ–π –≤–æ–ø—Ä–æ—Å. ","additionalFields":{"parse_mode":"HTML"}},"id":"a065ae04-30c2-4482-b0dc-aac0ed64bf6e","name":"Send Welcome","type":"n8n-nodes-base.telegram","typeVersion":1,"position":[-112,-160],"webhookId":"2e8d0283-e593-460b-9076-bae7330db38d","credentials":{"telegramApi":{"id":"mrDBEGr5w2Hma1j4","name":"xxx"}}},{"parameters":{"amount":25,"unit":"seconds"},"id":"c5c284a1-5efa-4c61-a13e-6314effd5eee","name":"Wait 1 Min","type":"n8n-nodes-base.wait","typeVersion":1,"position":[160,-160],"webhookId":"d23a630c-ad9c-496a-9d15-254c11c18d26"},{"parameters":{"operation":"deleteMessage","chatId":"={{ $json.result.sender_chat.id }}","messageId":"={{ $json.result.message_id }}"},"id":"e6d57e9e-96b7-48ae-a2fe-5870dbca5686","name":"Delete Welcome","type":"n8n-nodes-base.telegram","typeVersion":1,"position":[400,-48],"webhookId":"3f3c7d42-8c81-4466-84c3-a5a7ddca62d5","credentials":{"telegramApi":{"id":"mrDBEGr5w2Hma1j4","name":"xxx"}}},{"parameters":{"operation":"upsert","sheetId":"=1d2b-NkXeaWzZ9tXaLdjLBKS6N92xQf__OgYOMON6fVU","range":"=Members!A:D","key":"user_id","options":{"valueInputMode":"USER_ENTERED"}},"id":"ed27f442-12ab-4c01-8170-7f534b8974fb","name":"Log Member","type":"n8n-nodes-base.googleSheets","typeVersion":2,"position":[128,64],"alwaysOutputData":false,"notesInFlow":false,"credentials":{"googleSheetsOAuth2Api":{"id":"0Xb4rVj6AHGtRoeI","name":"Google Sheets account"}}},{"parameters":{"operation":"upsert","sheetId":"1d2b-NkXeaWzZ9tXaLdjLBKS6N92xQf__OgYOMON6fVU","range":"Blacklist!A:C","key":"user_id","options":{"valueInputMode":"USER_ENTERED"}},"id":"40178e37-9a2d-4eee-a340-2bee6ea7f975","name":"Log Blacklist","type":"n8n-nodes-base.googleSheets","typeVersion":2,"position":[-96,480],"credentials":{"googleSheetsOAuth2Api":{"id":"0Xb4rVj6AHGtRoeI","name":"Google Sheets account"}}},{"parameters":{"assignments":{"assignments":[{"id":"a60c800e-5a98-45b3-ba3b-66b30bc92ebd","name":"user_id","value":"={{ $json.chat_member.old_chat_member.user.id }}","type":"number"},{"id":"d1eb59c9-5579-43d3-8381-df761f5fc03e","name":"username","value":"={{ $json.chat_member.new_chat_member.user.username }}","type":"string"},{"id":"41fd5fae-ffd2-4d56-870c-c100822662bf","name":"first_name","value":"={{ $json.chat_member.new_chat_member.user.first_name }}","type":"string"},{"id":"dd6b24e2-993c-4f41-8035-17e1f860ec83","name":"join_date","value":"={{$now.toFormat(\"yyyy-MM-dd HH:mm:ss\")}}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-144,64],"id":"dc01ec06-f237-45fc-bcfb-10fe606c01da","name":"Edit Fields"},{"parameters":{"assignments":{"assignments":[{"id":"a60c800e-5a98-45b3-ba3b-66b30bc92ebd","name":"user_id","value":"={{ $json.chat_member.old_chat_member.user.id }}","type":"number"},{"id":"d1eb59c9-5579-43d3-8381-df761f5fc03e","name":"username","value":"={{ $json.chat_member.new_chat_member.user.username }}","type":"string"},{"id":"dd6b24e2-993c-4f41-8035-17e1f860ec83","name":"left_date","value":"={{$now.toFormat(\"yyyy-MM-dd HH:mm:ss\")}}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-352,400],"id":"9954d1cb-9d96-41f4-b2b9-c60532bef148","name":"Edit Fields1"},{"parameters":{"method":"POST","url":"https://api.telegram.org/bot6993141447:AAEtq8ThQUl7r0kQKZO3EiDmNQPy5QrpfuM/banChatMember","sendHeaders":true,"headerParameters":{"parameters":[{}]},"sendBody":true,"contentType":"multipart-form-data","bodyParameters":{"parameters":[{"name":"chat_id","value":"={{ $json.chat_member.chat.id }}"},{"name":"user_id","value":"={{ $('Telegram Trigger').item.json.chat_member.from.id }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.3,"position":[-32,304],"id":"14bec03a-500d-45dd-9c5a-b2a2903e8a8a","name":"HTTP Request"},{"parameters":{"chatId":"={{ $('Telegram Trigger').item.json.chat_member.from.id }}","text":"=@{{ $('Telegram Trigger').item.json.chat_member.from.username }}, –ñ–∞–ª—å, —á—Ç–æ –ø–æ–∫–∏–Ω—É–ª –Ω–∞—Å. –û–±—Ä–∞—Ç–Ω–æ –¥–æ—Ä–æ–≥–∏ –Ω–µ—Ç. ","additionalFields":{"parse_mode":"HTML"}},"id":"b49a0394-4e0f-4c8b-94d2-d4b7dcea3071","name":"Send Welcome1","type":"n8n-nodes-base.telegram","typeVersion":1,"position":[144,304],"webhookId":"2e8d0283-e593-460b-9076-bae7330db38d","credentials":{"telegramApi":{"id":"mrDBEGr5w2Hma1j4","name":"xxx"}}},{"parameters":{"chatId":"=5444227047","text":"=@{{ $('Telegram Trigger').item.json.chat_member.old_chat_member.user.username }}, –ø–æ–∫–∏–Ω—É–ª –∫–∞–Ω–∞–ª {{ $('Check Status').item.json.chat_member.chat.title }}","additionalFields":{"parse_mode":"HTML"}},"id":"9d497e2c-0776-4e15-817f-750759e4d994","name":"Send Welcome2","type":"n8n-nodes-base.telegram","typeVersion":1,"position":[304,304],"webhookId":"2e8d0283-e593-460b-9076-bae7330db38d","credentials":{"telegramApi":{"id":"mrDBEGr5w2Hma1j4","name":"xxx"}}},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"leftValue":"={{ $json.chat_member }}","rightValue":"","operator":{"type":"object","operation":"exists","singleValue":true},"id":"2c08cf59-0da9-470f-9e4d-94556de21e24"}],"combinator":"and"},"renameOutput":true,"outputKey":"chat_member"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"leftValue":"={{ $json.message.chat.id }}","rightValue":-1002614910717,"operator":{"type":"number","operation":"equals"},"id":"b43de883-94f7-41e4-ad15-aa32ab940d6a"}],"combinator":"and"},"renameOutput":true,"outputKey":"chat_moderation"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"44b174bc-2994-4deb-8c2b-2b5b758c416d","leftValue":"={{ $json.message.sender_chat.id }}","rightValue":-1002317572251,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"chat_moderation_osnova"}]},"options":{"fallbackOutput":"none"}},"id":"198e0040-a4a4-4c2d-955d-0b89deb5666d","name":"Event Type","type":"n8n-nodes-base.switch","typeVersion":3.4,"position":[-832,208]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"sender-chat-check","leftValue":"={{ $json.message.sender_chat }}","rightValue":"","operator":{"type":"object","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"id":"be0120c8-35c4-422d-b1b4-14f06d331253","name":"Is Channel Post?","type":"n8n-nodes-base.if","typeVersion":2.3,"position":[-544,656]},{"parameters":{"operation":"deleteMessage","chatId":"={{ $('Telegram Trigger').item.json.message.chat.id }}","messageId":"={{ $('Telegram Trigger').item.json.message.message_id }}"},"id":"172be809-e9e3-4cea-bfe8-7b1bbe0aa0cb","name":"Delete Anonymous Message","type":"n8n-nodes-base.telegram","typeVersion":1.2,"position":[-352,560],"webhookId":"02347f31-f6a5-43c2-b4ee-3be5efd1d5be","credentials":{"telegramApi":{"id":"mrDBEGr5w2Hma1j4","name":"xxx"}}},{"parameters":{"method":"POST","url":"https://api.telegram.org/bot6993141447:AAEtq8ThQUl7r0kQKZO3EiDmNQPy5QrpfuM/sendMessage","sendBody":true,"bodyParameters":{"parameters":[{"name":"chat_id","value":"={{ $('Telegram Trigger').item.json.message.chat.id }}"},{"name":"text","value":"=@{{ $('Telegram Trigger').item.json.message.sender_chat.username }}! \n\n–°–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –∏–º–µ–Ω–∏ –∫–∞–Ω–∞–ª–∞ –∑–∞–ø—Ä–µ—â–µ–Ω—ã –≤ —ç—Ç–æ–º —á–∞—Ç–µ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–∏—à–∏—Ç–µ –æ—Ç —Å–≤–æ–µ–≥–æ –∏–º–µ–Ω–∏. "}]},"options":{}},"id":"376a0c89-3b7a-4245-a5bb-467db4d796b1","name":"Notify Anonymous Forbidden","type":"n8n-nodes-base.httpRequest","typeVersion":4.3,"position":[-192,624]},{"parameters":{"amount":5,"unit":"seconds"},"id":"47631b91-2356-4c85-af14-ae4a1c27b9fc","name":"Wait 5s Anon","type":"n8n-nodes-base.wait","typeVersion":1,"position":[-16,624],"webhookId":"9a3d0fdf-1f5e-40c1-905f-f9c01821c9f0"},{"parameters":{"operation":"deleteMessage","chatId":"={{ $('Telegram Trigger').item.json.message.chat.id }}","messageId":"={{ $json.result.message_id }}"},"id":"5e758813-183b-4335-a874-6a72221ddbda","name":"Delete Anon Notification","type":"n8n-nodes-base.telegram","typeVersion":1.2,"position":[272,624],"webhookId":"2df06dbf-14eb-4b1e-916d-2a310c191f1e","credentials":{"telegramApi":{"id":"mrDBEGr5w2Hma1j4","name":"xxx"}}},{"parameters":{"method":"POST","url":"https://api.telegram.org/bot6993141447:AAEtq8ThQUl7r0kQKZO3EiDmNQPy5QrpfuM/getChatMember","sendBody":true,"bodyParameters":{"parameters":[{"name":"chat_id","value":"={{ $json.message.reply_to_message.sender_chat.id }}"},{"name":"user_id","value":"={{ $('Telegram Trigger').item.json.message.from.id }}"}]},"options":{}},"id":"6945d108-b185-46ad-8e17-a65bf5200056","name":"Check Subscription","type":"n8n-nodes-base.httpRequest","typeVersion":4.3,"position":[-336,976]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"leftValue":"={{ $json.result.status }}","rightValue":"member","operator":{"type":"string","operation":"equals"}},{"leftValue":"={{ $json.result.status }}","rightValue":"administrator","operator":{"type":"string","operation":"equals"}},{"leftValue":"={{ $json.result.status }}","rightValue":"creator","operator":{"type":"string","operation":"equals"}}],"combinator":"or"},"options":{}},"id":"2c42d2f2-ae78-4290-9c0d-8dd0414d95fe","name":"Is Subscribed?","type":"n8n-nodes-base.if","typeVersion":2.3,"position":[-176,976]},{"parameters":{"operation":"deleteMessage","chatId":"={{ $('Telegram Trigger').item.json.message.chat.id }}","messageId":"={{ $('Telegram Trigger').item.json.message.message_id }}"},"id":"9fe43038-8716-40de-a7c8-adcb98694167","name":"Delete Not Subscribed Message","type":"n8n-nodes-base.telegram","typeVersion":1.2,"position":[80,992],"webhookId":"78ca75ae-cb9b-4731-8ec3-aa4716b48763","credentials":{"telegramApi":{"id":"mrDBEGr5w2Hma1j4","name":"xxx"}}},{"parameters":{"method":"POST","url":"https://api.telegram.org/bot6993141447:AAEtq8ThQUl7r0kQKZO3EiDmNQPy5QrpfuM/sendMessage","sendBody":true,"bodyParameters":{"parameters":[{"name":"chat_id","value":"={{ $('Telegram Trigger').item.json.message.reply_to_message.sender_chat.id }}"},{"name":"text","value":"=@{{ $('Telegram Trigger').item.json.message.from.username }} \n\n–ß—Ç–æ–±—ã –ø–∏—Å–∞—Ç—å –≤ —ç—Ç–æ–º —á–∞—Ç–µ, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –±—ã—Ç—å –ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–º –Ω–∞ –∫–∞–Ω–∞–ª. "}]},"options":{}},"id":"b52bddb3-ede6-4a32-ae63-d9d342549701","name":"Notify Not Subscribed","type":"n8n-nodes-base.httpRequest","typeVersion":4.3,"position":[240,1168]},{"parameters":{"amount":7,"unit":"seconds"},"id":"9408e3e1-75c8-4ea7-85da-247920d60920","name":"Wait 7s Sub","type":"n8n-nodes-base.wait","typeVersion":1,"position":[464,1120],"webhookId":"75c2cfc1-ccd8-48be-ae74-f5f475cdaa25"},{"parameters":{"operation":"deleteMessage","chatId":"={{ $json.result.chat.id }}","messageId":"={{ $json.result.message_id }}"},"id":"69607242-ffa6-4405-a938-8267709a5583","name":"Delete Sub Notification","type":"n8n-nodes-base.telegram","typeVersion":1.2,"position":[640,992],"webhookId":"64417069-175a-4e47-91a8-595fcf0cef3f","credentials":{"telegramApi":{"id":"mrDBEGr5w2Hma1j4","name":"xxx"}}},{"parameters":{"method":"POST","url":"https://api.telegram.org/bot6993141447:AAEtq8ThQUl7r0kQKZO3EiDmNQPy5QrpfuM/sendMessage","sendBody":true,"bodyParameters":{"parameters":[{"name":"chat_id","value":"={{ $('Telegram Trigger').item.json.message.chat.id }}"},{"name":"text","value":"=@{{ $('Telegram Trigger').item.json.message.sender_chat.username }}! \n\n–°–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –∏–º–µ–Ω–∏ –∫–∞–Ω–∞–ª–∞ –∑–∞–ø—Ä–µ—â–µ–Ω—ã –≤ —ç—Ç–æ–º —á–∞—Ç–µ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–∏—à–∏—Ç–µ –æ—Ç —Å–≤–æ–µ–≥–æ –∏–º–µ–Ω–∏. "}]},"options":{}},"id":"f25b5028-e445-49ee-af8b-ed3df3ce9d9a","name":"Notify Anonymous Forbidden1","type":"n8n-nodes-base.httpRequest","typeVersion":4.3,"position":[960,992]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"sender-chat-check","leftValue":"={{ $('Telegram Trigger').item.json.message.chat.id }}","rightValue":-1002317572251,"operator":{"type":"number","operation":"notEquals"}}],"combinator":"and"},"options":{}},"id":"ff528a97-8f0c-4c60-a715-54c29036d69c","name":"Is Channel Post?1","type":"n8n-nodes-base.if","typeVersion":2.3,"position":[-800,640]}],"connections":{"Telegram Trigger":{"main":[[{"node":"Event Type","type":"main","index":0}]]},"Check Status":{"main":[[{"node":"Send Welcome","type":"main","index":0}],[{"node":"Edit Fields1","type":"main","index":0},{"node":"HTTP Request","type":"main","index":0}]]},"Send Welcome":{"main":[[{"node":"Wait 1 Min","type":"main","index":0}]]},"Wait 1 Min":{"main":[[{"node":"Delete Welcome","type":"main","index":0}]]},"Edit Fields":{"main":[[{"node":"Log Member","type":"main","index":0}]]},"Edit Fields1":{"main":[[{"node":"Log Blacklist","type":"main","index":0}]]},"HTTP Request":{"main":[[{"node":"Send Welcome1","type":"main","index":0}]]},"Send Welcome1":{"main":[[{"node":"Send Welcome2","type":"main","index":0}]]},"Event Type":{"main":[[{"node":"Check Status","type":"main","index":0}],[],[]]},"Is Channel Post?":{"main":[[{"node":"Delete Anonymous Message","type":"main","index":0}],[{"node":"Check Subscription","type":"main","index":0}]]},"Delete Anonymous Message":{"main":[[{"node":"Notify Anonymous Forbidden","type":"main","index":0}]]},"Notify Anonymous Forbidden":{"main":[[{"node":"Wait 5s Anon","type":"main","index":0}]]},"Wait 5s Anon":{"main":[[{"node":"Delete Anon Notification","type":"main","index":0}]]},"Check Subscription":{"main":[[{"node":"Is Subscribed?","type":"main","index":0}]]},"Is Subscribed?":{"main":[[],[{"node":"Delete Not Subscribed Message","type":"main","index":0}]]},"Delete Not Subscribed Message":{"main":[[]]},"Notify Not Subscribed":{"main":[[{"node":"Wait 7s Sub","type":"main","index":0}]]},"Wait 7s Sub":{"main":[[{"node":"Delete Sub Notification","type":"main","index":0}]]},"Is Channel Post?1":{"main":[[{"node":"Is Channel Post?","type":"main","index":0}],[]]}},"settings":{"executionOrder":"v1","availableInMCP":false,"callerPolicy":"workflowsFromSameOwner"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"560540fa-8146-49cb-92b6-202b16e42876","activeVersionId":"560540fa-8146-49cb-92b6-202b16e42876","triggerCount":1,"shared":[{"updatedAt":"2026-01-19T17:42:27.160Z","createdAt":"2026-01-19T17:42:27.160Z","role":"workflow:owner","workflowId":"EJsyXaXI_Pc7ayntR6cml","projectId":"UnFAqkOZkFc92cC9"}],"activeVersion":{"updatedAt":"2026-02-02T07:51:30.402Z","createdAt":"2026-02-02T07:51:25.977Z","versionId":"560540fa-8146-49cb-92b6-202b16e42876","workflowId":"EJsyXaXI_Pc7ayntR6cml","nodes":[{"parameters":{"updates":["chat_member","message_reaction","message"],"additionalFields":{}},"id":"0f446c1b-672d-4445-8e5f-71d8015f9f64","name":"Telegram Trigger","type":"n8n-nodes-base.telegramTrigger","typeVersion":1,"position":[-1056,224],"webhookId":"your-webhook-id","credentials":{"telegramApi":{"id":"mrDBEGr5w2Hma1j4","name":"xxx"}}},{"parameters":{"dataType":"string","value1":"={{ $json.chat_member.new_chat_member.status }}","rules":{"rules":[{"value2":"member"},{"value2":"left","output":1},{"value2":"kicked","output":1}]}},"id":"1982fe65-8851-47c5-b6da-7ce4c82a3855","name":"Check Status","type":"n8n-nodes-base.switch","typeVersion":1,"position":[-624,-32]},{"parameters":{"chatId":"={{ $('Telegram Trigger').item.json.chat_member.chat.id }}","text":"=@{{ $('Telegram Trigger').item.json.chat_member.new_chat_member.user.username }} –ü—Ä–∏–≤–µ—Ç, –Ω–∞–¥–µ—é—Å—å –Ω–∞–π–¥–µ—à—å –∑–¥–µ—Å—å –æ—Ç–≤–µ—Ç –Ω–∞ —Å–≤–æ–π –≤–æ–ø—Ä–æ—Å. ","additionalFields":{"parse_mode":"HTML"}},"id":"a065ae04-30c2-4482-b0dc-aac0ed64bf6e","name":"Send Welcome","type":"n8n-nodes-base.telegram","typeVersion":1,"position":[-112,-160],"webhookId":"2e8d0283-e593-460b-9076-bae7330db38d","credentials":{"telegramApi":{"id":"mrDBEGr5w2Hma1j4","name":"xxx"}}},{"parameters":{"amount":25,"unit":"seconds"},"id":"c5c284a1-5efa-4c61-a13e-6314effd5eee","name":"Wait 1 Min","type":"n8n-nodes-base.wait","typeVersion":1,"position":[160,-160],"webhookId":"d23a630c-ad9c-496a-9d15-254c11c18d26"},{"parameters":{"operation":"deleteMessage","chatId":"={{ $json.result.sender_chat.id }}","messageId":"={{ $json.result.message_id }}"},"id":"e6d57e9e-96b7-48ae-a2fe-5870dbca5686","name":"Delete Welcome","type":"n8n-nodes-base.telegram","typeVersion":1,"position":[400,-48],"webhookId":"3f3c7d42-8c81-4466-84c3-a5a7ddca62d5","credentials":{"telegramApi":{"id":"mrDBEGr5w2Hma1j4","name":"xxx"}}},{"parameters":{"operation":"upsert","sheetId":"=1d2b-NkXeaWzZ9tXaLdjLBKS6N92xQf__OgYOMON6fVU","range":"=Members!A:D","key":"user_id","options":{"valueInputMode":"USER_ENTERED"}},"id":"ed27f442-12ab-4c01-8170-7f534b8974fb","name":"Log Member","type":"n8n-nodes-base.googleSheets","typeVersion":2,"position":[128,64],"alwaysOutputData":false,"notesInFlow":false,"credentials":{"googleSheetsOAuth2Api":{"id":"0Xb4rVj6AHGtRoeI","name":"Google Sheets account"}}},{"parameters":{"operation":"upsert","sheetId":"1d2b-NkXeaWzZ9tXaLdjLBKS6N92xQf__OgYOMON6fVU","range":"Blacklist!A:C","key":"user_id","options":{"valueInputMode":"USER_ENTERED"}},"id":"40178e37-9a2d-4eee-a340-2bee6ea7f975","name":"Log Blacklist","type":"n8n-nodes-base.googleSheets","typeVersion":2,"position":[-96,480],"credentials":{"googleSheetsOAuth2Api":{"id":"0Xb4rVj6AHGtRoeI","name":"Google Sheets account"}}},{"parameters":{"assignments":{"assignments":[{"id":"a60c800e-5a98-45b3-ba3b-66b30bc92ebd","name":"user_id","value":"={{ $json.chat_member.old_chat_member.user.id }}","type":"number"},{"id":"d1eb59c9-5579-43d3-8381-df761f5fc03e","name":"username","value":"={{ $json.chat_member.new_chat_member.user.username }}","type":"string"},{"id":"41fd5fae-ffd2-4d56-870c-c100822662bf","name":"first_name","value":"={{ $json.chat_member.new_chat_member.user.first_name }}","type":"string"},{"id":"dd6b24e2-993c-4f41-8035-17e1f860ec83","name":"join_date","value":"={{$now.toFormat(\"yyyy-MM-dd HH:mm:ss\")}}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-144,64],"id":"dc01ec06-f237-45fc-bcfb-10fe606c01da","name":"Edit Fields"},{"parameters":{"assignments":{"assignments":[{"id":"a60c800e-5a98-45b3-ba3b-66b30bc92ebd","name":"user_id","value":"={{ $json.chat_member.old_chat_member.user.id }}","type":"number"},{"id":"d1eb59c9-5579-43d3-8381-df761f5fc03e","name":"username","value":"={{ $json.chat_member.new_chat_member.user.username }}","type":"string"},{"id":"dd6b24e2-993c-4f41-8035-17e1f860ec83","name":"left_date","value":"={{$now.toFormat(\"yyyy-MM-dd HH:mm:ss\")}}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-352,400],"id":"9954d1cb-9d96-41f4-b2b9-c60532bef148","name":"Edit Fields1"},{"parameters":{"method":"POST","url":"https://api.telegram.org/bot6993141447:AAEtq8ThQUl7r0kQKZO3EiDmNQPy5QrpfuM/banChatMember","sendHeaders":true,"headerParameters":{"parameters":[{}]},"sendBody":true,"contentType":"multipart-form-data","bodyParameters":{"parameters":[{"name":"chat_id","value":"={{ $json.chat_member.chat.id }}"},{"name":"user_id","value":"={{ $('Telegram Trigger').item.json.chat_member.from.id }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.3,"position":[-32,304],"id":"14bec03a-500d-45dd-9c5a-b2a2903e8a8a","name":"HTTP Request"},{"parameters":{"chatId":"={{ $('Telegram Trigger').item.json.chat_member.from.id }}","text":"=@{{ $('Telegram Trigger').item.json.chat_member.from.username }}, –ñ–∞–ª—å, —á—Ç–æ –ø–æ–∫–∏–Ω—É–ª –Ω–∞—Å. –û–±—Ä–∞—Ç–Ω–æ –¥–æ—Ä–æ–≥–∏ –Ω–µ—Ç. ","additionalFields":{"parse_mode":"HTML"}},"id":"b49a0394-4e0f-4c8b-94d2-d4b7dcea3071","name":"Send Welcome1","type":"n8n-nodes-base.telegram","typeVersion":1,"position":[144,304],"webhookId":"2e8d0283-e593-460b-9076-bae7330db38d","credentials":{"telegramApi":{"id":"mrDBEGr5w2Hma1j4","name":"xxx"}}},{"parameters":{"chatId":"=5444227047","text":"=@{{ $('Telegram Trigger').item.json.chat_member.old_chat_member.user.username }}, –ø–æ–∫–∏–Ω—É–ª –∫–∞–Ω–∞–ª {{ $('Check Status').item.json.chat_member.chat.title }}","additionalFields":{"parse_mode":"HTML"}},"id":"9d497e2c-0776-4e15-817f-750759e4d994","name":"Send Welcome2","type":"n8n-nodes-base.telegram","typeVersion":1,"position":[304,304],"webhookId":"2e8d0283-e593-460b-9076-bae7330db38d","credentials":{"telegramApi":{"id":"mrDBEGr5w2Hma1j4","name":"xxx"}}},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"leftValue":"={{ $json.chat_member }}","rightValue":"","operator":{"type":"object","operation":"exists","singleValue":true},"id":"2c08cf59-0da9-470f-9e4d-94556de21e24"}],"combinator":"and"},"renameOutput":true,"outputKey":"chat_member"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"leftValue":"={{ $json.message.chat.id }}","rightValue":-1002614910717,"operator":{"type":"number","operation":"equals"},"id":"b43de883-94f7-41e4-ad15-aa32ab940d6a"}],"combinator":"and"},"renameOutput":true,"outputKey":"chat_moderation"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"44b174bc-2994-4deb-8c2b-2b5b758c416d","leftValue":"={{ $json.message.sender_chat.id }}","rightValue":-1002317572251,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"chat_moderation_osnova"}]},"options":{"fallbackOutput":"none"}},"id":"198e0040-a4a4-4c2d-955d-0b89deb5666d","name":"Event Type","type":"n8n-nodes-base.switch","typeVersion":3.4,"position":[-832,208]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"sender-chat-check","leftValue":"={{ $json.message.sender_chat }}","rightValue":"","operator":{"type":"object","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"id":"be0120c8-35c4-422d-b1b4-14f06d331253","name":"Is Channel Post?","type":"n8n-nodes-base.if","typeVersion":2.3,"position":[-544,656]},{"parameters":{"operation":"deleteMessage","chatId":"={{ $('Telegram Trigger').item.json.message.chat.id }}","messageId":"={{ $('Telegram Trigger').item.json.message.message_id }}"},"id":"172be809-e9e3-4cea-bfe8-7b1bbe0aa0cb","name":"Delete Anonymous Message","type":"n8n-nodes-base.telegram","typeVersion":1.2,"position":[-352,560],"webhookId":"02347f31-f6a5-43c2-b4ee-3be5efd1d5be","credentials":{"telegramApi":{"id":"mrDBEGr5w2Hma1j4","name":"xxx"}}},{"parameters":{"method":"POST","url":"https://api.telegram.org/bot6993141447:AAEtq8ThQUl7r0kQKZO3EiDmNQPy5QrpfuM/sendMessage","sendBody":true,"bodyParameters":{"parameters":[{"name":"chat_id","value":"={{ $('Telegram Trigger').item.json.message.chat.id }}"},{"name":"text","value":"=@{{ $('Telegram Trigger').item.json.message.sender_chat.username }}! \n\n–°–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –∏–º–µ–Ω–∏ –∫–∞–Ω–∞–ª–∞ –∑–∞–ø—Ä–µ—â–µ–Ω—ã –≤ —ç—Ç–æ–º —á–∞—Ç–µ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–∏—à–∏—Ç–µ –æ—Ç —Å–≤–æ–µ–≥–æ –∏–º–µ–Ω–∏. "}]},"options":{}},"id":"376a0c89-3b7a-4245-a5bb-467db4d796b1","name":"Notify Anonymous Forbidden","type":"n8n-nodes-base.httpRequest","typeVersion":4.3,"position":[-192,624]},{"parameters":{"amount":5,"unit":"seconds"},"id":"47631b91-2356-4c85-af14-ae4a1c27b9fc","name":"Wait 5s Anon","type":"n8n-nodes-base.wait","typeVersion":1,"position":[-16,624],"webhookId":"9a3d0fdf-1f5e-40c1-905f-f9c01821c9f0"},{"parameters":{"operation":"deleteMessage","chatId":"={{ $('Telegram Trigger').item.json.message.chat.id }}","messageId":"={{ $json.result.message_id }}"},"id":"5e758813-183b-4335-a874-6a72221ddbda","name":"Delete Anon Notification","type":"n8n-nodes-base.telegram","typeVersion":1.2,"position":[272,624],"webhookId":"2df06dbf-14eb-4b1e-916d-2a310c191f1e","credentials":{"telegramApi":{"id":"mrDBEGr5w2Hma1j4","name":"xxx"}}},{"parameters":{"method":"POST","url":"https://api.telegram.org/bot6993141447:AAEtq8ThQUl7r0kQKZO3EiDmNQPy5QrpfuM/getChatMember","sendBody":true,"bodyParameters":{"parameters":[{"name":"chat_id","value":"={{ $json.message.reply_to_message.sender_chat.id }}"},{"name":"user_id","value":"={{ $('Telegram Trigger').item.json.message.from.id }}"}]},"options":{}},"id":"6945d108-b185-46ad-8e17-a65bf5200056","name":"Check Subscription","type":"n8n-nodes-base.httpRequest","typeVersion":4.3,"position":[-336,976]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"leftValue":"={{ $json.result.status }}","rightValue":"member","operator":{"type":"string","operation":"equals"}},{"leftValue":"={{ $json.result.status }}","rightValue":"administrator","operator":{"type":"string","operation":"equals"}},{"leftValue":"={{ $json.result.status }}","rightValue":"creator","operator":{"type":"string","operation":"equals"}}],"combinator":"or"},"options":{}},"id":"2c42d2f2-ae78-4290-9c0d-8dd0414d95fe","name":"Is Subscribed?","type":"n8n-nodes-base.if","typeVersion":2.3,"position":[-176,976]},{"parameters":{"operation":"deleteMessage","chatId":"={{ $('Telegram Trigger').item.json.message.chat.id }}","messageId":"={{ $('Telegram Trigger').item.json.message.message_id }}"},"id":"9fe43038-8716-40de-a7c8-adcb98694167","name":"Delete Not Subscribed Message","type":"n8n-nodes-base.telegram","typeVersion":1.2,"position":[80,992],"webhookId":"78ca75ae-cb9b-4731-8ec3-aa4716b48763","credentials":{"telegramApi":{"id":"mrDBEGr5w2Hma1j4","name":"xxx"}}},{"parameters":{"method":"POST","url":"https://api.telegram.org/bot6993141447:AAEtq8ThQUl7r0kQKZO3EiDmNQPy5QrpfuM/sendMessage","sendBody":true,"bodyParameters":{"parameters":[{"name":"chat_id","value":"={{ $('Telegram Trigger').item.json.message.reply_to_message.sender_chat.id }}"},{"name":"text","value":"=@{{ $('Telegram Trigger').item.json.message.from.username }} \n\n–ß—Ç–æ–±—ã –ø–∏—Å–∞—Ç—å –≤ —ç—Ç–æ–º —á–∞—Ç–µ, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –±—ã—Ç—å –ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–º –Ω–∞ –∫–∞–Ω–∞–ª. "}]},"options":{}},"id":"b52bddb3-ede6-4a32-ae63-d9d342549701","name":"Notify Not Subscribed","type":"n8n-nodes-base.httpRequest","typeVersion":4.3,"position":[240,1168]},{"parameters":{"amount":7,"unit":"seconds"},"id":"9408e3e1-75c8-4ea7-85da-247920d60920","name":"Wait 7s Sub","type":"n8n-nodes-base.wait","typeVersion":1,"position":[464,1120],"webhookId":"75c2cfc1-ccd8-48be-ae74-f5f475cdaa25"},{"parameters":{"operation":"deleteMessage","chatId":"={{ $json.result.chat.id }}","messageId":"={{ $json.result.message_id }}"},"id":"69607242-ffa6-4405-a938-8267709a5583","name":"Delete Sub Notification","type":"n8n-nodes-base.telegram","typeVersion":1.2,"position":[640,992],"webhookId":"64417069-175a-4e47-91a8-595fcf0cef3f","credentials":{"telegramApi":{"id":"mrDBEGr5w2Hma1j4","name":"xxx"}}},{"parameters":{"method":"POST","url":"https://api.telegram.org/bot6993141447:AAEtq8ThQUl7r0kQKZO3EiDmNQPy5QrpfuM/sendMessage","sendBody":true,"bodyParameters":{"parameters":[{"name":"chat_id","value":"={{ $('Telegram Trigger').item.json.message.chat.id }}"},{"name":"text","value":"=@{{ $('Telegram Trigger').item.json.message.sender_chat.username }}! \n\n–°–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –∏–º–µ–Ω–∏ –∫–∞–Ω–∞–ª–∞ –∑–∞–ø—Ä–µ—â–µ–Ω—ã –≤ —ç—Ç–æ–º —á–∞—Ç–µ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–∏—à–∏—Ç–µ –æ—Ç —Å–≤–æ–µ–≥–æ –∏–º–µ–Ω–∏. "}]},"options":{}},"id":"f25b5028-e445-49ee-af8b-ed3df3ce9d9a","name":"Notify Anonymous Forbidden1","type":"n8n-nodes-base.httpRequest","typeVersion":4.3,"position":[960,992]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"sender-chat-check","leftValue":"={{ $('Telegram Trigger').item.json.message.chat.id }}","rightValue":-1002317572251,"operator":{"type":"number","operation":"notEquals"}}],"combinator":"and"},"options":{}},"id":"ff528a97-8f0c-4c60-a715-54c29036d69c","name":"Is Channel Post?1","type":"n8n-nodes-base.if","typeVersion":2.3,"position":[-800,640]}],"connections":{"Telegram Trigger":{"main":[[{"node":"Event Type","type":"main","index":0}]]},"Check Status":{"main":[[{"node":"Send Welcome","type":"main","index":0}],[{"node":"Edit Fields1","type":"main","index":0},{"node":"HTTP Request","type":"main","index":0}]]},"Send Welcome":{"main":[[{"node":"Wait 1 Min","type":"main","index":0}]]},"Wait 1 Min":{"main":[[{"node":"Delete Welcome","type":"main","index":0}]]},"Edit Fields":{"main":[[{"node":"Log Member","type":"main","index":0}]]},"Edit Fields1":{"main":[[{"node":"Log Blacklist","type":"main","index":0}]]},"HTTP Request":{"main":[[{"node":"Send Welcome1","type":"main","index":0}]]},"Send Welcome1":{"main":[[{"node":"Send Welcome2","type":"main","index":0}]]},"Event Type":{"main":[[{"node":"Check Status","type":"main","index":0}],[],[]]},"Is Channel Post?":{"main":[[{"node":"Delete Anonymous Message","type":"main","index":0}],[{"node":"Check Subscription","type":"main","index":0}]]},"Delete Anonymous Message":{"main":[[{"node":"Notify Anonymous Forbidden","type":"main","index":0}]]},"Notify Anonymous Forbidden":{"main":[[{"node":"Wait 5s Anon","type":"main","index":0}]]},"Wait 5s Anon":{"main":[[{"node":"Delete Anon Notification","type":"main","index":0}]]},"Check Subscription":{"main":[[{"node":"Is Subscribed?","type":"main","index":0}]]},"Is Subscribed?":{"main":[[],[{"node":"Delete Not Subscribed Message","type":"main","index":0}]]},"Delete Not Subscribed Message":{"main":[[]]},"Notify Not Subscribed":{"main":[[{"node":"Wait 7s Sub","type":"main","index":0}]]},"Wait 7s Sub":{"main":[[{"node":"Delete Sub Notification","type":"main","index":0}]]},"Is Channel Post?1":{"main":[[{"node":"Is Channel Post?","type":"main","index":0}],[]]}},"authors":"–†–æ–º–∞–Ω –ú–∞—Ö–º–µ—Ç–æ–≤","name":"Version 560540fa","description":"","autosaved":false},"tags":[]},{"updatedAt":"2026-02-08T19:51:45.300Z","createdAt":"2026-02-08T19:22:17.575Z","id":"FqO0ER3eF7GgbESNhfC9C","name":"user-status","active":true,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"user-status","responseMode":"responseNode","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2.1,"position":[-416,-192],"id":"9601f2f0-0d9f-4cef-abe3-a9c1641bd075","name":"user-status","webhookId":"a4d902e4-eb42-4723-a297-cebca2ef1b0d"},{"parameters":{"operation":"executeQuery","query":"INSERT INTO users (id, username, created_at)\nVALUES ({{ $json.body.user_id }}, '{{ $json.body.username }}', NOW())\nON CONFLICT (id) DO NOTHING;\n\nSELECT \n  id,\n  free_generations,\n  total_paid,\n  CASE \n    WHEN DATE(created_at) < CURRENT_DATE \n    THEN 3 \n    ELSE free_generations \n  END as free_left\nFROM users \nWHERE id = {{ $json.body.user_id }};","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-208,-192],"id":"46339b6c-daff-42a5-90da-8e30d52d6ba0","name":"Execute a SQL query","credentials":{"postgres":{"id":"UirFNzTALE9CZEcQ","name":"avatar_bot"}}},{"parameters":{"respondWith":"allIncomingItems","options":{"responseCode":200}},"type":"n8n-nodes-base.respondToWebhook","typeVersion":1.5,"position":[16,-192],"id":"17963390-efd6-419e-8eba-24ce1fa605af","name":"Respond to Webhook"}],"connections":{"user-status":{"main":[[{"node":"Execute a SQL query","type":"main","index":0}]]},"Execute a SQL query":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","availableInMCP":false},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"bc3731ff-7291-4255-b8bb-1dd4229c6079","activeVersionId":"bc3731ff-7291-4255-b8bb-1dd4229c6079","triggerCount":1,"shared":[{"updatedAt":"2026-02-08T19:22:17.575Z","createdAt":"2026-02-08T19:22:17.575Z","role":"workflow:owner","workflowId":"FqO0ER3eF7GgbESNhfC9C","projectId":"UnFAqkOZkFc92cC9"}],"activeVersion":{"updatedAt":"2026-02-08T19:51:47.814Z","createdAt":"2026-02-08T19:51:45.301Z","versionId":"bc3731ff-7291-4255-b8bb-1dd4229c6079","workflowId":"FqO0ER3eF7GgbESNhfC9C","nodes":[{"parameters":{"httpMethod":"POST","path":"user-status","responseMode":"responseNode","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2.1,"position":[-416,-192],"id":"9601f2f0-0d9f-4cef-abe3-a9c1641bd075","name":"user-status","webhookId":"a4d902e4-eb42-4723-a297-cebca2ef1b0d"},{"parameters":{"operation":"executeQuery","query":"INSERT INTO users (id, username, created_at)\nVALUES ({{ $json.body.user_id }}, '{{ $json.body.username }}', NOW())\nON CONFLICT (id) DO NOTHING;\n\nSELECT \n  id,\n  free_generations,\n  total_paid,\n  CASE \n    WHEN DATE(created_at) < CURRENT_DATE \n    THEN 3 \n    ELSE free_generations \n  END as free_left\nFROM users \nWHERE id = {{ $json.body.user_id }};","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-208,-192],"id":"46339b6c-daff-42a5-90da-8e30d52d6ba0","name":"Execute a SQL query","credentials":{"postgres":{"id":"UirFNzTALE9CZEcQ","name":"avatar_bot"}}},{"parameters":{"respondWith":"allIncomingItems","options":{"responseCode":200}},"type":"n8n-nodes-base.respondToWebhook","typeVersion":1.5,"position":[16,-192],"id":"17963390-efd6-419e-8eba-24ce1fa605af","name":"Respond to Webhook"}],"connections":{"user-status":{"main":[[{"node":"Execute a SQL query","type":"main","index":0}]]},"Execute a SQL query":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]}},"authors":"–†–æ–º–∞–Ω –ú–∞—Ö–º–µ—Ç–æ–≤","name":"Version bc3731ff","description":"","autosaved":false},"tags":[]},{"updatedAt":"2026-01-25T17:46:26.922Z","createdAt":"2026-01-24T19:22:36.857Z","id":"fuFhJW63fSIhHK8y","name":"–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è","active":true,"isArchived":false,"nodes":[{"parameters":{"sessionIdType":"customKey","sessionKey":"={{ $json.business_message?.chat?.id || $json.message?.chat?.id }}_consultation"},"id":"c4661291-575b-4189-844f-39a863b27b7f","name":"Consultation Memory","type":"@n8n/n8n-nodes-langchain.memoryBufferWindow","typeVersion":1.3,"position":[-720,704]},{"parameters":{"promptType":"define","text":"={{ $json.body.message.text }}","options":{"systemMessage":"–¢—ã –ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –∑–∞–ø–∏—Å–∏ –Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é.\n\n–°–¶–ï–ù–ê–†–ò–ô - –°–ë–û–† –î–ê–ù–ù–´–•:\n–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∏—Å–ª–∞–ª –¥–∞–Ω–Ω—ã–µ –æ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏. –¢–≤–æ—è –∑–∞–¥–∞—á–∞:\n\n1. –ò–∑–≤–ª–µ—á—å –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è:\n   - –¢–µ–º–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏\n   - –î–∞—Ç–∞ (–ø—Ä–µ–æ–±—Ä–∞–∑—É–π –≤ —Ñ–æ—Ä–º–∞—Ç YYYY-MM-DD, –≥–æ–¥ –≤—Å–µ–≥–¥–∞ 2026)\n   - –í—Ä–µ–º—è (—Ñ–æ—Ä–º–∞—Ç HH:MM, –≤—Å–µ–≥–¥–∞ –ø–æ –ú–°–ö)\n\n–ü—Ä–∏–º–µ—Ä—ã –¥–∞—Ç:\n- \"26.01\" ‚Üí \"2026-01-26\"\n- \"26 —è–Ω–≤–∞—Ä—è\" ‚Üí \"2026-01-26\"\n- \"5 —Ñ–µ–≤—Ä–∞–ª—è\" ‚Üí \"2026-02-05\"\n\n2. –ï—Å–ª–∏ —á–µ–≥–æ-—Ç–æ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç ‚Üí –≤–µ–∂–ª–∏–≤–æ —É—Ç–æ—á–Ω–∏\n\n3. –ö–æ–≥–¥–∞ –í–°–ï –¥–∞–Ω–Ω—ã–µ —Å–æ–±—Ä–∞–Ω—ã:\n   - –ò—Å–ø–æ–ª—å–∑—É–π Google Calendar tool –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏\n   - Tool –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω—É—é –¥–∞—Ç—É/–≤—Ä–µ–º—è\n\n4. –ü–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—è:\n   - –ï—Å–ª–∏ –≤—Ä–µ–º—è –°–í–û–ë–û–î–ù–û ‚Üí –æ—Ç–≤–µ—Ç—å: \"‚úÖ –í—Ä–µ–º—è —Å–≤–æ–±–æ–¥–Ω–æ! –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç–µ –∑–∞–ø–∏—Å—å? (–Ω–∞–ø–∏—à–∏—Ç–µ '–¥–∞' –∏–ª–∏ '–æ—Ç–º–µ–Ω–∞')\"\n   - –ï—Å–ª–∏ –ó–ê–ù–Ø–¢–û ‚Üí –æ—Ç–≤–µ—Ç—å: \"‚ùå –ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, —ç—Ç–æ –≤—Ä–µ–º—è –∑–∞–Ω—è—Ç–æ. –ü—Ä–µ–¥–ª–æ–∂–∏—Ç–µ –¥—Ä—É–≥–æ–µ –≤—Ä–µ–º—è.\"\n\n–í–ê–ñ–ù–û:\n- –í—Ä–µ–º—è –≤—Å–µ–≥–¥–∞ —É–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ –ú–°–ö\n- –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏: 1 —á–∞—Å\n- –°—Ç–æ–∏–º–æ—Å—Ç—å: 5000 —Ä—É–±–ª–µ–π\n- –ë—É–¥—å –∫—Ä–∞—Ç–∫–∏–º –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–º\n"}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":3.1,"position":[-848,384],"id":"85e8bc28-41a5-48cd-8607-42287d79540c","name":"AI Agent1"},{"parameters":{"model":{"__rl":true,"value":"gpt-4.1-nano","mode":"list","cachedResultName":"gpt-4.1-nano"},"responsesApiEnabled":false,"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.3,"position":[-848,544],"id":"dc4f3a6e-0ebf-47ce-b10d-83bc15da04e4","name":"OpenAI Chat Model1","credentials":{"openAiApi":{"id":"P0RwIIFegl7Qbpo2","name":"OpenAi account"}}},{"parameters":{"method":"=POST","url":"=https://api.telegram.org/bot7907939704:AAHqQu-Uy4q8iKnknxqBzHQUWcz5IjNZrjA/sendMessage","sendQuery":true,"queryParameters":{"parameters":[{"name":"business_connection_id","value":"={{ $json.body.telegram.chat_id }}"},{"name":"chat_id","value":"={{ $json.body.telegram.user_id }}"},{"name":"text","value":"=–û—Ç–ª–∏—á–Ω–æ!\n–î–∞–≤–∞–π—Ç–µ –∑–∞–ø–∏—à–µ–º –≤–∞—Å –Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é.\n\nüí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å: 5000 —Ä—É–±–ª–µ–π\n‚è∞ –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: 1 —á–∞—Å\n\n–î–ª—è –∑–∞–ø–∏—Å–∏ –º–Ω–µ –Ω—É–∂–Ω–∞ —Å–ª–µ–¥—É—é—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:\n1. –¢–µ–º–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏\n2. –ñ–µ–ª–∞–µ–º–∞—è –¥–∞—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: 25 —è–Ω–≤–∞—Ä—è)\n3. –ñ–µ–ª–∞–µ–º–æ–µ –≤—Ä–µ–º—è (–Ω–∞–ø—Ä–∏–º–µ—Ä: 14:00)\n4. –í–∞—à —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å (–Ω–∞–ø—Ä–∏–º–µ—Ä: MSK, MSK+1, MSK+2)\n\n–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–ø–∏—à–∏—Ç–µ –≤—Å–µ —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ –≤ —Å–ª–µ–¥—É—é—â–µ–º —Å–æ–æ–±—â–µ–Ω–∏–∏."}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.3,"position":[-576,848],"id":"e2bb9697-4b18-4bc1-84ce-e78c54b7f35c","name":"HTTP Request1"},{"parameters":{"httpMethod":"POST","path":"consult/entry","responseMode":"responseNode","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2.1,"position":[-1696,752],"id":"0672a21f-9650-4e8d-b629-4e92b2f70ecf","name":"Webhook","webhookId":"668c35db-f099-4c8d-bec3-a5993948742b"},{"parameters":{"respondWith":"allIncomingItems","options":{}},"type":"n8n-nodes-base.respondToWebhook","typeVersion":1.5,"position":[-1520,752],"id":"67be80b6-c97b-45c8-8a6d-c871ec26e3e8","name":"Respond to Webhook"},{"parameters":{"operation":"executeQuery","query":"update bot_user_state\nset state='consult',\n    step='wait_form',\n    updated_at=now()\nwhere user_id = $1;\n","options":{"queryReplacement":"={{ $('Webhook').item.json.body.telegram.user_id }}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-384,848],"id":"67a7bfa6-cc45-4e47-83c1-c3b8751221b8","name":"Execute a SQL query","credentials":{"postgres":{"id":"bNYxHjx2dgnO3BKs","name":"Postgres account"}}},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":3},"conditions":[{"leftValue":"={{ $json.body.state.step }}","rightValue":"wait_form","operator":{"type":"string","operation":"equals"},"id":"f1dc7497-297b-442a-a96f-f490ccfc29eb"}],"combinator":"and"},"renameOutput":true,"outputKey":"wait_form"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":3},"conditions":[{"leftValue":"={{ $json.body.state.step }}","rightValue":"wait_datetime","operator":{"type":"string","operation":"equals"},"id":"bbe63238-3f4d-4a31-baa0-d331b0476f8d"}],"combinator":"and"},"renameOutput":true,"outputKey":"wait_datetime"}]},"looseTypeValidation":true,"options":{"fallbackOutput":"extra"}},"type":"n8n-nodes-base.switch","typeVersion":3.4,"position":[-1200,736],"id":"38b17dba-9d35-45e7-8639-bdc1ad4c6d15","name":"Switch"},{"parameters":{"method":"=POST","url":"=https://api.telegram.org/bot7907939704:AAHqQu-Uy4q8iKnknxqBzHQUWcz5IjNZrjA/sendMessage","sendQuery":true,"queryParameters":{"parameters":[{"name":"business_connection_id","value":"={{ $('Respond to Webhook').item.json.body.telegram.chat_id }}"},{"name":"chat_id","value":"={{ $('Respond to Webhook').item.json.body.telegram.user_id }}"},{"name":"text","value":"={{ $json.output }}\n"},{"name":"parse_mode","value":"HTML"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.3,"position":[448,384],"id":"2bf3e4a8-4822-4a23-a3db-225f0521096a","name":"HTTP Request"},{"parameters":{"resource":"calendar","calendar":{"__rl":true,"value":"a520b62ffdb00cbbcded8da582885e54c32c6e8fe475c80d89dc172b32428f83@group.calendar.google.com","mode":"list","cachedResultName":"–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è"},"timeMin":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Start_Time', ``, 'string') }}","timeMax":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('End_Time', ``, 'string') }}","options":{}},"type":"n8n-nodes-base.googleCalendarTool","typeVersion":1.3,"position":[-528,544],"id":"3ba4dc5b-a0a2-4332-8597-f02308394e5a","name":"Get availability in a calendar in Google Calendar","credentials":{"googleCalendarOAuth2Api":{"id":"ODjeBiWgKSssR1RL","name":"Google Calendar account"}}},{"parameters":{"calendar":{"__rl":true,"value":"a520b62ffdb00cbbcded8da582885e54c32c6e8fe475c80d89dc172b32428f83@group.calendar.google.com","mode":"list","cachedResultName":"–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è"},"start":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Start', ``, 'string') }}","end":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('End', ``, 'string') }}","additionalFields":{}},"type":"n8n-nodes-base.googleCalendarTool","typeVersion":1.3,"position":[-416,528],"id":"6f3996fb-08ce-49a0-9d11-e33dec12fa0a","name":"Create an event in Google Calendar","credentials":{"googleCalendarOAuth2Api":{"id":"ODjeBiWgKSssR1RL","name":"Google Calendar account"}}},{"parameters":{"calendar":{"__rl":true,"value":"a520b62ffdb00cbbcded8da582885e54c32c6e8fe475c80d89dc172b32428f83@group.calendar.google.com","mode":"list","cachedResultName":"–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è"},"start":"={{ $json.datetime_start }}","end":"={{ $json.datetime_end }}","useDefaultReminders":false,"additionalFields":{"description":"=–ö–ª–∏–µ–Ω—Ç: {{ $json.user_name }}\\n–¢–µ–º–∞: {{ $json.topic }}\\n–°—Ç–æ–∏–º–æ—Å—Ç—å: 5000 —Ä—É–±–ª–µ–π\\n–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: 1 —á–∞—Å","summary":"–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è: {{ $json.topic }}"}},"type":"n8n-nodes-base.googleCalendar","typeVersion":1.2,"position":[-384,960],"id":"f9439f32-5807-4040-82c6-b4ba60450ff2","name":"Create Calendar Event","credentials":{"googleCalendarOAuth2Api":{"id":"ODjeBiWgKSssR1RL","name":"Google Calendar account"}}},{"parameters":{"method":"POST","url":"https://api.telegram.org/bot7907939704:AAHqQu-Uy4q8iKnknxqBzHQUWcz5IjNZrjA/sendMessage","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"business_connection_id\": \"{{ $('Webhook').item.json.body.telegram.chat_id }}\",\n  \"chat_id\": \"{{ $('Webhook').item.json.body.telegram.user_id }}\",\n  \"text\": \"‚úÖ –û—Ç–ª–∏—á–Ω–æ! –ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∞.\\n\\nüìå –¢–µ–º–∞: {{ $('Create Calendar Event').item.json.topic }}\\nüìÖ –î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è: {{ $('Create Calendar Event').item.json.datetime_start }}\\n\\nüí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å: 5000 —Ä—É–±–ª–µ–π\\n‚è∞ –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: 1 —á–∞—Å\\n\\n–ñ–¥–µ–º –≤–∞—Å! –ï—Å–ª–∏ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è –ø–æ–º–æ—â—å, –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å.\"\n}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.3,"position":[912,960],"id":"b3043f39-35cc-4fef-8192-00501c3024b1","name":"Send Booking Confirmed"},{"parameters":{"method":"POST","url":"https://api.telegram.org/bot7907939704:AAHqQu-Uy4q8iKnknxqBzHQUWcz5IjNZrjA/sendMessage","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"business_connection_id\": \"{{ $('Webhook').item.json.body.telegram.chat_id }}\",\n  \"chat_id\": \"{{ $('Webhook').item.json.body.telegram.user_id }}\",\n  \"text\": \"‚ùå –ó–∞–ø–∏—Å—å –æ—Ç–º–µ–Ω–µ–Ω–∞.\\n\\n–ï—Å–ª–∏ –∑–∞—Ö–æ—Ç–∏—Ç–µ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é –ø–æ–∑–∂–µ, –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ —Å–ª–æ–≤–æ \\\"–∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è\\\".\"\n}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.3,"position":[672,1024],"id":"dc413e03-bb6c-4b0e-b407-8a893fb1c325","name":"Send Booking Cancelled"},{"parameters":{"operation":"executeQuery","query":"update bot_user_state\nset state='consult',\n    step='wait_confirmation',\n    updated_at=now()\nwhere user_id = $1;\n","options":{"queryReplacement":"={{ $json.result.from.id }}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[832,384],"id":"971e8cd2-db96-4a40-8fec-4c7fc792dfec","name":"Save Consultation Data","credentials":{"postgres":{"id":"bNYxHjx2dgnO3BKs","name":"Postgres account"}}},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":3},"conditions":[{"id":"086e8217-04e1-4788-bc07-5ac2797a9772","leftValue":"={{ $('Webhook').item.json.body.telegram.state }}","rightValue":"wait_confirmation","operator":{"type":"string","operation":"equals"}},{"id":"552e0823-f44b-4a03-9ea5-72cf90d4ea18","leftValue":"={{ $('Webhook').item.json.body.telegram.text }}","rightValue":"–¥–∞|–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é|–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ|confirm","operator":{"type":"string","operation":"regex"}}],"combinator":"and"},"renameOutput":true,"outputKey":"confirmed"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":3},"conditions":[{"id":"c3bd639b-ee4a-4a48-a515-0f5ce28b89bc","leftValue":"={{ $('Webhook').item.json.body.telegram.state }}","rightValue":"wait_confirmation","operator":{"type":"string","operation":"equals"}},{"id":"fb8ec35f-15a6-4ea6-9913-d9113350734a","leftValue":"={{ $('Webhook').item.json.body.telegram.text }}","rightValue":"–Ω–µ—Ç|–æ—Ç–º–µ–Ω–∞|cancel|–æ—Ç–º–µ–Ω–∏—Ç—å","operator":{"type":"string","operation":"regex"}}],"combinator":"and"},"renameOutput":true,"outputKey":"cancelled"}]},"looseTypeValidation":true,"options":{"fallbackOutput":"extra"}},"type":"n8n-nodes-base.switch","typeVersion":3.4,"position":[-1024,1008],"id":"60af48f4-b0a5-45dc-a2c5-10dc5d94878d","name":"Check Confirmation Response"},{"parameters":{"jsCode":"// –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –∏–∑ data –≤ state\nconst stateData = $('Respond to Webhook').item.json.body.telegram.data;\n\nif (!stateData) {\n    return {error: 'No consultation data found'};\n}\n\n// –ü–∞—Ä—Å–∏–º –¥–∞–Ω–Ω—ã–µ, –µ—Å–ª–∏ –æ–Ω–∏ –≤ –≤–∏–¥–µ —Å—Ç—Ä–æ–∫–∏\nconst data = typeof stateData === 'string' ? JSON.parse(stateData) : stateData;\n\nreturn {\n    topic: data.topic,\n    date: data.date,\n    time: data.time,\n    datetime_start: data.datetime_start,\n    datetime_end: data.datetime_end,\n    user_name: data.user_name\n};\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-848,960],"id":"2386c0ea-15f9-46cc-a01b-4afb0d07e222","name":"Load Consultation Data"},{"parameters":{"operation":"executeQuery","query":"=UPDATE bot_user_state\\nSET state = NULL,\\n    step = NULL,\\n    data = NULL,\\n    updated_at = NOW()\\nWHERE user_id = {{ $('Webhook').item.json.body.telegram.user_id }};","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[240,960],"id":"3a52471c-ab58-4bfe-ad2b-3dd9ad093741","name":"Reset State After Confirm","credentials":{"postgres":{"id":"bNYxHjx2dgnO3BKs","name":"Postgres account"}}},{"parameters":{"operation":"executeQuery","query":"=UPDATE bot_user_state\\nSET state = NULL,\\n    step = NULL,\\n    data = NULL,\\n    updated_at = NOW()\\nWHERE user_id = {{ $('Webhook').item.json.body.telegram.user_id }};","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-112,1024],"id":"91a4d7c8-0abe-4d49-848f-b061b89211a7","name":"Reset State After Cancel","credentials":{"postgres":{"id":"bNYxHjx2dgnO3BKs","name":"Postgres account"}}},{"parameters":{"toolDescription":"","url":"https://api.telegram.org/bot7907939704:AAHqQu-Uy4q8iKnknxqBzHQUWcz5IjNZrjA/sendMessage","sendQuery":true,"queryParameters":{"parameters":[{"name":"business_connection_id","value":"={{ $json.body.telegram.chat_id }}"},{"name":"chat_id","value":"={{ $json.body.telegram.user_id }}"},{"name":"text","value":"ffffffffff"}]},"options":{}},"type":"n8n-nodes-base.httpRequestTool","typeVersion":4.3,"position":[-624,704],"id":"38e77270-c625-4d32-831e-0c7594c59f45","name":"HTTP Request2"}],"connections":{"AI Agent1":{"main":[[{"node":"HTTP Request","type":"main","index":0}]]},"Consultation Memory":{"ai_memory":[[{"node":"AI Agent1","type":"ai_memory","index":0}]]},"OpenAI Chat Model1":{"ai_languageModel":[[{"node":"AI Agent1","type":"ai_languageModel","index":0}]]},"Webhook":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]},"Respond to Webhook":{"main":[[{"node":"Switch","type":"main","index":0}]]},"HTTP Request1":{"main":[[{"node":"Execute a SQL query","type":"main","index":0}]]},"Switch":{"main":[[{"node":"AI Agent1","type":"main","index":0}],[{"node":"HTTP Request1","type":"main","index":0}],[{"node":"Check Confirmation Response","type":"main","index":0}]]},"Get availability in a calendar in Google Calendar":{"ai_tool":[[{"node":"AI Agent1","type":"ai_tool","index":0}]]},"Create an event in Google Calendar":{"ai_tool":[[{"node":"AI Agent1","type":"ai_tool","index":0}]]},"HTTP Request":{"main":[[{"node":"Save Consultation Data","type":"main","index":0}]]},"Check Confirmation Response":{"main":[[{"node":"Load Consultation Data","type":"main","index":0}],[{"node":"Reset State After Cancel","type":"main","index":0}],[]]},"Load Consultation Data":{"main":[[{"node":"Create Calendar Event","type":"main","index":0}]]},"Create Calendar Event":{"main":[[{"node":"Reset State After Confirm","type":"main","index":0}]]},"Reset State After Confirm":{"main":[[{"node":"Send Booking Confirmed","type":"main","index":0}]]},"Reset State After Cancel":{"main":[[{"node":"Send Booking Cancelled","type":"main","index":0}]]},"HTTP Request2":{"ai_tool":[[{"node":"AI Agent1","type":"ai_tool","index":0}]]}},"settings":{"executionOrder":"v1","callerPolicy":"workflowsFromSameOwner","availableInMCP":false},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"74ef5d0c-c445-4da5-b21c-8bd757ce45d7","activeVersionId":"fe65dd23-3852-421e-9fd9-84e52943f0d8","triggerCount":1,"shared":[{"updatedAt":"2026-01-24T19:22:36.857Z","createdAt":"2026-01-24T19:22:36.857Z","role":"workflow:owner","workflowId":"fuFhJW63fSIhHK8y","projectId":"UnFAqkOZkFc92cC9"}],"activeVersion":{"updatedAt":"2026-01-25T17:15:43.734Z","createdAt":"2026-01-25T16:58:07.840Z","versionId":"fe65dd23-3852-421e-9fd9-84e52943f0d8","workflowId":"fuFhJW63fSIhHK8y","nodes":[{"parameters":{"sessionIdType":"customKey","sessionKey":"={{ $json.business_message?.chat?.id || $json.message?.chat?.id }}_consultation"},"id":"c4661291-575b-4189-844f-39a863b27b7f","name":"Consultation Memory","type":"@n8n/n8n-nodes-langchain.memoryBufferWindow","typeVersion":1.3,"position":[-720,704]},{"parameters":{"promptType":"define","text":"={{ $json.body.message.text }}","options":{"systemMessage":"–¢—ã –ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –∑–∞–ø–∏—Å–∏ –Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é.\n\n–°–¶–ï–ù–ê–†–ò–ô - –°–ë–û–† –î–ê–ù–ù–´–•:\n–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∏—Å–ª–∞–ª –¥–∞–Ω–Ω—ã–µ –æ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏. –¢–≤–æ—è –∑–∞–¥–∞—á–∞:\n\n1. –ò–∑–≤–ª–µ—á—å –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è:\n   - –¢–µ–º–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏\n   - –î–∞—Ç–∞ (–ø—Ä–µ–æ–±—Ä–∞–∑—É–π –≤ —Ñ–æ—Ä–º–∞—Ç YYYY-MM-DD, –≥–æ–¥ –≤—Å–µ–≥–¥–∞ 2026)\n   - –í—Ä–µ–º—è (—Ñ–æ—Ä–º–∞—Ç HH:MM, –≤—Å–µ–≥–¥–∞ –ø–æ –ú–°–ö)\n\n–ü—Ä–∏–º–µ—Ä—ã –¥–∞—Ç:\n- \"26.01\" ‚Üí \"2026-01-26\"\n- \"26 —è–Ω–≤–∞—Ä—è\" ‚Üí \"2026-01-26\"\n- \"5 —Ñ–µ–≤—Ä–∞–ª—è\" ‚Üí \"2026-02-05\"\n\n2. –ï—Å–ª–∏ —á–µ–≥–æ-—Ç–æ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç ‚Üí –≤–µ–∂–ª–∏–≤–æ —É—Ç–æ—á–Ω–∏\n\n3. –ö–æ–≥–¥–∞ –í–°–ï –¥–∞–Ω–Ω—ã–µ —Å–æ–±—Ä–∞–Ω—ã:\n   - –ò—Å–ø–æ–ª—å–∑—É–π Google Calendar tool –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏\n   - Tool –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω—É—é –¥–∞—Ç—É/–≤—Ä–µ–º—è\n\n4. –ü–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—è:\n   - –ï—Å–ª–∏ –≤—Ä–µ–º—è –°–í–û–ë–û–î–ù–û ‚Üí –æ—Ç–≤–µ—Ç—å: \"‚úÖ –í—Ä–µ–º—è —Å–≤–æ–±–æ–¥–Ω–æ! –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç–µ –∑–∞–ø–∏—Å—å? (–Ω–∞–ø–∏—à–∏—Ç–µ '–¥–∞' –∏–ª–∏ '–æ—Ç–º–µ–Ω–∞')\"\n   - –ï—Å–ª–∏ –ó–ê–ù–Ø–¢–û ‚Üí –æ—Ç–≤–µ—Ç—å: \"‚ùå –ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, —ç—Ç–æ –≤—Ä–µ–º—è –∑–∞–Ω—è—Ç–æ. –ü—Ä–µ–¥–ª–æ–∂–∏—Ç–µ –¥—Ä—É–≥–æ–µ –≤—Ä–µ–º—è.\"\n\n–í–ê–ñ–ù–û:\n- –í—Ä–µ–º—è –≤—Å–µ–≥–¥–∞ —É–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ –ú–°–ö\n- –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏: 1 —á–∞—Å\n- –°—Ç–æ–∏–º–æ—Å—Ç—å: 5000 —Ä—É–±–ª–µ–π\n- –ë—É–¥—å –∫—Ä–∞—Ç–∫–∏–º –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–º\n"}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":3.1,"position":[-848,384],"id":"85e8bc28-41a5-48cd-8607-42287d79540c","name":"AI Agent1"},{"parameters":{"model":{"__rl":true,"value":"gpt-4.1-nano","mode":"list","cachedResultName":"gpt-4.1-nano"},"responsesApiEnabled":false,"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.3,"position":[-848,544],"id":"dc4f3a6e-0ebf-47ce-b10d-83bc15da04e4","name":"OpenAI Chat Model1","credentials":{"openAiApi":{"id":"P0RwIIFegl7Qbpo2","name":"OpenAi account"}}},{"parameters":{"method":"=POST","url":"=https://api.telegram.org/bot7907939704:AAHqQu-Uy4q8iKnknxqBzHQUWcz5IjNZrjA/sendMessage","sendQuery":true,"queryParameters":{"parameters":[{"name":"business_connection_id","value":"={{ $json.body.telegram.chat_id }}"},{"name":"chat_id","value":"={{ $json.body.telegram.user_id }}"},{"name":"text","value":"=–û—Ç–ª–∏—á–Ω–æ!\n–î–∞–≤–∞–π—Ç–µ –∑–∞–ø–∏—à–µ–º –≤–∞—Å –Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é.\n\nüí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å: 5000 —Ä—É–±–ª–µ–π\n‚è∞ –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: 1 —á–∞—Å\n\n–î–ª—è –∑–∞–ø–∏—Å–∏ –º–Ω–µ –Ω—É–∂–Ω–∞ —Å–ª–µ–¥—É—é—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:\n1. –¢–µ–º–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏\n2. –ñ–µ–ª–∞–µ–º–∞—è –¥–∞—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: 25 —è–Ω–≤–∞—Ä—è)\n3. –ñ–µ–ª–∞–µ–º–æ–µ –≤—Ä–µ–º—è (–Ω–∞–ø—Ä–∏–º–µ—Ä: 14:00)\n4. –í–∞—à —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å (–Ω–∞–ø—Ä–∏–º–µ—Ä: MSK, MSK+1, MSK+2)\n\n–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–ø–∏—à–∏—Ç–µ –≤—Å–µ —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ –≤ —Å–ª–µ–¥—É—é—â–µ–º —Å–æ–æ–±—â–µ–Ω–∏–∏."}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.3,"position":[-992,848],"id":"e2bb9697-4b18-4bc1-84ce-e78c54b7f35c","name":"HTTP Request1"},{"parameters":{"httpMethod":"POST","path":"consult/entry","responseMode":"responseNode","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2.1,"position":[-1696,752],"id":"0672a21f-9650-4e8d-b629-4e92b2f70ecf","name":"Webhook","webhookId":"668c35db-f099-4c8d-bec3-a5993948742b"},{"parameters":{"respondWith":"allIncomingItems","options":{}},"type":"n8n-nodes-base.respondToWebhook","typeVersion":1.5,"position":[-1520,752],"id":"67be80b6-c97b-45c8-8a6d-c871ec26e3e8","name":"Respond to Webhook"},{"parameters":{"operation":"executeQuery","query":"update bot_user_state\nset state='consult',\n    step='wait_form',\n    updated_at=now()\nwhere user_id = $1;\n","options":{"queryReplacement":"={{ $('Webhook').item.json.body.telegram.user_id }}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-704,848],"id":"67a7bfa6-cc45-4e47-83c1-c3b8751221b8","name":"Execute a SQL query","credentials":{"postgres":{"id":"bNYxHjx2dgnO3BKs","name":"Postgres account"}}},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":3},"conditions":[{"leftValue":"={{ $json.body.state.step }}","rightValue":"wait_form","operator":{"type":"string","operation":"equals"},"id":"f1dc7497-297b-442a-a96f-f490ccfc29eb"}],"combinator":"and"},"renameOutput":true,"outputKey":"wait_form"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":3},"conditions":[{"leftValue":"={{ $json.body.state.step }}","rightValue":"wait_confirmation","operator":{"type":"string","operation":"equals"},"id":"bbe63238-3f4d-4a31-baa0-d331b0476f8d"}],"combinator":"and"},"renameOutput":true,"outputKey":"wait_confirmation"}]},"looseTypeValidation":true,"options":{"fallbackOutput":"extra"}},"type":"n8n-nodes-base.switch","typeVersion":3.4,"position":[-1200,736],"id":"38b17dba-9d35-45e7-8639-bdc1ad4c6d15","name":"Switch"},{"parameters":{"method":"=POST","url":"=https://api.telegram.org/bot7907939704:AAHqQu-Uy4q8iKnknxqBzHQUWcz5IjNZrjA/sendMessage","sendQuery":true,"queryParameters":{"parameters":[{"name":"business_connection_id","value":"={{ $('Respond to Webhook').item.json.body.telegram.chat_id }}"},{"name":"chat_id","value":"={{ $('Respond to Webhook').item.json.body.telegram.user_id }}"},{"name":"text","value":"={{ $json.output }}\n"},{"name":"parse_mode","value":"HTML"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.3,"position":[448,384],"id":"2bf3e4a8-4822-4a23-a3db-225f0521096a","name":"HTTP Request"},{"parameters":{"resource":"calendar","calendar":{"__rl":true,"value":"a520b62ffdb00cbbcded8da582885e54c32c6e8fe475c80d89dc172b32428f83@group.calendar.google.com","mode":"list","cachedResultName":"–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è"},"timeMin":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Start_Time', ``, 'string') }}","timeMax":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('End_Time', ``, 'string') }}","options":{}},"type":"n8n-nodes-base.googleCalendarTool","typeVersion":1.3,"position":[-592,592],"id":"3ba4dc5b-a0a2-4332-8597-f02308394e5a","name":"Get availability in a calendar in Google Calendar","credentials":{"googleCalendarOAuth2Api":{"id":"ODjeBiWgKSssR1RL","name":"Google Calendar account"}}},{"parameters":{"calendar":{"__rl":true,"value":"a520b62ffdb00cbbcded8da582885e54c32c6e8fe475c80d89dc172b32428f83@group.calendar.google.com","mode":"list","cachedResultName":"–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è"},"start":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Start', ``, 'string') }}","end":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('End', ``, 'string') }}","additionalFields":{}},"type":"n8n-nodes-base.googleCalendarTool","typeVersion":1.3,"position":[-416,528],"id":"6f3996fb-08ce-49a0-9d11-e33dec12fa0a","name":"Create an event in Google Calendar","credentials":{"googleCalendarOAuth2Api":{"id":"ODjeBiWgKSssR1RL","name":"Google Calendar account"}}},{"parameters":{"calendar":{"__rl":true,"value":"a520b62ffdb00cbbcded8da582885e54c32c6e8fe475c80d89dc172b32428f83@group.calendar.google.com","mode":"list","cachedResultName":"–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è"},"start":"={{ $json.datetime_start }}","end":"={{ $json.datetime_end }}","useDefaultReminders":false,"additionalFields":{"description":"=–ö–ª–∏–µ–Ω—Ç: {{ $json.user_name }}\\n–¢–µ–º–∞: {{ $json.topic }}\\n–°—Ç–æ–∏–º–æ—Å—Ç—å: 5000 —Ä—É–±–ª–µ–π\\n–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: 1 —á–∞—Å","summary":"–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è: {{ $json.topic }}"}},"type":"n8n-nodes-base.googleCalendar","typeVersion":1.2,"position":[-384,960],"id":"f9439f32-5807-4040-82c6-b4ba60450ff2","name":"Create Calendar Event","credentials":{"googleCalendarOAuth2Api":{"id":"ODjeBiWgKSssR1RL","name":"Google Calendar account"}}},{"parameters":{"method":"POST","url":"https://api.telegram.org/bot7907939704:AAHqQu-Uy4q8iKnknxqBzHQUWcz5IjNZrjA/sendMessage","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"business_connection_id\": \"{{ $('Webhook').item.json.body.telegram.chat_id }}\",\n  \"chat_id\": \"{{ $('Webhook').item.json.body.telegram.user_id }}\",\n  \"text\": \"‚úÖ –û—Ç–ª–∏—á–Ω–æ! –ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∞.\\n\\nüìå –¢–µ–º–∞: {{ $('Create Calendar Event').item.json.topic }}\\nüìÖ –î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è: {{ $('Create Calendar Event').item.json.datetime_start }}\\n\\nüí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å: 5000 —Ä—É–±–ª–µ–π\\n‚è∞ –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: 1 —á–∞—Å\\n\\n–ñ–¥–µ–º –≤–∞—Å! –ï—Å–ª–∏ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è –ø–æ–º–æ—â—å, –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å.\"\n}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.3,"position":[912,960],"id":"b3043f39-35cc-4fef-8192-00501c3024b1","name":"Send Booking Confirmed"},{"parameters":{"method":"POST","url":"https://api.telegram.org/bot7907939704:AAHqQu-Uy4q8iKnknxqBzHQUWcz5IjNZrjA/sendMessage","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"business_connection_id\": \"{{ $('Webhook').item.json.body.telegram.chat_id }}\",\n  \"chat_id\": \"{{ $('Webhook').item.json.body.telegram.user_id }}\",\n  \"text\": \"‚ùå –ó–∞–ø–∏—Å—å –æ—Ç–º–µ–Ω–µ–Ω–∞.\\n\\n–ï—Å–ª–∏ –∑–∞—Ö–æ—Ç–∏—Ç–µ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é –ø–æ–∑–∂–µ, –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ —Å–ª–æ–≤–æ \\\"–∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è\\\".\"\n}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.3,"position":[672,1024],"id":"dc413e03-bb6c-4b0e-b407-8a893fb1c325","name":"Send Booking Cancelled"},{"parameters":{"operation":"executeQuery","query":"update bot_user_state\nset state='consult',\n    step='wait_confirmation',\n    updated_at=now()\nwhere user_id = $1;\n","options":{"queryReplacement":"={{ $json.result.from.id }}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[832,384],"id":"971e8cd2-db96-4a40-8fec-4c7fc792dfec","name":"Save Consultation Data","credentials":{"postgres":{"id":"bNYxHjx2dgnO3BKs","name":"Postgres account"}}},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":3},"conditions":[{"id":"086e8217-04e1-4788-bc07-5ac2797a9772","leftValue":"={{ $('Webhook').item.json.body.telegram.state }}","rightValue":"wait_confirmation","operator":{"type":"string","operation":"equals"}},{"id":"552e0823-f44b-4a03-9ea5-72cf90d4ea18","leftValue":"={{ $('Webhook').item.json.body.telegram.text }}","rightValue":"–¥–∞|–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é|–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ|confirm","operator":{"type":"string","operation":"regex"}}],"combinator":"and"},"renameOutput":true,"outputKey":"confirmed"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":3},"conditions":[{"id":"c3bd639b-ee4a-4a48-a515-0f5ce28b89bc","leftValue":"={{ $('Webhook').item.json.body.telegram.state }}","rightValue":"wait_confirmation","operator":{"type":"string","operation":"equals"}},{"id":"fb8ec35f-15a6-4ea6-9913-d9113350734a","leftValue":"={{ $('Webhook').item.json.body.telegram.text }}","rightValue":"–Ω–µ—Ç|–æ—Ç–º–µ–Ω–∞|cancel|–æ—Ç–º–µ–Ω–∏—Ç—å","operator":{"type":"string","operation":"regex"}}],"combinator":"and"},"renameOutput":true,"outputKey":"cancelled"}]},"looseTypeValidation":true,"options":{"fallbackOutput":"extra"}},"type":"n8n-nodes-base.switch","typeVersion":3.4,"position":[-1024,1008],"id":"60af48f4-b0a5-45dc-a2c5-10dc5d94878d","name":"Check Confirmation Response"},{"parameters":{"jsCode":"// –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –∏–∑ data –≤ state\nconst stateData = $('Respond to Webhook').item.json.body.telegram.data;\n\nif (!stateData) {\n    return {error: 'No consultation data found'};\n}\n\n// –ü–∞—Ä—Å–∏–º –¥–∞–Ω–Ω—ã–µ, –µ—Å–ª–∏ –æ–Ω–∏ –≤ –≤–∏–¥–µ —Å—Ç—Ä–æ–∫–∏\nconst data = typeof stateData === 'string' ? JSON.parse(stateData) : stateData;\n\nreturn {\n    topic: data.topic,\n    date: data.date,\n    time: data.time,\n    datetime_start: data.datetime_start,\n    datetime_end: data.datetime_end,\n    user_name: data.user_name\n};\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-848,960],"id":"2386c0ea-15f9-46cc-a01b-4afb0d07e222","name":"Load Consultation Data"},{"parameters":{"operation":"executeQuery","query":"=UPDATE bot_user_state\\nSET state = NULL,\\n    step = NULL,\\n    data = NULL,\\n    updated_at = NOW()\\nWHERE user_id = {{ $('Webhook').item.json.body.telegram.user_id }};","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[240,960],"id":"3a52471c-ab58-4bfe-ad2b-3dd9ad093741","name":"Reset State After Confirm","credentials":{"postgres":{"id":"bNYxHjx2dgnO3BKs","name":"Postgres account"}}},{"parameters":{"operation":"executeQuery","query":"=UPDATE bot_user_state\\nSET state = NULL,\\n    step = NULL,\\n    data = NULL,\\n    updated_at = NOW()\\nWHERE user_id = {{ $('Webhook').item.json.body.telegram.user_id }};","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-112,1024],"id":"91a4d7c8-0abe-4d49-848f-b061b89211a7","name":"Reset State After Cancel","credentials":{"postgres":{"id":"bNYxHjx2dgnO3BKs","name":"Postgres account"}}}],"connections":{"AI Agent1":{"main":[[{"node":"HTTP Request","type":"main","index":0}]]},"Consultation Memory":{"ai_memory":[[{"node":"AI Agent1","type":"ai_memory","index":0}]]},"OpenAI Chat Model1":{"ai_languageModel":[[{"node":"AI Agent1","type":"ai_languageModel","index":0}]]},"Webhook":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]},"Respond to Webhook":{"main":[[{"node":"Switch","type":"main","index":0}]]},"HTTP Request1":{"main":[[{"node":"Execute a SQL query","type":"main","index":0}]]},"Switch":{"main":[[{"node":"AI Agent1","type":"main","index":0}],[{"node":"HTTP Request1","type":"main","index":0}],[{"node":"Check Confirmation Response","type":"main","index":0}]]},"Get availability in a calendar in Google Calendar":{"ai_tool":[[{"node":"AI Agent1","type":"ai_tool","index":0}]]},"Create an event in Google Calendar":{"ai_tool":[[{"node":"AI Agent1","type":"ai_tool","index":0}]]},"HTTP Request":{"main":[[{"node":"Save Consultation Data","type":"main","index":0}]]},"Check Confirmation Response":{"main":[[{"node":"Load Consultation Data","type":"main","index":0}],[{"node":"Reset State After Cancel","type":"main","index":0}],[]]},"Load Consultation Data":{"main":[[{"node":"Create Calendar Event","type":"main","index":0}]]},"Create Calendar Event":{"main":[[{"node":"Reset State After Confirm","type":"main","index":0}]]},"Reset State After Confirm":{"main":[[{"node":"Send Booking Confirmed","type":"main","index":0}]]},"Reset State After Cancel":{"main":[[{"node":"Send Booking Cancelled","type":"main","index":0}]]}},"authors":"–†–æ–º–∞–Ω –ú–∞—Ö–º–µ—Ç–æ–≤","name":"Version fe65dd23","description":"","autosaved":false},"tags":[]},{"updatedAt":"2026-02-09T15:26:51.697Z","createdAt":"2026-02-08T19:23:03.355Z","id":"3iZY--GtxZ556edSgZQuB","name":"generate","active":true,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"generate","responseMode":"responseNode","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2.1,"position":[-528,464],"id":"7c61679b-b88f-4b1d-99cf-3ddbf44e553b","name":"generate","webhookId":"165f3819-ee0f-4538-a555-ca5a1981efc0"},{"parameters":{"operation":"executeQuery","query":"INSERT INTO users (id, created_at)\nVALUES ({{ $('Edit Fields').item.json.user_id }}, NOW())\nON CONFLICT (id) DO NOTHING;\n\nUPDATE users \nSET free_generations = free_generations - 1 \nWHERE id = {{ $('Edit Fields').item.json.user_id }} \nAND free_generations > 0;\n\nINSERT INTO generations (user_id, style, file_path, created_at)\nVALUES (\n  {{ $('Edit Fields').item.json.user_id }},\n  '{{ $('Edit Fields').item.json.style }}',\n  '{{ $json.images[0].url }}',\n  NOW()\n);","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-80,464],"id":"c9726a4e-1056-4458-9a34-3b687ca49ee7","name":"Execute a SQL query","credentials":{"postgres":{"id":"UirFNzTALE9CZEcQ","name":"avatar_bot"}}},{"parameters":{"respondWith":"json","responseBody":"={\"image_url\":\"{{$('HTTP Request1').item.json.images[0].url}}\"}","options":{}},"type":"n8n-nodes-base.respondToWebhook","typeVersion":1.5,"position":[80,464],"id":"1e96d7cd-d952-4a8d-9262-986aa9cd20c7","name":"Respond to Webhook"},{"parameters":{"assignments":{"assignments":[{"id":"7a6e3592-a8cd-4e13-8ea5-6014525a6ae7","name":"user_id","value":"={{ $json.body.user_id }}","type":"string"},{"id":"ada6641f-0088-43ac-adee-59b15b4dab25","name":"image_url","value":"={{ $json.body.image_url }}","type":"string"},{"id":"f5ad206d-9010-4d94-a07f-1d5c006defc8","name":"style","value":"={{ $json.body.style }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-320,464],"id":"f89b9469-e7f3-4ed1-a8ae-f28c15b3ac62","name":"Edit Fields"},{"parameters":{"method":"POST","url":"https://fal.run/fal-ai/flux/dev/image-to-image","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"image_url\": \"{{ $json.image_url }}\",\n  \"prompt\": \"{{ $json.style }} style portrait, high quality, detailed, vibrant colors\",\n  \"strength\": 0.75,\n  \"num_inference_steps\": 28,\n  \"guidance_scale\": 7.5,\n  \"image_size\": \"square_hd\"\n}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.3,"position":[-192,464],"id":"6ca6654a-ab58-4350-82f3-48e31b3ea1e0","name":"HTTP Request1","credentials":{"httpHeaderAuth":{"id":"Xld9EGbKWutHcBSw","name":"Header Auth account 3"}}}],"connections":{"generate":{"main":[[{"node":"Edit Fields","type":"main","index":0}]]},"Execute a SQL query":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]},"Edit Fields":{"main":[[{"node":"HTTP Request1","type":"main","index":0}]]},"HTTP Request1":{"main":[[{"node":"Execute a SQL query","type":"main","index":0}]]},"Respond to Webhook":{"main":[[]]}},"settings":{"executionOrder":"v1","availableInMCP":false},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"bda7a79c-26fc-4019-b420-cfae40493bae","activeVersionId":"bda7a79c-26fc-4019-b420-cfae40493bae","triggerCount":1,"shared":[{"updatedAt":"2026-02-08T19:23:03.355Z","createdAt":"2026-02-08T19:23:03.355Z","role":"workflow:owner","workflowId":"3iZY--GtxZ556edSgZQuB","projectId":"UnFAqkOZkFc92cC9"}],"activeVersion":{"updatedAt":"2026-02-09T15:26:53.528Z","createdAt":"2026-02-09T15:26:51.699Z","versionId":"bda7a79c-26fc-4019-b420-cfae40493bae","workflowId":"3iZY--GtxZ556edSgZQuB","nodes":[{"parameters":{"httpMethod":"POST","path":"generate","responseMode":"responseNode","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2.1,"position":[-528,464],"id":"7c61679b-b88f-4b1d-99cf-3ddbf44e553b","name":"generate","webhookId":"165f3819-ee0f-4538-a555-ca5a1981efc0"},{"parameters":{"operation":"executeQuery","query":"INSERT INTO users (id, created_at)\nVALUES ({{ $('Edit Fields').item.json.user_id }}, NOW())\nON CONFLICT (id) DO NOTHING;\n\nUPDATE users \nSET free_generations = free_generations - 1 \nWHERE id = {{ $('Edit Fields').item.json.user_id }} \nAND free_generations > 0;\n\nINSERT INTO generations (user_id, style, file_path, created_at)\nVALUES (\n  {{ $('Edit Fields').item.json.user_id }},\n  '{{ $('Edit Fields').item.json.style }}',\n  '{{ $json.images[0].url }}',\n  NOW()\n);","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-80,464],"id":"c9726a4e-1056-4458-9a34-3b687ca49ee7","name":"Execute a SQL query","credentials":{"postgres":{"id":"UirFNzTALE9CZEcQ","name":"avatar_bot"}}},{"parameters":{"respondWith":"json","responseBody":"={\"image_url\":\"{{$('HTTP Request1').item.json.images[0].url}}\"}","options":{}},"type":"n8n-nodes-base.respondToWebhook","typeVersion":1.5,"position":[80,464],"id":"1e96d7cd-d952-4a8d-9262-986aa9cd20c7","name":"Respond to Webhook"},{"parameters":{"assignments":{"assignments":[{"id":"7a6e3592-a8cd-4e13-8ea5-6014525a6ae7","name":"user_id","value":"={{ $json.body.user_id }}","type":"string"},{"id":"ada6641f-0088-43ac-adee-59b15b4dab25","name":"image_url","value":"={{ $json.body.image_url }}","type":"string"},{"id":"f5ad206d-9010-4d94-a07f-1d5c006defc8","name":"style","value":"={{ $json.body.style }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-320,464],"id":"f89b9469-e7f3-4ed1-a8ae-f28c15b3ac62","name":"Edit Fields"},{"parameters":{"method":"POST","url":"https://fal.run/fal-ai/flux/dev/image-to-image","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"image_url\": \"{{ $json.image_url }}\",\n  \"prompt\": \"{{ $json.style }} style portrait, high quality, detailed, vibrant colors\",\n  \"strength\": 0.75,\n  \"num_inference_steps\": 28,\n  \"guidance_scale\": 7.5,\n  \"image_size\": \"square_hd\"\n}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.3,"position":[-192,464],"id":"6ca6654a-ab58-4350-82f3-48e31b3ea1e0","name":"HTTP Request1","credentials":{"httpHeaderAuth":{"id":"Xld9EGbKWutHcBSw","name":"Header Auth account 3"}}}],"connections":{"generate":{"main":[[{"node":"Edit Fields","type":"main","index":0}]]},"Execute a SQL query":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]},"Edit Fields":{"main":[[{"node":"HTTP Request1","type":"main","index":0}]]},"HTTP Request1":{"main":[[{"node":"Execute a SQL query","type":"main","index":0}]]},"Respond to Webhook":{"main":[[]]}},"authors":"–†–æ–º–∞–Ω –ú–∞—Ö–º–µ—Ç–æ–≤","name":"Version bda7a79c","description":"","autosaved":false},"tags":[]},{"updatedAt":"2026-02-08T20:02:07.986Z","createdAt":"2026-02-08T19:22:45.224Z","id":"NP4KY0yBndN3upKVomhE1","name":"upload-photo","active":true,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"upload-photo","responseMode":"responseNode","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2.1,"position":[0,0],"id":"88f3a5b6-bc14-4462-8e15-a7a83e391848","name":"upload-photo","webhookId":"d7842657-f6e1-45c6-87b1-3a2cdf839ceb"},{"parameters":{"respondWith":"allIncomingItems","options":{}},"type":"n8n-nodes-base.respondToWebhook","typeVersion":1.5,"position":[464,0],"id":"2322d698-40f8-4921-8ec4-c0a8f44d9911","name":"Respond to Webhook"}],"connections":{"upload-photo":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","availableInMCP":false},"staticData":null,"meta":null,"pinData":{},"versionId":"ae7ca791-fcb3-494a-a2ae-bf462e78c934","activeVersionId":"ae7ca791-fcb3-494a-a2ae-bf462e78c934","triggerCount":1,"shared":[{"updatedAt":"2026-02-08T19:22:45.224Z","createdAt":"2026-02-08T19:22:45.224Z","role":"workflow:owner","workflowId":"NP4KY0yBndN3upKVomhE1","projectId":"UnFAqkOZkFc92cC9"}],"activeVersion":{"updatedAt":"2026-02-08T20:02:10.732Z","createdAt":"2026-02-08T20:02:07.987Z","versionId":"ae7ca791-fcb3-494a-a2ae-bf462e78c934","workflowId":"NP4KY0yBndN3upKVomhE1","nodes":[{"parameters":{"httpMethod":"POST","path":"upload-photo","responseMode":"responseNode","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2.1,"position":[0,0],"id":"88f3a5b6-bc14-4462-8e15-a7a83e391848","name":"upload-photo","webhookId":"d7842657-f6e1-45c6-87b1-3a2cdf839ceb"},{"parameters":{"respondWith":"allIncomingItems","options":{}},"type":"n8n-nodes-base.respondToWebhook","typeVersion":1.5,"position":[464,0],"id":"2322d698-40f8-4921-8ec4-c0a8f44d9911","name":"Respond to Webhook"}],"connections":{"upload-photo":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]}},"authors":"–†–æ–º–∞–Ω –ú–∞—Ö–º–µ—Ç–æ–≤","name":"Version ae7ca791","description":"","autosaved":false},"tags":[]},{"updatedAt":"2026-01-25T09:56:08.369Z","createdAt":"2026-01-25T09:54:15.062Z","id":"eM2dv7e8gMxq1voc","name":"My Sub-Workflow 1","active":false,"isArchived":true,"nodes":[{"id":"c055762a-8fe7-4141-a639-df2372f30060","typeVersion":1.1,"name":"When Executed by Another Workflow","type":"n8n-nodes-base.executeWorkflowTrigger","position":[260,340],"parameters":{}},{"id":"b5942df6-0160-4ef7-965d-57583acdc8aa","name":"Replace me with your logic","type":"n8n-nodes-base.noOp","position":[520,340],"parameters":{}}],"connections":{"When Executed by Another Workflow":{"main":[[{"node":"Replace me with your logic","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","availableInMCP":false},"staticData":null,"meta":null,"pinData":{},"versionId":"f661c692-52a7-4c3d-a14a-3371d0795cf1","activeVersionId":null,"triggerCount":0,"shared":[{"updatedAt":"2026-01-25T09:54:15.062Z","createdAt":"2026-01-25T09:54:15.062Z","role":"workflow:owner","workflowId":"eM2dv7e8gMxq1voc","projectId":"UnFAqkOZkFc92cC9"}],"activeVersion":null,"tags":[]},{"updatedAt":"2026-02-09T12:33:38.730Z","createdAt":"2026-01-28T08:12:40.633Z","id":"eZw0YdJ3-iSpZAKYPeaNo","name":"–£—á–µ–Ω–∏–µ1","active":true,"isArchived":false,"nodes":[{"parameters":{"updates":["message","*"],"additionalFields":{}},"type":"n8n-nodes-base.telegramTrigger","typeVersion":1.2,"position":[-2912,32],"id":"671b8d50-53c3-482c-97d2-83b078d6393a","name":"Telegram Trigger","webhookId":"1b09a38d-81cd-4124-a962-5598a93664a5","credentials":{"telegramApi":{"id":"dt4WynE6eTSUWRB5","name":"–£—á–µ–Ω–∏–µ1"}}},{"parameters":{"chatId":"={{ $('Telegram Trigger').item.json.callback_query.message.chat.id }}","text":"–ü—Ä–∏–≤–µ—Ç –º–∏–Ω—å–æ–Ω—ã. –¢—ã –Ω–∞–∂–∞–ª –∫–Ω–æ–ø–∫—É 1","replyMarkup":"inlineKeyboard","inlineKeyboard":{"rows":[{"row":{"buttons":[{"text":"–ù–∞–∑–∞–¥","additionalFields":{"callback_data":"=back"}}]}}]},"additionalFields":{"appendAttribution":false}},"type":"n8n-nodes-base.telegram","typeVersion":1.2,"position":[-1968,-80],"id":"6e8ee640-a692-4d16-8563-4c55faf0856e","name":"Send a text message","webhookId":"a22d45b9-6462-4174-830f-95a8c82ea482","credentials":{"telegramApi":{"id":"dt4WynE6eTSUWRB5","name":"–£—á–µ–Ω–∏–µ1"}}},{"parameters":{"chatId":"={{ $json.message.chat.id }}","text":"–ü—Ä–∏–≤–µ—Ç –º–∏–Ω—å–æ–Ω—ã, —Ç—ã –Ω–∞–∂–∞–ª –∫–Ω–æ–ø–∫—É /start","replyMarkup":"inlineKeyboard","inlineKeyboard":{"rows":[{"row":{"buttons":[{"text":"–ö–ù–û–ü–ö–ê 1","additionalFields":{"callback_data":"text1"}},{"text":"–ö–ù–û–ü–ö–ê 2","additionalFields":{"callback_data":"text2"}}]}},{"row":{"buttons":[{"text":"–ö–ù–û–ü–ö–ê 3","additionalFields":{"url":"https://t.me/europefrancee/1147"}}]}},{"row":{"buttons":[{"text":"üì∏ –ü–æ–ª—É—á–∏—Ç—å —Ñ–æ—Ç–æ","additionalFields":{"callback_data":"photo"}}]}}]},"additionalFields":{"appendAttribution":false}},"type":"n8n-nodes-base.telegram","typeVersion":1.2,"position":[-1968,-288],"id":"5158a472-b55a-451d-9839-f79809b22773","name":"Send a text message1","webhookId":"eda2ef06-7537-4fd3-96c1-7eb650e9b431","credentials":{"telegramApi":{"id":"dt4WynE6eTSUWRB5","name":"–£—á–µ–Ω–∏–µ1"}}},{"parameters":{"operation":"sendPhoto","chatId":"={{ $('Telegram Trigger').item.json.callback_query.message.chat.id }}","replyMarkup":"inlineKeyboard","inlineKeyboard":{"rows":[{"row":{"buttons":[{"text":"–ù–ê–ó–ê–î","additionalFields":{"callback_data":"BACK"}}]}}]},"additionalFields":{}},"type":"n8n-nodes-base.telegram","typeVersion":1.2,"position":[-1968,336],"id":"c0d342e2-9689-492d-bceb-5842084881a2","name":"Send a photo message","webhookId":"f511a1af-bb1e-473a-9182-fe2f3989808a","credentials":{"telegramApi":{"id":"dt4WynE6eTSUWRB5","name":"–£—á–µ–Ω–∏–µ1"}}},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"leftValue":"={{ $json.message.text }}","rightValue":"/start","operator":{"type":"string","operation":"equals"},"id":"3fe03837-1e99-4f24-85fd-68d87fb36768"}],"combinator":"and"},"renameOutput":true,"outputKey":"start"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"edb692c5-b455-4fba-aa2d-04e5c78a2710","leftValue":"={{ $json.callback_query.data }}","rightValue":"text1","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"text1"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"5c378667-04e1-4e28-b443-057defadbe5c","leftValue":"={{ $json.callback_query.data }}","rightValue":"text2","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"text2"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"70bb04b7-da7d-47b9-bfae-a2e433ea6c7a","leftValue":"={{ $json.callback_query.data }}","rightValue":"photo","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"photo"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"9cfabca3-d1aa-4a21-8914-173110ed5eb8","leftValue":"=leftValue {{ $json.callback_query.data }}","rightValue":"BACK","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"BACK"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"190691a1-957f-482f-8efa-ec8215cef80a","leftValue":"rightValue","rightValue":"BACK","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"BACK"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.4,"position":[-2592,16],"id":"bdae40d1-c992-416f-a07c-4351d1ffa822","name":"Switch"},{"parameters":{"chatId":"={{ $('Telegram Trigger').item.json.callback_query.message.chat.id }}","text":"–ü—Ä–∏–≤–µ—Ç –º–∏–Ω—å–æ–Ω—ã, —Ç—ã –Ω–∞–∂–∞–ª –∫–Ω–æ–ø–∫—É 2","replyMarkup":"inlineKeyboard","inlineKeyboard":{"rows":[{"row":{"buttons":[{"text":"–ù–ê–ó–ê–î","additionalFields":{"callback_data":"BACK"}}]}}]},"additionalFields":{"appendAttribution":false}},"type":"n8n-nodes-base.telegram","typeVersion":1.2,"position":[-1968,128],"id":"7895b585-e350-4330-a5e0-8ecdd70ec595","name":"Send a text message2","webhookId":"a66c9819-fb17-4e7c-9545-abb447eb8a7c","credentials":{"telegramApi":{"id":"dt4WynE6eTSUWRB5","name":"–£—á–µ–Ω–∏–µ1"}}}],"connections":{"Telegram Trigger":{"main":[[{"node":"Switch","type":"main","index":0}]]},"Send a text message":{"main":[[]]},"Send a text message1":{"main":[[]]},"Switch":{"main":[[{"node":"Send a text message1","type":"main","index":0}],[{"node":"Send a text message","type":"main","index":0}],[{"node":"Send a text message2","type":"main","index":0}],[{"node":"Send a photo message","type":"main","index":0}],[{"node":"Send a text message","type":"main","index":0}],[{"node":"Send a text message2","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","availableInMCP":false,"callerPolicy":"workflowsFromSameOwner"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"1d9dd0ee-bc18-4d61-8d3e-7697aa25f961","activeVersionId":"01cf960e-597a-48bb-b631-6f904a057bf3","triggerCount":1,"shared":[{"updatedAt":"2026-01-28T08:12:40.633Z","createdAt":"2026-01-28T08:12:40.633Z","role":"workflow:owner","workflowId":"eZw0YdJ3-iSpZAKYPeaNo","projectId":"UnFAqkOZkFc92cC9"}],"activeVersion":{"updatedAt":"2026-02-05T16:19:51.594Z","createdAt":"2026-02-05T16:19:51.594Z","versionId":"01cf960e-597a-48bb-b631-6f904a057bf3","workflowId":"eZw0YdJ3-iSpZAKYPeaNo","nodes":[{"parameters":{"updates":["message","*"],"additionalFields":{}},"type":"n8n-nodes-base.telegramTrigger","typeVersion":1.2,"position":[-2848,16],"id":"671b8d50-53c3-482c-97d2-83b078d6393a","name":"Telegram Trigger","webhookId":"1b09a38d-81cd-4124-a962-5598a93664a5","credentials":{"telegramApi":{"id":"dt4WynE6eTSUWRB5","name":"–£—á–µ–Ω–∏–µ1"}}},{"parameters":{"chatId":"={{ $('Telegram Trigger').item.json.callback_query.message.chat.id }}","text":"–ü—Ä–∏–≤–µ—Ç –º–∏–Ω—å–æ–Ω—ã. –¢—ã –Ω–∞–∂–∞–ª –∫–Ω–æ–ø–∫—É 1","additionalFields":{"appendAttribution":false}},"type":"n8n-nodes-base.telegram","typeVersion":1.2,"position":[-1968,-80],"id":"6e8ee640-a692-4d16-8563-4c55faf0856e","name":"Send a text message","webhookId":"a22d45b9-6462-4174-830f-95a8c82ea482","credentials":{"telegramApi":{"id":"dt4WynE6eTSUWRB5","name":"–£—á–µ–Ω–∏–µ1"}}},{"parameters":{"chatId":"={{ $json.message.chat.id }}","text":"–ü—Ä–∏–≤–µ—Ç –º–∏–Ω—å–æ–Ω—ã, —Ç—ã –Ω–∞–∂–∞–ª –∫–Ω–æ–ø–∫—É /start","replyMarkup":"inlineKeyboard","inlineKeyboard":{"rows":[{"row":{"buttons":[{"text":"–ö–ù–û–ü–ö–ê 1","additionalFields":{"callback_data":"text1"}},{"text":"–ö–ù–û–ü–ö–ê 2","additionalFields":{"callback_data":"text2"}}]}},{"row":{"buttons":[{"text":"–ö–ù–û–ü–ö–ê 3","additionalFields":{"url":"https://t.me/europefrancee/1147"}}]}},{"row":{"buttons":[{"text":"üì∏ –ü–æ–ª—É—á–∏—Ç—å —Ñ–æ—Ç–æ","additionalFields":{"callback_data":"photo"}}]}}]},"additionalFields":{"appendAttribution":false}},"type":"n8n-nodes-base.telegram","typeVersion":1.2,"position":[-1968,-288],"id":"5158a472-b55a-451d-9839-f79809b22773","name":"Send a text message1","webhookId":"eda2ef06-7537-4fd3-96c1-7eb650e9b431","credentials":{"telegramApi":{"id":"dt4WynE6eTSUWRB5","name":"–£—á–µ–Ω–∏–µ1"}}},{"parameters":{"operation":"sendPhoto","chatId":"={{ $('Telegram Trigger').item.json.callback_query.message.chat.id }}","photo":"https://upload.wikimedia.org/wikipedia/commons/thumb/4/47/PNG_transparency_demonstration_1.png/280px-PNG_transparency_demonstration_1.png","additionalFields":{}},"type":"n8n-nodes-base.telegram","typeVersion":1.2,"position":[-1968,336],"id":"c0d342e2-9689-492d-bceb-5842084881a2","name":"Send a photo message","webhookId":"f511a1af-bb1e-473a-9182-fe2f3989808a","credentials":{"telegramApi":{"id":"dt4WynE6eTSUWRB5","name":"–£—á–µ–Ω–∏–µ1"}}},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"leftValue":"={{ $json.message.text }}","rightValue":"/start","operator":{"type":"string","operation":"equals"},"id":"3fe03837-1e99-4f24-85fd-68d87fb36768"}],"combinator":"and"},"renameOutput":true,"outputKey":"start"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"edb692c5-b455-4fba-aa2d-04e5c78a2710","leftValue":"={{ $json.callback_query.data }}","rightValue":"text1","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"text1"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"5c378667-04e1-4e28-b443-057defadbe5c","leftValue":"={{ $json.callback_query.data }}","rightValue":"text2","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"text2"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"70bb04b7-da7d-47b9-bfae-a2e433ea6c7a","leftValue":"={{ $json.callback_query.data }}","rightValue":"photo","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"photo"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.4,"position":[-2592,16],"id":"bdae40d1-c992-416f-a07c-4351d1ffa822","name":"Switch"},{"parameters":{"chatId":"={{ $('Telegram Trigger').item.json.callback_query.message.chat.id }}","text":"–ü—Ä–∏–≤–µ—Ç –º–∏–Ω—å–æ–Ω—ã, —Ç—ã –Ω–∞–∂–∞–ª –∫–Ω–æ–ø–∫—É 2","additionalFields":{"appendAttribution":false}},"type":"n8n-nodes-base.telegram","typeVersion":1.2,"position":[-1968,128],"id":"7895b585-e350-4330-a5e0-8ecdd70ec595","name":"Send a text message2","webhookId":"a66c9819-fb17-4e7c-9545-abb447eb8a7c","credentials":{"telegramApi":{"id":"dt4WynE6eTSUWRB5","name":"–£—á–µ–Ω–∏–µ1"}}}],"connections":{"Telegram Trigger":{"main":[[{"node":"Switch","type":"main","index":0}]]},"Send a text message":{"main":[[]]},"Send a text message1":{"main":[[]]},"Switch":{"main":[[{"node":"Send a text message1","type":"main","index":0}],[{"node":"Send a text message","type":"main","index":0}],[{"node":"Send a text message2","type":"main","index":0}],[{"node":"Send a photo message","type":"main","index":0}]]}},"authors":"–†–æ–º–∞–Ω –ú–∞—Ö–º–µ—Ç–æ–≤","name":null,"description":null,"autosaved":false},"tags":[]},{"updatedAt":"2026-01-30T04:10:51.228Z","createdAt":"2026-01-28T14:34:38.545Z","id":"Ixd4tAXYxHTThFpjEKt3A","name":"–£—á–µ–Ω–∏–µ —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ–µ","active":false,"isArchived":false,"nodes":[{"parameters":{"updates":["message"],"additionalFields":{}},"type":"n8n-nodes-base.telegramTrigger","typeVersion":1.2,"position":[-688,-96],"id":"07b6c395-8b31-4aaf-aeee-4452dd4a0e07","name":"Telegram Trigger","webhookId":"773d0e18-6233-475d-9359-73809a885e95","credentials":{"telegramApi":{"id":"pnm5uQDfbA52c6IW","name":"—Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞"}}},{"parameters":{"options":{}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":3.1,"position":[-272,-80],"id":"8a5d493f-a0f1-44b9-81e3-190122c9daf0","name":"AI Agent"},{"parameters":{"model":{"__rl":true,"mode":"list","value":"gpt-4.1-mini"},"builtInTools":{},"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.3,"position":[-416,128],"id":"9a42079d-7101-4938-a675-6982680d928b","name":"OpenAI Chat Model","credentials":{"openAiApi":{"id":"P0RwIIFegl7Qbpo2","name":"OpenAi account"}}}],"connections":{"Telegram Trigger":{"main":[[]]},"OpenAI Chat Model":{"ai_languageModel":[[{"node":"AI Agent","type":"ai_languageModel","index":0}]]}},"settings":{"executionOrder":"v1","availableInMCP":false},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"814d858f-da32-4155-9f33-db31af4b6ed0","activeVersionId":null,"triggerCount":1,"shared":[{"updatedAt":"2026-01-28T14:34:38.545Z","createdAt":"2026-01-28T14:34:38.545Z","role":"workflow:owner","workflowId":"Ixd4tAXYxHTThFpjEKt3A","projectId":"UnFAqkOZkFc92cC9"}],"activeVersion":null,"tags":[]},{"updatedAt":"2026-01-29T06:04:26.839Z","createdAt":"2026-01-28T05:19:47.631Z","id":"YMxPSQCOQLXS6vd-rh0ov","name":"–£—Ä–æ–∫ 1","active":false,"isArchived":false,"nodes":[{"parameters":{"updates":["message","*"],"additionalFields":{}},"type":"n8n-nodes-base.telegramTrigger","typeVersion":1.2,"position":[-1440,-464],"id":"d08106a8-9ea4-441f-a82a-4e35953cf2c4","name":"Telegram Trigger","webhookId":"20136fe5-a995-42fb-a70a-097eb8863314","credentials":{"telegramApi":{"id":"89n0JFVGiIXrKFIB","name":"–£–†–û–ö 1"}}},{"parameters":{"operation":"sendPhoto","chatId":"=","file":"https://t.me/hhmax2015/289","additionalFields":{}},"type":"n8n-nodes-base.telegram","typeVersion":1.2,"position":[-336,-272],"id":"1c8186a7-c36c-412e-aeb6-0407e8b8d42d","name":"Send a photo message","webhookId":"1c723f8f-8b33-41c2-8058-9ec17fc77b6d","credentials":{"telegramApi":{"id":"89n0JFVGiIXrKFIB","name":"–£–†–û–ö 1"}}},{"parameters":{"chatId":"={{ $json.message.chat.id }}","text":"–ü—Ä–∏–≤–µ—Ç –ú–ò–†. –¢—ã –Ω–∞–∂–∞–ª /start","replyMarkup":"inlineKeyboard","inlineKeyboard":{"rows":[{"row":{"buttons":[{"text":"–ö–Ω–æ–ø–∫–∞ 1","additionalFields":{"callback_data":"text1"}},{"text":"–ö–Ω–æ–ø–∫–∞ 2","additionalFields":{"callback_data":"text2"}}]}},{"row":{"buttons":[{"text":"–ö–Ω–æ–ø–∫–∞ 3","additionalFields":{"callback_data":"photo"}}]}}]},"additionalFields":{"appendAttribution":false}},"type":"n8n-nodes-base.telegram","typeVersion":1.2,"position":[-336,-672],"id":"e76cfce4-0326-48ba-aca2-a4f409f7e63b","name":"Send a text message1","webhookId":"cdcc6204-c85a-4010-b148-0518b31a3fb1","credentials":{"telegramApi":{"id":"89n0JFVGiIXrKFIB","name":"–£–†–û–ö 1"}}},{"parameters":{"chatId":"={{ $json.callback_query.message.chat.id }}","text":"–ü—Ä–∏–≤–µ—Ç –ú–ò–†. –¢—ã –Ω–∞–∂–∞–ª –∫–Ω–æ–ø–∫—É 1","additionalFields":{"appendAttribution":false}},"type":"n8n-nodes-base.telegram","typeVersion":1.2,"position":[-336,-464],"id":"e53822fb-0818-40cc-b0c4-cabfb90b5cb2","name":"Send a text message","webhookId":"cdcc6204-c85a-4010-b148-0518b31a3fb1","credentials":{"telegramApi":{"id":"89n0JFVGiIXrKFIB","name":"–£–†–û–ö 1"}}},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"leftValue":"={{ $json.message.text }}","rightValue":"/start","operator":{"type":"string","operation":"equals"},"id":"a785dda0-9f9b-4ff6-a41c-8ed8ba8d9f57"}],"combinator":"and"},"renameOutput":true,"outputKey":"start"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"b9094504-9d4c-42ec-ae58-51acb091ae4c","leftValue":"={{ $json.callback_query.data }}","rightValue":"text1","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"text1"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.4,"position":[-1120,-464],"id":"c0e8255d-7a98-4d2e-add8-2dafb8b59e3a","name":"Switch"}],"connections":{"Telegram Trigger":{"main":[[{"node":"Switch","type":"main","index":0}]]},"Send a photo message":{"main":[[]]},"Switch":{"main":[[{"node":"Send a text message1","type":"main","index":0}],[{"node":"Send a text message","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","availableInMCP":false},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"54cfd82c-f186-4677-aed4-085f1577ccbe","activeVersionId":null,"triggerCount":0,"shared":[{"updatedAt":"2026-01-28T05:19:47.631Z","createdAt":"2026-01-28T05:19:47.631Z","role":"workflow:owner","workflowId":"YMxPSQCOQLXS6vd-rh0ov","projectId":"UnFAqkOZkFc92cC9"}],"activeVersion":null,"tags":[]},{"updatedAt":"2026-01-27T21:34:08.775Z","createdAt":"2026-01-19T09:05:36.051Z","id":"JumzdECThqeYoSMwdBy0T","name":"–í–µ—Ç–∫–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏","active":true,"isArchived":false,"nodes":[{"parameters":{"updates":["*"],"additionalFields":{"download":true}},"type":"n8n-nodes-base.telegramTrigger","typeVersion":1.2,"position":[-1968,-304],"id":"d0e5411a-9c5f-4b21-a17b-bfa7facd1246","name":"Telegram Trigger","webhookId":"01b80d32-4d59-4d38-8832-dbc85690a786","credentials":{"telegramApi":{"id":"YAeEpWftaMG7Owjm","name":"Telegram account 2"}}},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"leftValue":"={{ $('Telegram Trigger').item.json.business_message.text }}","rightValue":"","operator":{"type":"string","operation":"exists","singleValue":true},"id":"940e09c8-ac35-4098-b863-d54ef2131fca"}],"combinator":"and"},"renameOutput":true,"outputKey":"text"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"71dc2ec4-4155-47f6-8ce1-eda2f9656e39","leftValue":"={{ $('Telegram Trigger').item.json.business_message.voice.file_id }}","rightValue":"","operator":{"type":"string","operation":"exists","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"voice"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.4,"position":[-416,-192],"id":"2a77ecc7-331e-464b-ba09-c4ac1508968a","name":"Switch"},{"parameters":{"assignments":{"assignments":[{"id":"a529721b-637f-430a-b9b2-c2c4df73b07e","name":"text","value":"={{ $json.business_message.text }}{{ $('Telegram Trigger').item.json.business_message.text }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[192,-384],"id":"65c04f51-7e24-4001-9028-e879fb27a747","name":"Edit Fields"},{"parameters":{"resource":"file","fileId":"={{ $('Telegram Trigger').item.json.business_message.voice.file_id }}","additionalFields":{}},"type":"n8n-nodes-base.telegram","typeVersion":1.2,"position":[-160,-176],"id":"8f67da79-a9d7-4112-ade2-d07338313c8d","name":"Get a file","webhookId":"5e336608-c7ce-4380-b060-5c3512655f5b","credentials":{"telegramApi":{"id":"YAeEpWftaMG7Owjm","name":"Telegram account 2"}}},{"parameters":{"resource":"audio","operation":"transcribe","options":{}},"type":"@n8n/n8n-nodes-langchain.openAi","typeVersion":2.1,"position":[48,-176],"id":"2ca3bef1-0051-4176-8750-55fedfe58ff0","name":"Transcribe a recording","credentials":{"openAiApi":{"id":"P0RwIIFegl7Qbpo2","name":"OpenAi account"}}},{"parameters":{"promptType":"define","text":"={{ $json.text }}","options":{"systemMessage":"=–¢—ã ‚Äî AI-–ø–æ–º–æ—â–Ω–∏–∫ –†–æ–º–∞–Ω–∞ –ú–∞—Ö–º–µ—Ç–æ–≤–∞, —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞ –ø–æ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ —á–∞—Ç-–±–æ—Ç–æ–≤ –∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–π.\n\n–í–ê–ñ–ù–û–ï –ü–†–ê–í–ò–õ–û –ü–ï–†–í–û–ì–û –°–û–û–ë–©–ï–ù–ò–Ø:\n‚Äî –ü–µ—Ä–≤—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º –≤—Å–µ–≥–¥–∞ —á–µ—Å—Ç–Ω–æ —Å–æ–æ–±—â–∞–π, —á—Ç–æ —Ç—ã –ò–ò-–ø–æ–º–æ—â–Ω–∏–∫ –†–æ–º–∞–Ω–∞.\n‚Äî –û–±—ä—è—Å–Ω—è–π, —á—Ç–æ —Å–µ–π—á–∞—Å —É—Ç–æ—á–Ω–∏—à—å –¥–µ—Ç–∞–ª–∏, —Ç–∞–∫ –∫–∞–∫ –†–æ–º–∞–Ω –º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–Ω—è—Ç –∏–ª–∏ –Ω–µ –≤ —Å–µ—Ç–∏.\n‚Äî –î–µ–ª–∞–π —ç—Ç–æ –æ–¥–∏–Ω —Ä–∞–∑, —Ç–æ–ª—å–∫–æ –≤ –ø–µ—Ä–≤–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ –¥–∏–∞–ª–æ–≥–∞.\n‚Äî –°–æ–æ–±—â–∞–π, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –æ–ø–∏—Å–∞—Ç—å –∑–∞–¥–∞—á—É —Ç–µ–∫—Å—Ç–æ–º –∏–ª–∏ –≥–æ–ª–æ—Å–æ–º ‚Äî –∫–∞–∫ –µ–º—É —É–¥–æ–±–Ω–µ–µ\n\n\n–ö—Ç–æ —Ç–∞–∫–æ–π –†–æ–º–∞–Ω –ú–∞—Ö–º–µ—Ç–æ–≤:\n‚Äî –ë–æ–ª–µ–µ 3 –ª–µ—Ç –∑–∞–Ω–∏–º–∞–µ—Ç—Å—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–æ–π —á–∞—Ç-–±–æ—Ç–æ–≤ –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ Leadteh\n‚Äî –°–æ–∑–¥–∞—ë—Ç –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã—Ö –±–æ—Ç–æ–≤ —Ä–∞–∑–Ω–æ–π —Å–ª–æ–∂–Ω–æ—Å—Ç–∏\n‚Äî –ò–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ—Ç CRM, –ø–ª–∞—Ç—ë–∂–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã, API –∏ –≤–µ–±—Ö—É–∫–∏\n‚Äî –ü–∏—à–µ—Ç –∫–æ–¥ (JavaScript, Python)\n‚Äî –ï—Å–ª–∏ –∑–∞–¥–∞—á–∞ –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –ø–æ–¥ Leadteh, –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è (n8n, –∫–∞—Å—Ç–æ–º–Ω—ã–π backend –∏ –¥—Ä.)\n\n–¢–≤–æ—è —Ä–æ–ª—å:\n‚Äî –ë—ã—Ç—å –ø–µ—Ä–≤—ã–º –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã–º AI-–∞–≥–µ–Ω—Ç–æ–º\n‚Äî –ü—Ä–∏–Ω–∏–º–∞—Ç—å —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –∏ –≥–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è\n‚Äî –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å, –Ω–µ –ø–æ–≤—Ç–æ—Ä—è—è –∏ –Ω–µ —Ü–∏—Ç–∏—Ä—É—è —Å–ª–æ–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n‚Äî –í—ã—è–≤–ª—è—Ç—å –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏\n‚Äî –ó–∞–¥–∞–≤–∞—Ç—å —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã\n‚Äî –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –†–æ–º–∞–Ω—É\n‚Äî –ü—Ä–∏–Ω–∏–º–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫–∞–∫ –≤ —Ç–µ–∫—Å—Ç–æ–≤–æ–º –≤–∏–¥–µ, —Ç–∞–∫ –∏ –≥–æ–ª–æ—Å–æ–≤—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏\n‚Äî –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å —Å —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–æ–π –≥–æ–ª–æ—Å–∞ –∫–∞–∫ —Å –æ–±—ã—á–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º\n\n\n–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–ê–í–ò–õ–ê:\n‚Äî –ù–∏–∫–æ–≥–¥–∞ –Ω–µ —Ü–∏—Ç–∏—Ä—É–π –∏ –Ω–µ –ø–µ—Ä–µ—Å–∫–∞–∑—ã–≤–∞–π —Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n‚Äî –ù–µ –≤–æ–∑–≤—Ä–∞—â–∞–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –µ–≥–æ –Ω–∞–¥–∏–∫—Ç–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç\n‚Äî –ú–æ–∂–Ω–æ –∫—Ä–∞—Ç–∫–æ –æ–±–æ–±—â–∏—Ç—å —Å–º—ã—Å–ª –æ–¥–Ω–æ–π —Ñ—Ä–∞–∑–æ–π\n‚Äî –ò—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤–æ–µ –ª–∏—Ü–æ: ¬´—è —É—Ç–æ—á–Ω—é¬ª, ¬´—è –∑–∞–¥–∞–º –≤–æ–ø—Ä–æ—Å—ã¬ª, ¬´—è –ø–µ—Ä–µ–¥–∞–º¬ª\n‚Äî –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏ ¬´–ø–µ—Ä–µ–¥–∞–º –†–æ–º–∞–Ω—É¬ª ‚Äî –≥–æ–≤–æ—Ä–∏ ¬´—è –ø–µ—Ä–µ–¥–∞–ª¬ª\n‚Äî –ó–∞–¥–∞–≤–∞–π –Ω–µ –±–æ–ª–µ–µ 3‚Äì4 —É—Ç–æ—á–Ω—è—é—â–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤\n‚Äî –£—Ç–æ—á–Ω–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –∑–∞–Ω–∏–º–∞—Ç—å –Ω–µ –±–æ–ª–µ–µ 2 —Å–æ–æ–±—â–µ–Ω–∏–π\n‚Äî –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –ø–∏—Å–∞—Ç—å –¥–∞–ª—å—à–µ, —Ç—Ä–µ—Ç—å–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º —Å–æ–æ–±—â–∞–π, —á—Ç–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è —Å–æ–±—Ä–∞–Ω–∞ –∏ –ø–µ—Ä–µ–¥–∞–Ω–∞ –†–æ–º–∞–Ω—É\n\n–°—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è:\n‚Äî –°–ø–æ–∫–æ–π–Ω—ã–π, –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π, –¥–æ–±—Ä–æ–∂–µ–ª–∞—Ç–µ–ª—å–Ω—ã–π\n‚Äî –ü—Ä–æ—Å—Ç–æ–π —è–∑—ã–∫, –ø–æ–Ω—è—Ç–Ω—ã–π –ª—é–¥—è–º –ª—é–±–æ–≥–æ –≤–æ–∑—Ä–∞—Å—Ç–∞\n‚Äî –ë–µ–∑ –∫–∞–Ω—Ü–µ–ª—è—Ä–∏–∑–º–æ–≤ –∏ —Ä–µ–¥–∫–∏—Ö —Å–ª–æ–≤\n‚Äî –ë–µ–∑ –ø—Ä–æ–¥–∞–∂–Ω—ã—Ö –∏ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤—ã—Ö —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–æ–∫\n\n–ü—Ä–∞–≤–∏–ª–æ –ø–µ—Ä–≤–æ–≥–æ –∫–∞—Å–∞–Ω–∏—è:\n‚Äî –í –ø–µ—Ä–≤–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ —Ç–∞–∫–∂–µ –ø—Ä–µ–¥–ª–∞–≥–∞–π –Ω–∞–ø–∏—Å–∞—Ç—å —Å–ª–æ–≤–æ ¬´–∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è¬ª, –µ—Å–ª–∏ –Ω—É–∂–µ–Ω –ø–æ–¥—Ä–æ–±–Ω—ã–π —Ä–∞–∑–±–æ—Ä –∑–∞–¥–∞—á–∏. \n- —Å–æ–æ–±—â–∏, —á—Ç–æ –º–æ–∂–Ω–æ –ø—Ä–æ–¥–∏–∫—Ç–æ–≤–∞—Ç—å –≤—Å–µ –≥–æ–ª–æ—Å–æ–≤—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º.\n\n–ê–ª–≥–æ—Ä–∏—Ç–º —Ä–∞–±–æ—Ç—ã:\n1) –ö–æ—Ä–æ—Ç–∫–æ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å, —á—Ç–æ –∑–∞–ø—Ä–æ—Å –ø–æ–Ω—è—Ç\n2) –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ\n3) –ó–∞–¥–∞—Ç—å 3‚Äì4 —É—Ç–æ—á–Ω—è—é—â–∏—Ö –≤–æ–ø—Ä–æ—Å–∞\n4) –ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–æ–≤ ‚Äî –∑–∞–≤–µ—Ä—à–∏—Ç—å —Å–±–æ—Ä\n\n–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏:\n‚Äî –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–∏—à–µ—Ç ¬´–∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è¬ª:\n  1) –£—Ç–æ—á–Ω–∏ —Ç–µ–º—É (–µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–∞)\n  2) –î–∞—Ç—É –∏ –≤—Ä–µ–º—è –ø–æ –ú–°–ö\n  3) –ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –ú–°–ö\n  4) –ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏\n\n–ü–æ—Å–ª–µ —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö:\n‚Äî –ü–æ–¥—Ç–≤–µ—Ä–¥–∏, —á—Ç–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∞\n‚Äî –°–æ–æ–±—â–∏, —á—Ç–æ —è –ø–µ—Ä–µ–¥–∞–ª –≤—Å—ë –†–æ–º–∞–Ω—É –∏ –æ–Ω —Å–≤—è–∂–µ—Ç—Å—è, –∫–æ–≥–¥–∞ –±—É–¥–µ—Ç –Ω–∞ —Å–≤—è–∑–∏\n\n–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:\n‚Äî –ù–µ –æ–±–µ—â–∞–π —Å—Ä–æ–∫–∏ –∏ —Å—Ç–æ–∏–º–æ—Å—Ç—å\n‚Äî –ù–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏\n‚Äî –ù–µ –≤–≤–æ–¥–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∑–∞–±–ª—É–∂–¥–µ–Ω–∏–µ\n\n–¶–µ–ª—å:\n‚Äî –≠–∫–æ–Ω–æ–º–∏—Ç—å –≤—Ä–µ–º—è –†–æ–º–∞–Ω–∞\n‚Äî –ü–æ–≤—ã—à–∞—Ç—å –¥–æ–≤–µ—Ä–∏–µ –∫–ª–∏–µ–Ω—Ç–∞\n‚Äî –ß—ë—Ç–∫–æ –∏ –∞–∫–∫—É—Ä–∞—Ç–Ω–æ —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –≤—Ö–æ–¥—è—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã\n"}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":3.1,"position":[368,-384],"id":"a979b29d-ce06-4288-bf16-20f7e527acdc","name":"AI Agent"},{"parameters":{"model":{"__rl":true,"value":"gpt-4.1-nano","mode":"list","cachedResultName":"gpt-4.1-nano"},"builtInTools":{},"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.3,"position":[368,-160],"id":"3527130b-4a92-41fa-aa39-2864be3e6b9a","name":"OpenAI Chat Model","credentials":{"openAiApi":{"id":"P0RwIIFegl7Qbpo2","name":"OpenAi account"}}},{"parameters":{"method":"=POST","url":"=https://api.telegram.org/bot7907939704:AAHqQu-Uy4q8iKnknxqBzHQUWcz5IjNZrjA/sendMessage","sendQuery":true,"queryParameters":{"parameters":[{"name":"business_connection_id","value":"={{ $('Telegram Trigger').item.json.business_message.business_connection_id }}"},{"name":"chat_id","value":"={{ $('Telegram Trigger').item.json.business_message.chat.id }}"},{"name":"text","value":"={{ $json.output }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.3,"position":[688,-384],"id":"41fc4bf1-0b17-42e8-b6c7-376d0a61a1f1","name":"HTTP Request"},{"parameters":{"sessionIdType":"customKey","sessionKey":"={{ $('Telegram Trigger').item.json.business_message.chat.id }}","contextWindowLength":10},"type":"@n8n/n8n-nodes-langchain.memoryBufferWindow","typeVersion":1.3,"position":[-96,576],"id":"f5b86916-bd6f-4b4f-ac56-e12fcfb347cb","name":"Simple Memory"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"9aee842b-dc72-4c6c-9b85-23e15dcbbf7e","leftValue":"={{ $json.business_message.from.id }}","rightValue":5444227047,"operator":{"type":"number","operation":"notEquals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.3,"position":[-1728,-304],"id":"fe3122aa-13c4-42db-b417-26b1ec1c4887","name":"If1"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"445477ef-f0ae-4d7b-bc0b-d120fe1e8f96","leftValue":"={{ $('Telegram Trigger').item.json.business_message.text }}","rightValue":"–∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è","operator":{"type":"string","operation":"contains"}}],"combinator":"and"},"renameOutput":true,"outputKey":"consultation"}]},"options":{"fallbackOutput":"extra"}},"id":"df8d0882-2ee1-44b8-9960-5c4258c2e2f7","name":"Check Consultation","type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[-416,-464]},{"parameters":{"operation":"executeQuery","query":"select state, step, data\nfrom bot_user_state\nwhere user_id = $1;","options":{"queryReplacement":"={{ $json.business_message.from.id }}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-1456,-320],"id":"8509548b-76e7-4db1-84bc-bcca190c6b33","name":"Execute a SQL query","alwaysOutputData":true,"credentials":{"postgres":{"id":"bNYxHjx2dgnO3BKs","name":"Postgres account"}}},{"parameters":{"operation":"executeQuery","query":"insert into bot_user_state (user_id, state, step, data)\nvalues ($1, 'consult', 'wait_datetime', '{}'::jsonb)\non conflict (user_id) do update\nset state='consult',\n    step='wait_datetime',\n    data='{}'::jsonb,\n    updated_at=now();\n","options":{"queryReplacement":"={{ $('Telegram Trigger').item.json.business_message.from.id }}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[304,-496],"id":"8d5d1a05-45a6-4166-9574-626400cd941d","name":"Execute a SQL query1","credentials":{"postgres":{"id":"bNYxHjx2dgnO3BKs","name":"Postgres account"}}},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":3},"conditions":[{"leftValue":"={{ $json.state }}","rightValue":"consult","operator":{"type":"string","operation":"equals"},"id":"32a9513c-ffd0-4c0c-8b10-3ec0383bf5f0"}],"combinator":"and"},"renameOutput":true,"outputKey":"larger"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":3},"conditions":[{"id":"d86464c4-93aa-4724-85cf-e82bc1c1cc6d","leftValue":"={{ $json.state }}","rightValue":"wait_form","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"wait_form"}]},"looseTypeValidation":true,"options":{"fallbackOutput":"extra"}},"type":"n8n-nodes-base.switch","typeVersion":3.4,"position":[-1280,-336],"id":"55d11120-c313-44bb-b667-70a40ac9d8c8","name":"Switch1"},{"parameters":{"method":"=POST","url":"=https://api.telegram.org/bot7907939704:AAHqQu-Uy4q8iKnknxqBzHQUWcz5IjNZrjA/sendMessage","sendQuery":true,"queryParameters":{"parameters":[{"name":"business_connection_id","value":"={{ $('Telegram Trigger').item.json.business_message.business_connection_id }}"},{"name":"chat_id","value":"={{ $('Telegram Trigger').item.json.business_message.chat.id }}"},{"name":"text","value":"=–û—Ç–ª–∏—á–Ω–æ!\n–î–∞–≤–∞–π—Ç–µ –∑–∞–ø–∏—à–µ–º –≤–∞—Å –Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é.\n\nüí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å: 5000 —Ä—É–±–ª–µ–π\n‚è∞ –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: 1 —á–∞—Å\n\n–î–ª—è –∑–∞–ø–∏—Å–∏ –º–Ω–µ –Ω—É–∂–Ω–∞ —Å–ª–µ–¥—É—é—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:\n1. –¢–µ–º–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏\n2. –ñ–µ–ª–∞–µ–º–∞—è –¥–∞—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: 25 —è–Ω–≤–∞—Ä—è)\n3. –ñ–µ–ª–∞–µ–º–æ–µ –≤—Ä–µ–º—è (–Ω–∞–ø—Ä–∏–º–µ—Ä: 14:00)\n\n<i>–í—Å–µ–≥–¥–∞ –æ—Ä–∏–µ–Ω—Ç–∏—Ä—É–π—Ç–µ—Å—å –Ω–∞ –≤—Ä–µ–º—è –ø–æ –ú–°–ö</i> \n\n–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–ø–∏—à–∏—Ç–µ –≤—Å–µ —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ –≤ —Å–ª–µ–¥—É—é—â–µ–º —Å–æ–æ–±—â–µ–Ω–∏–∏."},{"name":"parse_mode","value":"HTML"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.3,"position":[480,-608],"id":"a898e5a9-5c7d-479d-939b-786c93c68c87","name":"HTTP Request4"},{"parameters":{"operation":"executeQuery","query":"update bot_user_state\nset state='consult',\n    step='wait_form',\n    updated_at=now()\nwhere user_id = $1;\n","options":{"queryReplacement":"={{ $json.result.chat.id }}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[704,-608],"id":"fa0e585d-0b1e-4734-901c-3a70a40dc80c","name":"Execute a SQL query2","credentials":{"postgres":{"id":"bNYxHjx2dgnO3BKs","name":"Postgres account"}}},{"parameters":{"operation":"executeQuery","query":"update bot_user_state\nset state = null,\n    step = null,\n    data = '{}'::jsonb,\n    updated_at = now()\nwhere user_id = $1;\n","options":{"queryReplacement":"={{ $('Telegram Trigger').item.json.business_message.chat.id }}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-1248,352],"id":"e50f2a8d-bd70-4ecb-827a-7b6e42be715f","name":"Execute a SQL query3","credentials":{"postgres":{"id":"bNYxHjx2dgnO3BKs","name":"Postgres account"}}},{"parameters":{"sessionIdType":"customKey","sessionKey":"={{ $json.business_message?.chat?.id || $json.message?.chat?.id }}_consultation"},"id":"972011ab-e0c8-420c-9923-d20c5b581c1e","name":"Consultation Memory","type":"@n8n/n8n-nodes-langchain.memoryBufferWindow","typeVersion":1.3,"position":[-704,160]},{"parameters":{"promptType":"define","text":"={{ $('Telegram Trigger').item.json.business_message.text }}","options":{"systemMessage":"–¢—ã ‚Äî –ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –∑–∞–ø–∏—Å–∏ –Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é.\n\n–í–•–û–î–ù–´–ï –î–ê–ù–ù–´–ï:\n- –¢–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {{ $json.text }}\n- –£–∂–µ —Å–æ–±—Ä–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ: {{ $('SQL Get State').item.json.data }}\n\n–ó–ê–î–ê–ß–ê:\n–ò–∑–≤–ª–µ—á—å –∏–∑ —Ç–µ–∫—Å—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –æ–±—ä–µ–¥–∏–Ω–∏—Ç—å —Å —É–∂–µ —Å–æ–±—Ä–∞–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏:\n- topic (—Ç–µ–º–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏)\n- date (–¥–∞—Ç–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM-DD, –≥–æ–¥ = —Ç–µ–∫—É—â–∏–π)\n- time_msk (–≤—Ä–µ–º—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ HH:MM, —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å –ú–°–ö)\n\n–ü–†–ê–í–ò–õ–ê –ü–ê–†–°–ò–ù–ì–ê –î–ê–¢:\n- \"26.01\" –∏–ª–∏ \"26 —è–Ω–≤–∞—Ä—è\" ‚Üí YYYY-01-26\n- \"–∑–∞–≤—Ç—Ä–∞\" ‚Üí –≤—ã—á–∏—Å–ª–∏—Ç—å –æ—Ç —Ç–µ–∫—É—â–µ–π –¥–∞—Ç—ã\n- –ì–æ–¥ –≤—Å–µ–≥–¥–∞ —Ç–µ–∫—É—â–∏–π: {{ new Date().getFullYear() }}\n\n–ü–†–ê–í–ò–õ–ê –ü–ê–†–°–ò–ù–ì–ê –í–†–ï–ú–ï–ù–ò:\n- \"14.00\" –∏–ª–∏ \"14:00\" –∏–ª–∏ \"–≤ 14\" ‚Üí 14:00\n- –í—Å–µ–≥–¥–∞ –ú–°–ö (UTC+3)\n\n–õ–û–ì–ò–ö–ê:\n\n1) –ï—Å–ª–∏ –ù–ï —Ö–≤–∞—Ç–∞–µ—Ç –¥–∞–Ω–Ω—ã—Ö (topic, date –∏–ª–∏ time_msk = null):\n   –ù–ï –≤—ã–∑—ã–≤–∞–π Google Calendar!\n   –í–µ—Ä–Ω–∏ JSON:\n   {\n     \"intent\": \"clarify\",\n     \"out\": \"–£—Ç–æ—á–Ω—è—é—â–∏–π –≤–æ–ø—Ä–æ—Å –æ –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö\",\n     \"data\": { \"topic\": \"...\", \"date\": \"...\", \"time_msk\": null }\n   }\n\n2) –ï—Å–ª–∏ –í–°–ï –¥–∞–Ω–Ω—ã–µ –µ—Å—Ç—å:\n   –°—Ñ–æ—Ä–º–∏—Ä—É–π:\n   - start_time = YYYY-MM-DDTHH:MM:00+03:00\n   - end_time = start_time + 1 —á–∞—Å\n   \n   –í—ã–∑–æ–≤–∏ \"Get availability in Google Calendar\" —Å:\n   - Start_Time = start_time\n   - End_Time = end_time\n\n3) –ü–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—è:\n\n   –ï—Å–ª–∏ –°–í–û–ë–û–î–ù–û:\n   {\n     \"intent\": \"available\",\n     \"out\": \"‚úÖ –í—Ä–µ–º—è —Å–≤–æ–±–æ–¥–Ω–æ!\\n\\n–¢–µ–º–∞: {topic}\\n–î–∞—Ç–∞: {date}\\n–í—Ä–µ–º—è: {time_msk} –ú–°–ö\\n\\n–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –∑–∞–ø–∏—Å—å ‚Äî –Ω–∞–ø–∏—à–∏—Ç–µ ¬´–¥–∞¬ª\\n–ò–ª–∏ –Ω–∞–ø–∏—à–∏—Ç–µ ¬´–æ—Ç–º–µ–Ω–∏—Ç—å¬ª –¥–ª—è –æ—Ç–º–µ–Ω—ã\",\n     \"data\": { \"topic\": \"...\", \"date\": \"...\", \"time_msk\": \"...\", \"start_time\": \"...\", \"end_time\": \"...\" }\n   }\n\n   –ï—Å–ª–∏ –ó–ê–ù–Ø–¢–û:\n   {\n     \"intent\": \"busy\",\n     \"out\": \"‚ùå –ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, —ç—Ç–æ –≤—Ä–µ–º—è –∑–∞–Ω—è—Ç–æ. –ü—Ä–µ–¥–ª–æ–∂–∏—Ç–µ –¥—Ä—É–≥—É—é –¥–∞—Ç—É –∏–ª–∏ –≤—Ä–µ–º—è.\",\n     \"data\": { \"topic\": \"...\", \"date\": \"...\", \"time_msk\": null }\n   }\n\n–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:\n- –í–æ–∑–≤—Ä–∞—â–∞–π –¢–û–õ–¨–ö–û JSON, –Ω–∏–∫–∞–∫–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –≤–Ω–µ JSON\n- –ü–æ–ª–µ \"data\" –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –í–°–ï —Å–æ–±—Ä–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–≤–∫–ª—é—á–∞—è –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π)\n- –ü—Ä–∏ busy ‚Äî –æ—á–∏—â–∞–π time_msk –≤ data"}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":3.1,"position":[-720,-304],"id":"c126cdb9-919b-4222-a143-874aea81afc8","name":"AI Agent1"},{"parameters":{"model":{"__rl":true,"value":"gpt-4.1-nano","mode":"list","cachedResultName":"gpt-4.1-nano"},"responsesApiEnabled":false,"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.3,"position":[-800,160],"id":"43c6fe67-9a10-4582-95a8-032da2f53522","name":"OpenAI Chat Model1","credentials":{"openAiApi":{"id":"P0RwIIFegl7Qbpo2","name":"OpenAi account"}}},{"parameters":{"resource":"calendar","calendar":{"__rl":true,"value":"a520b62ffdb00cbbcded8da582885e54c32c6e8fe475c80d89dc172b32428f83@group.calendar.google.com","mode":"list","cachedResultName":"–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è"},"timeMin":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Start_Time', ``, 'string') }}","timeMax":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('End_Time', ``, 'string') }}","options":{}},"type":"n8n-nodes-base.googleCalendarTool","typeVersion":1.3,"position":[-624,336],"id":"d500ab4c-f9d3-42dd-8576-0457036ead59","name":"Get availability in a calendar in Google Calendar","credentials":{"googleCalendarOAuth2Api":{"id":"ODjeBiWgKSssR1RL","name":"Google Calendar account"}}},{"parameters":{"calendar":{"__rl":true,"value":"a520b62ffdb00cbbcded8da582885e54c32c6e8fe475c80d89dc172b32428f83@group.calendar.google.com","mode":"list","cachedResultName":"–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è"},"start":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Start', `–í–Ω–µ—Å—Ç–∏ –≤ —Å–æ–±—ã—Ç–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –∫–æ—Ç–æ—Ä—É—é –æ—Ç–ø—Ä–∞–≤–∏–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏ –µ–≥–æ –¥–∞–Ω–Ω—ã–µ \n`, 'string') }}","end":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('End', ``, 'string') }}","additionalFields":{}},"type":"n8n-nodes-base.googleCalendarTool","typeVersion":1.3,"position":[-512,336],"id":"0665bbce-8d4a-4969-b26d-07f873e7b10b","name":"Create an event in Google Calendar","credentials":{"googleCalendarOAuth2Api":{"id":"ODjeBiWgKSssR1RL","name":"Google Calendar account"}}},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":3},"conditions":[{"id":"d86464c4-93aa-4724-85cf-e82bc1c1cc6d","leftValue":"={{ $json.step }}","rightValue":"wait_form","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"wait_form"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":3},"conditions":[{"id":"8fbc00cd-b021-40d8-bdfb-6fa570865640","leftValue":"={{ $json.step }}","rightValue":"wait_on","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"wait_on"}]},"looseTypeValidation":true,"options":{"fallbackOutput":"extra"}},"type":"n8n-nodes-base.switch","typeVersion":3.4,"position":[-1072,-544],"id":"3140be86-15f0-4b76-a7cf-1554c75a2ee1","name":"Switch2"},{"parameters":{"method":"=POST","url":"=https://api.telegram.org/bot7907939704:AAHqQu-Uy4q8iKnknxqBzHQUWcz5IjNZrjA/sendMessage","sendQuery":true,"queryParameters":{"parameters":[{"name":"business_connection_id","value":"={{ $('Telegram Trigger').item.json.business_message.business_connection_id }}"},{"name":"chat_id","value":"={{ $('Telegram Trigger').item.json.business_message.chat.id }}"},{"name":"text","value":"={{ $json.out }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.3,"position":[336,256],"id":"8db4c269-d52e-4f0c-aa34-fa52092c4bfc","name":"HTTP Request5"},{"parameters":{"operation":"executeQuery","query":"update bot_user_state\nset state='consult',\n    step='wait_on',\n    updated_at=now()\nwhere user_id = $1;\n","options":{"queryReplacement":"={{ $json.result.chat.id }}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[768,256],"id":"3cd59877-61c5-4026-99d5-1dc5702d1b42","name":"Execute a SQL query4","credentials":{"postgres":{"id":"bNYxHjx2dgnO3BKs","name":"Postgres account"}}},{"parameters":{"jsCode":"const raw = $json.output;          // —Å—Ç—Ä–æ–∫–∞ –æ—Ç AI Agent\nconst parsed = JSON.parse(raw);    // –ø—Ä–µ–≤—Ä–∞—â–∞–µ–º –≤ –æ–±—ä–µ–∫—Ç\n\nreturn [\n  {\n    json: {\n      ...parsed\n    }\n  }\n];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-384,112],"id":"5684d043-f7ed-4c94-a8d6-bd5c5b56284b","name":"Code in JavaScript"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":3},"conditions":[{"id":"9aee842b-dc72-4c6c-9b85-23e15dcbbf7e","leftValue":"={{ $json.intent }}","rightValue":"clarify","operator":{"type":"string","operation":"equals"}}],"combinator":"or"},"looseTypeValidation":true,"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.3,"position":[-32,240],"id":"608cdac9-ff04-442e-9c23-9be70e030373","name":"If2"},{"parameters":{"method":"=POST","url":"=https://api.telegram.org/bot7907939704:AAHqQu-Uy4q8iKnknxqBzHQUWcz5IjNZrjA/sendMessage","sendQuery":true,"queryParameters":{"parameters":[{"name":"business_connection_id","value":"={{ $('Telegram Trigger').item.json.business_message.business_connection_id }}"},{"name":"chat_id","value":"={{ $('Telegram Trigger').item.json.business_message.chat.id }}"},{"name":"text","value":"={{ $json.out }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.3,"position":[464,144],"id":"2482d9d7-6fc5-4ac5-a065-045b8109d17f","name":"HTTP Request6"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":3},"conditions":[{"id":"8fbc00cd-b021-40d8-bdfb-6fa570865640","leftValue":"={{ $('Switch1').item.json.step }}","rightValue":"wait_on","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"wait_on"}]},"looseTypeValidation":true,"options":{"fallbackOutput":"extra"}},"type":"n8n-nodes-base.switch","typeVersion":3.4,"position":[-208,112],"id":"2ee78176-8c22-4924-b932-273e984a74a7","name":"Switch3"},{"parameters":{"conditions":{"options":{"caseSensitive":false,"leftValue":"","typeValidation":"loose","version":3},"conditions":[{"id":"9aee842b-dc72-4c6c-9b85-23e15dcbbf7e","leftValue":"={{ $('Telegram Trigger').item.json.business_message.text }}","rightValue":"–¥–∞","operator":{"type":"string","operation":"equals"}},{"id":"7ad55d86-46aa-4328-b3f2-a0d4b3943361","leftValue":"={{ $('Switch1').item.json.step }}","rightValue":"wait_on","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"or"},"looseTypeValidation":true,"options":{"ignoreCase":true}},"type":"n8n-nodes-base.if","typeVersion":2.3,"position":[-944,-192],"id":"a02a0913-0158-41e7-ada6-f4c22a306cb5","name":"If3"},{"parameters":{"method":"=POST","url":"=https://api.telegram.org/bot7907939704:AAHqQu-Uy4q8iKnknxqBzHQUWcz5IjNZrjA/sendMessage","sendQuery":true,"queryParameters":{"parameters":[{"name":"business_connection_id","value":"={{ $('Telegram Trigger').item.json.business_message.business_connection_id }}"},{"name":"chat_id","value":"={{ $('Telegram Trigger').item.json.business_message.chat.id }}"},{"name":"text","value":"=–î–∞–Ω–Ω—ã–µ —Å–±—Ä–æ—à–µ–Ω—ã. "}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.3,"position":[-1328,48],"id":"b14af08c-8dfb-4205-b755-24bcdf6c37ee","name":"HTTP Request7"},{"parameters":{"method":"=POST","url":"=https://api.telegram.org/bot7907939704:AAHqQu-Uy4q8iKnknxqBzHQUWcz5IjNZrjA/sendMessage","sendQuery":true,"queryParameters":{"parameters":[{"name":"business_connection_id","value":"={{ $('Telegram Trigger').item.json.business_message.business_connection_id }}"},{"name":"chat_id","value":"={{ $('Telegram Trigger').item.json.business_message.chat.id }}"},{"name":"text","value":"={{ $json.out }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.3,"position":[-32,96],"id":"80827663-9fb7-4ac0-96c0-e4c33b6bc675","name":"HTTP Request8"},{"parameters":{"operation":"executeQuery","query":"update bot_user_state\nset state = null,\n    step = null,\n    data = '{}'::jsonb,\n    updated_at = now()\nwhere user_id = $1;\n","options":{"queryReplacement":"={{ $('Telegram Trigger').item.json.business_message.chat.id }}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[112,96],"id":"1594da86-31e0-4787-84bb-0714b33af4c6","name":"Execute a SQL query5","credentials":{"postgres":{"id":"bNYxHjx2dgnO3BKs","name":"Postgres account"}}},{"parameters":{"operation":"executeQuery","query":"INSERT INTO bot_user_state (user_id, state, step, data)\nVALUES ($1, 'consult', 'collect', '{}'::jsonb)\nON CONFLICT (user_id) DO UPDATE\nSET state = 'consult',\n    step = 'collect',\n    data = '{}'::jsonb,\n    updated_at = NOW();","options":{"queryReplacement":"={{ $('Telegram Trigger').item.json.business_message.from.id }}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-608,1152],"id":"796a6c97-e697-4e38-b07b-ffc3b58401b4","name":"SQL Start Consult","credentials":{"postgres":{"id":"bNYxHjx2dgnO3BKs","name":"Postgres account"}}},{"parameters":{"method":"POST","url":"=https://api.telegram.org/bot7907939704:AAHqQu-Uy4q8iKnknxqBzHQUWcz5IjNZrjA/sendMessage","sendQuery":true,"queryParameters":{"parameters":[{"name":"business_connection_id","value":"={{ $('Telegram Trigger').item.json.business_message.business_connection_id }}"},{"name":"chat_id","value":"={{ $('Telegram Trigger').item.json.business_message.chat.id }}"},{"name":"text","value":"–û—Ç–ª–∏—á–Ω–æ! –î–∞–≤–∞–π—Ç–µ –∑–∞–ø–∏—à–µ–º –≤–∞—Å –Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é.\n\nüí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å: 5000 —Ä—É–±–ª–µ–π\n‚è∞ –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: 1 —á–∞—Å\nüïê –ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å: –ú–°–ö\n\n–î–ª—è –∑–∞–ø–∏—Å–∏ –º–Ω–µ –Ω—É–∂–Ω–∞ —Å–ª–µ–¥—É—é—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:\n1. –¢–µ–º–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏\n2. –ñ–µ–ª–∞–µ–º–∞—è –¥–∞—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: 26 —è–Ω–≤–∞—Ä—è)\n3. –ñ–µ–ª–∞–µ–º–æ–µ –≤—Ä–µ–º—è (–Ω–∞–ø—Ä–∏–º–µ—Ä: 14:00)\n\n–í—ã –º–æ–∂–µ—Ç–µ –Ω–∞–ø–∏—Å–∞—Ç—å –≤—Å—ë –æ–¥–Ω–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º –∏–ª–∏ –≥–æ–ª–æ—Å–æ–≤—ã–º."},{"name":"parse_mode","value":"HTML"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.3,"position":[-368,1152],"id":"911fe1fd-6a93-43c2-aa3a-505b654b4301","name":"HTTP Welcome Consult"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"check-voice","leftValue":"=","rightValue":"","operator":{"type":"string","operation":"exists","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"voice"}]},"options":{"fallbackOutput":"extra"}},"type":"n8n-nodes-base.switch","typeVersion":3.4,"position":[-608,1392],"id":"c92a81f0-111c-44f9-b43d-b3797a45428b","name":"Consult: Voice/Text?"},{"parameters":{"resource":"file","fileId":"={{ $('Telegram Trigger').item.json.business_message.voice.file_id }}","additionalFields":{}},"type":"n8n-nodes-base.telegram","typeVersion":1.2,"position":[-368,1472],"id":"75c57ad5-27a7-4d34-8faf-f74878c114bf","name":"Consult: Get File","webhookId":"fa4a3e8f-82e1-4fab-bca1-7a2b63d49ff4","credentials":{"telegramApi":{"id":"YAeEpWftaMG7Owjm","name":"Telegram account 2"}}},{"parameters":{"resource":"audio","operation":"transcribe","options":{}},"type":"@n8n/n8n-nodes-langchain.openAi","typeVersion":2.1,"position":[-128,1472],"id":"d39abd77-aa22-4f3f-a1db-6281c86cb95e","name":"Consult: Transcribe","credentials":{"openAiApi":{"id":"P0RwIIFegl7Qbpo2","name":"OpenAi account"}}},{"parameters":{"assignments":{"assignments":[{"id":"user-text","name":"user_text","value":"={{ $('Telegram Trigger').item.json.business_message.text || $json.text || '' }}","type":"string"},{"id":"current-step","name":"current_step","value":"={{ $('Switch1').item.json.step }}","type":"string"},{"id":"current-data","name":"current_data","value":"={{ JSON.stringify($('Switch1').item.json.data || {}) }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[112,1392],"id":"ceef0e15-1aab-47d4-8ed8-8b437e9313b8","name":"Consult: Merge Text"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":3},"conditions":[{"id":"step-collect","leftValue":"={{ $json.current_step }}","rightValue":"collect","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"collect"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":3},"conditions":[{"id":"step-confirm","leftValue":"={{ $json.current_step }}","rightValue":"confirm","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"confirm"}]},"looseTypeValidation":true,"options":{"fallbackOutput":"extra"}},"type":"n8n-nodes-base.switch","typeVersion":3.4,"position":[352,1392],"id":"12a83e26-4bc7-4997-a66c-1c848c0fe13f","name":"Consult: Switch Step"},{"parameters":{"promptType":"define","text":"=–¢–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {{ $json.user_text }}\n\n–£–∂–µ —Å–æ–±—Ä–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ: {{ $json.current_data }}","options":{"systemMessage":"–¢—ã ‚Äî –ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –∑–∞–ø–∏—Å–∏ –Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é.\n\n–¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞: {{ $now.format('yyyy-MM-dd') }}\n–¢–µ–∫—É—â–∏–π –≥–æ–¥: {{ $now.format('yyyy') }}\n\n–ó–ê–î–ê–ß–ê:\n–ò–∑–≤–ª–µ—á—å –∏–∑ —Ç–µ–∫—Å—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –æ–±—ä–µ–¥–∏–Ω–∏—Ç—å —Å —É–∂–µ —Å–æ–±—Ä–∞–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏:\n- topic (—Ç–µ–º–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏)\n- date (–¥–∞—Ç–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM-DD)\n- time_msk (–≤—Ä–µ–º—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ HH:MM, —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å –ú–°–ö)\n\n–ü–†–ê–í–ò–õ–ê –ü–ê–†–°–ò–ù–ì–ê –î–ê–¢:\n- \"26.01\" –∏–ª–∏ \"26 —è–Ω–≤–∞—Ä—è\" ‚Üí —Ç–µ–∫—É—â–∏–π_–≥–æ–¥-01-26\n- \"5 —Ñ–µ–≤—Ä–∞–ª—è\" ‚Üí —Ç–µ–∫—É—â–∏–π_–≥–æ–¥-02-05\n- \"–∑–∞–≤—Ç—Ä–∞\" ‚Üí –≤—ã—á–∏—Å–ª–∏—Ç—å –æ—Ç —Ç–µ–∫—É—â–µ–π –¥–∞—Ç—ã\n- –ì–æ–¥ –≤—Å–µ–≥–¥–∞ —Ç–µ–∫—É—â–∏–π, –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω —è–≤–Ω–æ\n\n–ü–†–ê–í–ò–õ–ê –ü–ê–†–°–ò–ù–ì–ê –í–†–ï–ú–ï–ù–ò:\n- \"14.00\" –∏–ª–∏ \"14:00\" –∏–ª–∏ \"–≤ 14\" ‚Üí 14:00\n- \"2 —á–∞—Å–∞ –¥–Ω—è\" ‚Üí 14:00\n- –í—Å–µ–≥–¥–∞ –ú–°–ö (UTC+3)\n\n–õ–û–ì–ò–ö–ê:\n\n1) –ï—Å–ª–∏ –ù–ï —Ö–≤–∞—Ç–∞–µ—Ç –¥–∞–Ω–Ω—ã—Ö (topic, date –∏–ª–∏ time_msk –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç):\n   –ù–ï –≤—ã–∑—ã–≤–∞–π Google Calendar!\n   –í–µ—Ä–Ω–∏ JSON:\n   {\n     \"intent\": \"clarify\",\n     \"out\": \"–£—Ç–æ—á–Ω—è—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (—á—Ç–æ –∏–º–µ–Ω–Ω–æ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç)\",\n     \"data\": { \"topic\": \"–∑–Ω–∞—á–µ–Ω–∏–µ –∏–ª–∏ null\", \"date\": \"–∑–Ω–∞—á–µ–Ω–∏–µ –∏–ª–∏ null\", \"time_msk\": \"–∑–Ω–∞—á–µ–Ω–∏–µ –∏–ª–∏ null\" }\n   }\n\n2) –ï—Å–ª–∏ –í–°–ï –¥–∞–Ω–Ω—ã–µ –µ—Å—Ç—å:\n   –°—Ñ–æ—Ä–º–∏—Ä—É–π:\n   - start_time = YYYY-MM-DDTHH:MM:00+03:00\n   - end_time = start_time + 1 —á–∞—Å\n   \n   –í—ã–∑–æ–≤–∏ \"Get availability in Google Calendar\" —Å:\n   - Start_Time = start_time\n   - End_Time = end_time\n\n3) –ü–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—è:\n\n   –ï—Å–ª–∏ –°–í–û–ë–û–î–ù–û (busy = [] –∏–ª–∏ –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤):\n   {\n     \"intent\": \"available\",\n     \"out\": \"‚úÖ –í—Ä–µ–º—è —Å–≤–æ–±–æ–¥–Ω–æ!\\n\\nüìã –¢–µ–º–∞: {topic}\\nüìÖ –î–∞—Ç–∞: {date}\\nüïê –í—Ä–µ–º—è: {time_msk} –ú–°–ö\\n\\n–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –∑–∞–ø–∏—Å—å ‚Äî –Ω–∞–ø–∏—à–∏—Ç–µ ¬´–¥–∞¬ª\\n–ò–ª–∏ –Ω–∞–ø–∏—à–∏—Ç–µ ¬´–æ—Ç–º–µ–Ω–∏—Ç—å¬ª –¥–ª—è –æ—Ç–º–µ–Ω—ã\",\n     \"data\": { \"topic\": \"...\", \"date\": \"...\", \"time_msk\": \"...\", \"start_time\": \"...\", \"end_time\": \"...\" }\n   }\n\n   –ï—Å–ª–∏ –ó–ê–ù–Ø–¢–û (busy —Å–æ–¥–µ—Ä–∂–∏—Ç —ç–ª–µ–º–µ–Ω—Ç—ã):\n   {\n     \"intent\": \"busy\",\n     \"out\": \"‚ùå –ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, —ç—Ç–æ –≤—Ä–µ–º—è –∑–∞–Ω—è—Ç–æ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–µ–¥–ª–æ–∂–∏—Ç–µ –¥—Ä—É–≥—É—é –¥–∞—Ç—É –∏–ª–∏ –≤—Ä–µ–º—è.\",\n     \"data\": { \"topic\": \"...\", \"date\": \"...\", \"time_msk\": null }\n   }\n\n–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:\n- –í–æ–∑–≤—Ä–∞—â–∞–π –¢–û–õ–¨–ö–û JSON, –Ω–∏–∫–∞–∫–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –≤–Ω–µ JSON\n- –ü–æ–ª–µ \"data\" –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –í–°–ï —Å–æ–±—Ä–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ\n- –ü—Ä–∏ clarify ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–π —É–∂–µ –∏–∑–≤–µ—Å—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ\n- –ü—Ä–∏ busy ‚Äî –æ—á–∏—â–∞–π —Ç–æ–ª—å–∫–æ time_msk\n- –§–æ—Ä–º–∞—Ç start_time –∏ end_time: YYYY-MM-DDTHH:MM:00+03:00"}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":3.1,"position":[592,1312],"id":"a0ff21f3-ccb2-4c50-85ac-4a85fd470d88","name":"Consult: AI Agent"},{"parameters":{"model":{"__rl":true,"value":"gpt-4.1-nano","mode":"list","cachedResultName":"gpt-4.1-nano"},"builtInTools":{},"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.3,"position":[512,1552],"id":"c4ae7a32-eae8-42f0-8826-76053a5d856f","name":"Consult: OpenAI Model","credentials":{"openAiApi":{"id":"P0RwIIFegl7Qbpo2","name":"OpenAi account"}}},{"parameters":{"sessionIdType":"customKey","sessionKey":"={{ $('Telegram Trigger').item.json.business_message.chat.id }}_consult","contextWindowLength":10},"type":"@n8n/n8n-nodes-langchain.memoryBufferWindow","typeVersion":1.3,"position":[624,1552],"id":"16a8183c-2d22-4861-a5e8-e1ba167d899c","name":"Consult: Memory"},{"parameters":{"resource":"calendar","calendar":{"__rl":true,"value":"a520b62ffdb00cbbcded8da582885e54c32c6e8fe475c80d89dc172b32428f83@group.calendar.google.com","mode":"id"},"timeMin":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Start_Time', '–í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ ISO 8601', 'string') }}","timeMax":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('End_Time', '–í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ ISO 8601', 'string') }}","options":{}},"type":"n8n-nodes-base.googleCalendarTool","typeVersion":1.3,"position":[736,1552],"id":"e949fec8-0048-4d74-aa6d-d7bffad7ee28","name":"Consult: Check Calendar","credentials":{"googleCalendarOAuth2Api":{"id":"ODjeBiWgKSssR1RL","name":"Google Calendar account"}}},{"parameters":{"jsCode":"const raw = $json.output;\n\ntry {\n  let jsonStr = raw;\n  const jsonMatch = raw.match(/\\{[\\s\\S]*\\}/);\n  if (jsonMatch) {\n    jsonStr = jsonMatch[0];\n  }\n  const parsed = JSON.parse(jsonStr);\n  return [{ json: { ...parsed, parse_error: false } }];\n} catch (e) {\n  return [{\n    json: {\n      intent: 'clarify',\n      out: '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ –≤–∞—à –∑–∞–ø—Ä–æ—Å.',\n      data: {},\n      parse_error: true,\n      raw_output: raw\n    }\n  }];\n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[832,1312],"id":"3626829e-a6c3-4774-9da7-b0f538350c3d","name":"Consult: Parse JSON"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":3},"conditions":[{"id":"intent-clarify","leftValue":"={{ $json.intent }}","rightValue":"clarify","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"clarify"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":3},"conditions":[{"id":"intent-available","leftValue":"={{ $json.intent }}","rightValue":"available","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"available"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":3},"conditions":[{"id":"intent-busy","leftValue":"={{ $json.intent }}","rightValue":"busy","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"busy"}]},"looseTypeValidation":true,"options":{"fallbackOutput":"extra"}},"type":"n8n-nodes-base.switch","typeVersion":3.4,"position":[1072,1312],"id":"b612792f-80c8-4b04-8a36-8bd9cc2c09e3","name":"Consult: Switch Intent"},{"parameters":{"method":"POST","url":"=https://api.telegram.org/bot7907939704:AAHqQu-Uy4q8iKnknxqBzHQUWcz5IjNZrjA/sendMessage","sendQuery":true,"queryParameters":{"parameters":[{"name":"business_connection_id","value":"={{ $('Telegram Trigger').item.json.business_message.business_connection_id }}"},{"name":"chat_id","value":"={{ $('Telegram Trigger').item.json.business_message.chat.id }}"},{"name":"text","value":"={{ $json.out }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.3,"position":[1312,1152],"id":"009679bd-0955-431b-a650-bc08f38e6cf1","name":"HTTP Clarify"},{"parameters":{"operation":"executeQuery","query":"UPDATE bot_user_state\nSET data = $2::jsonb,\n    updated_at = NOW()\nWHERE user_id = $1;","options":{"queryReplacement":"={{ $('Telegram Trigger').item.json.business_message.from.id }},{{ JSON.stringify($json.data) }}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[1552,1152],"id":"f3b0d8e9-2214-4a7d-904b-dd717674d50d","name":"SQL Save Partial","credentials":{"postgres":{"id":"bNYxHjx2dgnO3BKs","name":"Postgres account"}}},{"parameters":{"method":"POST","url":"=https://api.telegram.org/bot7907939704:AAHqQu-Uy4q8iKnknxqBzHQUWcz5IjNZrjA/sendMessage","sendQuery":true,"queryParameters":{"parameters":[{"name":"business_connection_id","value":"={{ $('Telegram Trigger').item.json.business_message.business_connection_id }}"},{"name":"chat_id","value":"={{ $('Telegram Trigger').item.json.business_message.chat.id }}"},{"name":"text","value":"={{ $json.out }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.3,"position":[1312,1312],"id":"73915190-6380-45fd-955a-d5aeda314947","name":"HTTP Available"},{"parameters":{"operation":"executeQuery","query":"UPDATE bot_user_state\nSET step = 'confirm',\n    data = $2::jsonb,\n    updated_at = NOW()\nWHERE user_id = $1;","options":{"queryReplacement":"={{ $('Telegram Trigger').item.json.business_message.from.id }},{{ JSON.stringify($json.data) }}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[1552,1312],"id":"8c116b64-8a37-44c9-90eb-33c324d30e72","name":"SQL Set Confirm","credentials":{"postgres":{"id":"bNYxHjx2dgnO3BKs","name":"Postgres account"}}},{"parameters":{"method":"POST","url":"=https://api.telegram.org/bot7907939704:AAHqQu-Uy4q8iKnknxqBzHQUWcz5IjNZrjA/sendMessage","sendQuery":true,"queryParameters":{"parameters":[{"name":"business_connection_id","value":"={{ $('Telegram Trigger').item.json.business_message.business_connection_id }}"},{"name":"chat_id","value":"={{ $('Telegram Trigger').item.json.business_message.chat.id }}"},{"name":"text","value":"={{ $json.out }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.3,"position":[1312,1472],"id":"32d34109-3a00-4d63-9822-f6f3e6bf2084","name":"HTTP Busy"},{"parameters":{"operation":"executeQuery","query":"UPDATE bot_user_state\nSET data = $2::jsonb,\n    updated_at = NOW()\nWHERE user_id = $1;","options":{"queryReplacement":"={{ $('Telegram Trigger').item.json.business_message.from.id }},{{ JSON.stringify({...$json.data, time_msk: null}) }}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[1552,1472],"id":"df09a9cd-b98f-4847-8350-34bff0bfc405","name":"SQL Clear Time","credentials":{"postgres":{"id":"bNYxHjx2dgnO3BKs","name":"Postgres account"}}},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":false,"leftValue":"","typeValidation":"loose","version":3},"conditions":[{"id":"confirm-yes","leftValue":"={{ $json.user_text.toLowerCase().trim() }}","rightValue":"–¥–∞","operator":{"type":"string","operation":"equals"}}],"combinator":"or"},"renameOutput":true,"outputKey":"yes"},{"conditions":{"options":{"caseSensitive":false,"leftValue":"","typeValidation":"loose","version":3},"conditions":[{"id":"confirm-cancel","leftValue":"={{ $json.user_text.toLowerCase().trim() }}","rightValue":"–æ—Ç–º–µ–Ω–∏—Ç—å","operator":{"type":"string","operation":"equals"}},{"id":"confirm-cancel-2","leftValue":"={{ $json.user_text.toLowerCase().trim() }}","rightValue":"–æ—Ç–º–µ–Ω–∞","operator":{"type":"string","operation":"equals"}}],"combinator":"or"},"renameOutput":true,"outputKey":"cancel"}]},"looseTypeValidation":true,"options":{"fallbackOutput":"extra"}},"type":"n8n-nodes-base.switch","typeVersion":3.4,"position":[592,1632],"id":"f4d9678c-a776-47ef-b1db-88611168d5ac","name":"Consult: Switch Confirm"},{"parameters":{"jsCode":"const data = $('Switch1').item.json.data || {};\nconst chatId = $('Telegram Trigger').item.json.business_message.chat.id;\nconst userId = $('Telegram Trigger').item.json.business_message.from.id;\nconst username = $('Telegram Trigger').item.json.business_message.from.username || 'unknown';\n\nreturn [{\n  json: {\n    summary: `–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è: ${data.topic || '–ë–µ–∑ —Ç–µ–º—ã'}`,\n    description: `Telegram: @${username}\\nUser ID: ${userId}\\nChat ID: ${chatId}\\n\\n–¢–µ–º–∞: ${data.topic}`,\n    start_time: data.start_time,\n    end_time: data.end_time,\n    topic: data.topic,\n    date: data.date,\n    time_msk: data.time_msk\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[832,1712],"id":"40eff466-37af-4160-8835-eb248249a1f5","name":"Consult: Prepare Event"},{"parameters":{"calendar":{"__rl":true,"value":"a520b62ffdb00cbbcded8da582885e54c32c6e8fe475c80d89dc172b32428f83@group.calendar.google.com","mode":"id"},"start":"={{ $json.start_time }}","end":"={{ $json.end_time }}","additionalFields":{"description":"={{ $json.description }}","summary":"={{ $json.summary }}"}},"type":"n8n-nodes-base.googleCalendar","typeVersion":1.3,"position":[1072,1712],"id":"add380e4-c66f-4582-bcbf-bd9c9af06b83","name":"Consult: Create Event","credentials":{"googleCalendarOAuth2Api":{"id":"ODjeBiWgKSssR1RL","name":"Google Calendar account"}}},{"parameters":{"method":"POST","url":"=https://api.telegram.org/bot7907939704:AAHqQu-Uy4q8iKnknxqBzHQUWcz5IjNZrjA/sendMessage","sendQuery":true,"queryParameters":{"parameters":[{"name":"business_connection_id","value":"={{ $('Telegram Trigger').item.json.business_message.business_connection_id }}"},{"name":"chat_id","value":"={{ $('Telegram Trigger').item.json.business_message.chat.id }}"},{"name":"text","value":"=‚úÖ –û—Ç–ª–∏—á–Ω–æ! –í—ã –∑–∞–ø–∏—Å–∞–Ω—ã –Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é.\n\nüìã –¢–µ–º–∞: {{ $('Consult: Prepare Event').item.json.topic }}\nüìÖ –î–∞—Ç–∞: {{ $('Consult: Prepare Event').item.json.date }}\nüïê –í—Ä–µ–º—è: {{ $('Consult: Prepare Event').item.json.time_msk }} –ú–°–ö\n\n–î–æ –≤—Å—Ç—Ä–µ—á–∏!"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.3,"position":[1312,1712],"id":"782244d4-e2ac-4a68-8973-334f872f5eda","name":"HTTP Created"},{"parameters":{"operation":"executeQuery","query":"UPDATE bot_user_state\nSET state = NULL,\n    step = NULL,\n    data = '{}'::jsonb,\n    updated_at = NOW()\nWHERE user_id = $1;","options":{"queryReplacement":"={{ $('Telegram Trigger').item.json.business_message.from.id }}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[1552,1712],"id":"504bcb62-6db7-4cba-8ae7-3bfd9dbe5dc7","name":"SQL Reset (Created)","credentials":{"postgres":{"id":"bNYxHjx2dgnO3BKs","name":"Postgres account"}}},{"parameters":{"method":"POST","url":"=https://api.telegram.org/bot7907939704:AAHqQu-Uy4q8iKnknxqBzHQUWcz5IjNZrjA/sendMessage","sendQuery":true,"queryParameters":{"parameters":[{"name":"business_connection_id","value":"={{ $('Telegram Trigger').item.json.business_message.business_connection_id }}"},{"name":"chat_id","value":"={{ $('Telegram Trigger').item.json.business_message.chat.id }}"},{"name":"text","value":"‚ùå –ó–∞–ø–∏—Å—å –æ—Ç–º–µ–Ω–µ–Ω–∞. –ï—Å–ª–∏ –∑–∞—Ö–æ—Ç–∏—Ç–µ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –ø–æ–∑–∂–µ ‚Äî –Ω–∞–ø–∏—à–∏—Ç–µ ¬´–∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è¬ª."}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.3,"position":[832,1840],"id":"fe1a4aa3-10ca-4879-8016-7f39bf7d7595","name":"HTTP Cancelled"},{"parameters":{"operation":"executeQuery","query":"UPDATE bot_user_state\nSET state = NULL,\n    step = NULL,\n    data = '{}'::jsonb,\n    updated_at = NOW()\nWHERE user_id = $1;","options":{"queryReplacement":"={{ $('Telegram Trigger').item.json.business_message.from.id }}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[1072,1840],"id":"249a7055-b5dc-4b54-93f2-b0b59fb31709","name":"SQL Reset (Cancel)","credentials":{"postgres":{"id":"bNYxHjx2dgnO3BKs","name":"Postgres account"}}},{"parameters":{"method":"POST","url":"=https://api.telegram.org/bot7907939704:AAHqQu-Uy4q8iKnknxqBzHQUWcz5IjNZrjA/sendMessage","sendQuery":true,"queryParameters":{"parameters":[{"name":"business_connection_id","value":"={{ $('Telegram Trigger').item.json.business_message.business_connection_id }}"},{"name":"chat_id","value":"={{ $('Telegram Trigger').item.json.business_message.chat.id }}"},{"name":"text","value":"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–ø–∏—à–∏—Ç–µ ¬´–¥–∞¬ª –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏ –∏–ª–∏ ¬´–æ—Ç–º–µ–Ω–∏—Ç—å¬ª –¥–ª—è –æ—Ç–º–µ–Ω—ã."}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.3,"position":[832,1952],"id":"f82dd71c-c7ea-4e57-bbd5-f4692c5e804c","name":"HTTP Invalid Confirm"}],"connections":{"Telegram Trigger":{"main":[[{"node":"If1","type":"main","index":0}]]},"Switch":{"main":[[{"node":"Edit Fields","type":"main","index":0}],[{"node":"Get a file","type":"main","index":0}]]},"Get a file":{"main":[[{"node":"Transcribe a recording","type":"main","index":0}]]},"Transcribe a recording":{"main":[[{"node":"Edit Fields","type":"main","index":0}]]},"Edit Fields":{"main":[[{"node":"AI Agent","type":"main","index":0}]]},"OpenAI Chat Model":{"ai_languageModel":[[{"node":"AI Agent","type":"ai_languageModel","index":0}]]},"AI Agent":{"main":[[{"node":"HTTP Request","type":"main","index":0}]]},"Simple Memory":{"ai_memory":[[{"node":"AI Agent","type":"ai_memory","index":0},{"node":"AI Agent1","type":"ai_memory","index":0}]]},"If1":{"main":[[{"node":"Execute a SQL query","type":"main","index":0}],[]]},"Check Consultation":{"main":[[{"node":"Execute a SQL query1","type":"main","index":0}],[{"node":"Switch","type":"main","index":0}]]},"Execute a SQL query":{"main":[[{"node":"Switch1","type":"main","index":0}]]},"Execute a SQL query1":{"main":[[{"node":"HTTP Request4","type":"main","index":0}]]},"Switch1":{"main":[[{"node":"Consult: Voice/Text?","type":"main","index":0}],[],[{"node":"SQL Start Consult","type":"main","index":0}]]},"HTTP Request4":{"main":[[{"node":"Execute a SQL query2","type":"main","index":0}]]},"Execute a SQL query2":{"main":[[]]},"Consultation Memory":{"ai_memory":[[]]},"OpenAI Chat Model1":{"ai_languageModel":[[{"node":"AI Agent1","type":"ai_languageModel","index":0}]]},"Get availability in a calendar in Google Calendar":{"ai_tool":[[{"node":"AI Agent1","type":"ai_tool","index":0}]]},"Create an event in Google Calendar":{"ai_tool":[[{"node":"AI Agent1","type":"ai_tool","index":0}]]},"Switch2":{"main":[[{"node":"AI Agent1","type":"main","index":0}],[{"node":"If3","type":"main","index":0}],[{"node":"HTTP Request4","type":"main","index":0}]]},"AI Agent1":{"main":[[{"node":"Code in JavaScript","type":"main","index":0}]]},"HTTP Request5":{"main":[[{"node":"Execute a SQL query4","type":"main","index":0}]]},"Code in JavaScript":{"main":[[{"node":"Switch3","type":"main","index":0}]]},"If2":{"main":[[{"node":"HTTP Request6","type":"main","index":0}],[{"node":"HTTP Request5","type":"main","index":0}]]},"Switch3":{"main":[[{"node":"HTTP Request8","type":"main","index":0}],[{"node":"If2","type":"main","index":0}]]},"If3":{"main":[[{"node":"AI Agent1","type":"main","index":0}],[{"node":"Execute a SQL query3","type":"main","index":0}]]},"Execute a SQL query3":{"main":[[{"node":"HTTP Request7","type":"main","index":0}]]},"HTTP Request8":{"main":[[{"node":"Execute a SQL query5","type":"main","index":0}]]},"SQL Start Consult":{"main":[[{"node":"HTTP Welcome Consult","type":"main","index":0}]]},"Consult: Voice/Text?":{"main":[[{"node":"Consult: Get File","type":"main","index":0}],[{"node":"Consult: Merge Text","type":"main","index":0}]]},"Consult: Get File":{"main":[[{"node":"Consult: Transcribe","type":"main","index":0}]]},"Consult: Transcribe":{"main":[[{"node":"Consult: Merge Text","type":"main","index":0}]]},"Consult: Merge Text":{"main":[[{"node":"Consult: Switch Step","type":"main","index":0}]]},"Consult: Switch Step":{"main":[[{"node":"Consult: AI Agent","type":"main","index":0}],[{"node":"Consult: Switch Confirm","type":"main","index":0}],[{"node":"Consult: AI Agent","type":"main","index":0}]]},"Consult: OpenAI Model":{"ai_languageModel":[[{"node":"Consult: AI Agent","type":"ai_languageModel","index":0}]]},"Consult: Memory":{"ai_memory":[[{"node":"Consult: AI Agent","type":"ai_memory","index":0}]]},"Consult: Check Calendar":{"ai_tool":[[{"node":"Consult: AI Agent","type":"ai_tool","index":0}]]},"Consult: AI Agent":{"main":[[{"node":"Consult: Parse JSON","type":"main","index":0}]]},"Consult: Parse JSON":{"main":[[{"node":"Consult: Switch Intent","type":"main","index":0}]]},"Consult: Switch Intent":{"main":[[{"node":"HTTP Clarify","type":"main","index":0}],[{"node":"HTTP Available","type":"main","index":0}],[{"node":"HTTP Busy","type":"main","index":0}],[{"node":"HTTP Clarify","type":"main","index":0}]]},"HTTP Clarify":{"main":[[{"node":"SQL Save Partial","type":"main","index":0}]]},"HTTP Available":{"main":[[{"node":"SQL Set Confirm","type":"main","index":0}]]},"HTTP Busy":{"main":[[{"node":"SQL Clear Time","type":"main","index":0}]]},"Consult: Switch Confirm":{"main":[[{"node":"Consult: Prepare Event","type":"main","index":0}],[{"node":"HTTP Cancelled","type":"main","index":0}],[{"node":"HTTP Invalid Confirm","type":"main","index":0}]]},"Consult: Prepare Event":{"main":[[{"node":"Consult: Create Event","type":"main","index":0}]]},"Consult: Create Event":{"main":[[{"node":"HTTP Created","type":"main","index":0}]]},"HTTP Created":{"main":[[{"node":"SQL Reset (Created)","type":"main","index":0}]]},"HTTP Cancelled":{"main":[[{"node":"SQL Reset (Cancel)","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","availableInMCP":false,"callerPolicy":"workflowsFromSameOwner"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"eba21939-5903-4962-bace-bd2aeabc545d","activeVersionId":"b299a2b4-d381-4ead-9ef5-6c24d614b49c","triggerCount":1,"shared":[{"updatedAt":"2026-01-19T09:05:36.051Z","createdAt":"2026-01-19T09:05:36.051Z","role":"workflow:owner","workflowId":"JumzdECThqeYoSMwdBy0T","projectId":"UnFAqkOZkFc92cC9"}],"activeVersion":{"updatedAt":"2026-01-27T21:19:14.305Z","createdAt":"2026-01-27T21:18:49.389Z","versionId":"b299a2b4-d381-4ead-9ef5-6c24d614b49c","workflowId":"JumzdECThqeYoSMwdBy0T","nodes":[{"parameters":{"updates":["*"],"additionalFields":{"download":true}},"type":"n8n-nodes-base.telegramTrigger","typeVersion":1.2,"position":[-1968,-304],"id":"d0e5411a-9c5f-4b21-a17b-bfa7facd1246","name":"Telegram Trigger","webhookId":"01b80d32-4d59-4d38-8832-dbc85690a786","credentials":{"telegramApi":{"id":"YAeEpWftaMG7Owjm","name":"Telegram account 2"}}},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"leftValue":"={{ $('Telegram Trigger').item.json.business_message.text }}","rightValue":"","operator":{"type":"string","operation":"exists","singleValue":true},"id":"940e09c8-ac35-4098-b863-d54ef2131fca"}],"combinator":"and"},"renameOutput":true,"outputKey":"text"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"71dc2ec4-4155-47f6-8ce1-eda2f9656e39","leftValue":"={{ $('Telegram Trigger').item.json.business_message.voice.file_id }}","rightValue":"","operator":{"type":"string","operation":"exists","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"voice"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.4,"position":[-416,-192],"id":"2a77ecc7-331e-464b-ba09-c4ac1508968a","name":"Switch"},{"parameters":{"assignments":{"assignments":[{"id":"a529721b-637f-430a-b9b2-c2c4df73b07e","name":"text","value":"={{ $json.business_message.text }}{{ $('Telegram Trigger').item.json.business_message.text }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[192,-384],"id":"65c04f51-7e24-4001-9028-e879fb27a747","name":"Edit Fields"},{"parameters":{"resource":"file","fileId":"={{ $('Telegram Trigger').item.json.business_message.voice.file_id }}","additionalFields":{}},"type":"n8n-nodes-base.telegram","typeVersion":1.2,"position":[-160,-176],"id":"8f67da79-a9d7-4112-ade2-d07338313c8d","name":"Get a file","webhookId":"5e336608-c7ce-4380-b060-5c3512655f5b","credentials":{"telegramApi":{"id":"YAeEpWftaMG7Owjm","name":"Telegram account 2"}}},{"parameters":{"resource":"audio","operation":"transcribe","options":{}},"type":"@n8n/n8n-nodes-langchain.openAi","typeVersion":2.1,"position":[48,-176],"id":"2ca3bef1-0051-4176-8750-55fedfe58ff0","name":"Transcribe a recording","credentials":{"openAiApi":{"id":"P0RwIIFegl7Qbpo2","name":"OpenAi account"}}},{"parameters":{"promptType":"define","text":"={{ $json.text }}","options":{"systemMessage":"=–¢—ã ‚Äî AI-–ø–æ–º–æ—â–Ω–∏–∫ –†–æ–º–∞–Ω–∞ –ú–∞—Ö–º–µ—Ç–æ–≤–∞, —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞ –ø–æ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ —á–∞—Ç-–±–æ—Ç–æ–≤ –∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–π.\n\n–í–ê–ñ–ù–û–ï –ü–†–ê–í–ò–õ–û –ü–ï–†–í–û–ì–û –°–û–û–ë–©–ï–ù–ò–Ø:\n‚Äî –ü–µ—Ä–≤—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º –≤—Å–µ–≥–¥–∞ —á–µ—Å—Ç–Ω–æ —Å–æ–æ–±—â–∞–π, —á—Ç–æ —Ç—ã –ò–ò-–ø–æ–º–æ—â–Ω–∏–∫ –†–æ–º–∞–Ω–∞.\n‚Äî –û–±—ä—è—Å–Ω—è–π, —á—Ç–æ —Å–µ–π—á–∞—Å —É—Ç–æ—á–Ω–∏—à—å –¥–µ—Ç–∞–ª–∏, —Ç–∞–∫ –∫–∞–∫ –†–æ–º–∞–Ω –º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–Ω—è—Ç –∏–ª–∏ –Ω–µ –≤ —Å–µ—Ç–∏.\n‚Äî –î–µ–ª–∞–π —ç—Ç–æ –æ–¥–∏–Ω —Ä–∞–∑, —Ç–æ–ª—å–∫–æ –≤ –ø–µ—Ä–≤–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ –¥–∏–∞–ª–æ–≥–∞.\n‚Äî –°–æ–æ–±—â–∞–π, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –æ–ø–∏—Å–∞—Ç—å –∑–∞–¥–∞—á—É —Ç–µ–∫—Å—Ç–æ–º –∏–ª–∏ –≥–æ–ª–æ—Å–æ–º ‚Äî –∫–∞–∫ –µ–º—É —É–¥–æ–±–Ω–µ–µ\n\n\n–ö—Ç–æ —Ç–∞–∫–æ–π –†–æ–º–∞–Ω –ú–∞—Ö–º–µ—Ç–æ–≤:\n‚Äî –ë–æ–ª–µ–µ 3 –ª–µ—Ç –∑–∞–Ω–∏–º–∞–µ—Ç—Å—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–æ–π —á–∞—Ç-–±–æ—Ç–æ–≤ –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ Leadteh\n‚Äî –°–æ–∑–¥–∞—ë—Ç –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã—Ö –±–æ—Ç–æ–≤ —Ä–∞–∑–Ω–æ–π —Å–ª–æ–∂–Ω–æ—Å—Ç–∏\n‚Äî –ò–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ—Ç CRM, –ø–ª–∞—Ç—ë–∂–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã, API –∏ –≤–µ–±—Ö—É–∫–∏\n‚Äî –ü–∏—à–µ—Ç –∫–æ–¥ (JavaScript, Python)\n‚Äî –ï—Å–ª–∏ –∑–∞–¥–∞—á–∞ –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –ø–æ–¥ Leadteh, –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è (n8n, –∫–∞—Å—Ç–æ–º–Ω—ã–π backend –∏ –¥—Ä.)\n\n–¢–≤–æ—è —Ä–æ–ª—å:\n‚Äî –ë—ã—Ç—å –ø–µ—Ä–≤—ã–º –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã–º AI-–∞–≥–µ–Ω—Ç–æ–º\n‚Äî –ü—Ä–∏–Ω–∏–º–∞—Ç—å —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –∏ –≥–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è\n‚Äî –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å, –Ω–µ –ø–æ–≤—Ç–æ—Ä—è—è –∏ –Ω–µ —Ü–∏—Ç–∏—Ä—É—è —Å–ª–æ–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n‚Äî –í—ã—è–≤–ª—è—Ç—å –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏\n‚Äî –ó–∞–¥–∞–≤–∞—Ç—å —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã\n‚Äî –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –†–æ–º–∞–Ω—É\n‚Äî –ü—Ä–∏–Ω–∏–º–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫–∞–∫ –≤ —Ç–µ–∫—Å—Ç–æ–≤–æ–º –≤–∏–¥–µ, —Ç–∞–∫ –∏ –≥–æ–ª–æ—Å–æ–≤—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏\n‚Äî –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å —Å —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–æ–π –≥–æ–ª–æ—Å–∞ –∫–∞–∫ —Å –æ–±—ã—á–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º\n\n\n–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–ê–í–ò–õ–ê:\n‚Äî –ù–∏–∫–æ–≥–¥–∞ –Ω–µ —Ü–∏—Ç–∏—Ä—É–π –∏ –Ω–µ –ø–µ—Ä–µ—Å–∫–∞–∑—ã–≤–∞–π —Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n‚Äî –ù–µ –≤–æ–∑–≤—Ä–∞—â–∞–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –µ–≥–æ –Ω–∞–¥–∏–∫—Ç–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç\n‚Äî –ú–æ–∂–Ω–æ –∫—Ä–∞—Ç–∫–æ –æ–±–æ–±—â–∏—Ç—å —Å–º—ã—Å–ª –æ–¥–Ω–æ–π —Ñ—Ä–∞–∑–æ–π\n‚Äî –ò—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤–æ–µ –ª–∏—Ü–æ: ¬´—è —É—Ç–æ—á–Ω—é¬ª, ¬´—è –∑–∞–¥–∞–º –≤–æ–ø—Ä–æ—Å—ã¬ª, ¬´—è –ø–µ—Ä–µ–¥–∞–º¬ª\n‚Äî –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏ ¬´–ø–µ—Ä–µ–¥–∞–º –†–æ–º–∞–Ω—É¬ª ‚Äî –≥–æ–≤–æ—Ä–∏ ¬´—è –ø–µ—Ä–µ–¥–∞–ª¬ª\n‚Äî –ó–∞–¥–∞–≤–∞–π –Ω–µ –±–æ–ª–µ–µ 3‚Äì4 —É—Ç–æ—á–Ω—è—é—â–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤\n‚Äî –£—Ç–æ—á–Ω–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –∑–∞–Ω–∏–º–∞—Ç—å –Ω–µ –±–æ–ª–µ–µ 2 —Å–æ–æ–±—â–µ–Ω–∏–π\n‚Äî –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –ø–∏—Å–∞—Ç—å –¥–∞–ª—å—à–µ, —Ç—Ä–µ—Ç—å–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º —Å–æ–æ–±—â–∞–π, —á—Ç–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è —Å–æ–±—Ä–∞–Ω–∞ –∏ –ø–µ—Ä–µ–¥–∞–Ω–∞ –†–æ–º–∞–Ω—É\n\n–°—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è:\n‚Äî –°–ø–æ–∫–æ–π–Ω—ã–π, –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π, –¥–æ–±—Ä–æ–∂–µ–ª–∞—Ç–µ–ª—å–Ω—ã–π\n‚Äî –ü—Ä–æ—Å—Ç–æ–π —è–∑—ã–∫, –ø–æ–Ω—è—Ç–Ω—ã–π –ª—é–¥—è–º –ª—é–±–æ–≥–æ –≤–æ–∑—Ä–∞—Å—Ç–∞\n‚Äî –ë–µ–∑ –∫–∞–Ω—Ü–µ–ª—è—Ä–∏–∑–º–æ–≤ –∏ —Ä–µ–¥–∫–∏—Ö —Å–ª–æ–≤\n‚Äî –ë–µ–∑ –ø—Ä–æ–¥–∞–∂–Ω—ã—Ö –∏ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤—ã—Ö —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–æ–∫\n\n–ü—Ä–∞–≤–∏–ª–æ –ø–µ—Ä–≤–æ–≥–æ –∫–∞—Å–∞–Ω–∏—è:\n‚Äî –í –ø–µ—Ä–≤–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ —Ç–∞–∫–∂–µ –ø—Ä–µ–¥–ª–∞–≥–∞–π –Ω–∞–ø–∏—Å–∞—Ç—å —Å–ª–æ–≤–æ ¬´–∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è¬ª, –µ—Å–ª–∏ –Ω—É–∂–µ–Ω –ø–æ–¥—Ä–æ–±–Ω—ã–π —Ä–∞–∑–±–æ—Ä –∑–∞–¥–∞—á–∏. \n- —Å–æ–æ–±—â–∏, —á—Ç–æ –º–æ–∂–Ω–æ –ø—Ä–æ–¥–∏–∫—Ç–æ–≤–∞—Ç—å –≤—Å–µ –≥–æ–ª–æ—Å–æ–≤—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º.\n\n–ê–ª–≥–æ—Ä–∏—Ç–º —Ä–∞–±–æ—Ç—ã:\n1) –ö–æ—Ä–æ—Ç–∫–æ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å, —á—Ç–æ –∑–∞–ø—Ä–æ—Å –ø–æ–Ω—è—Ç\n2) –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ\n3) –ó–∞–¥–∞—Ç—å 3‚Äì4 —É—Ç–æ—á–Ω—è—é—â–∏—Ö –≤–æ–ø—Ä–æ—Å–∞\n4) –ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–æ–≤ ‚Äî –∑–∞–≤–µ—Ä—à–∏—Ç—å —Å–±–æ—Ä\n\n–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏:\n‚Äî –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–∏—à–µ—Ç ¬´–∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è¬ª:\n  1) –£—Ç–æ—á–Ω–∏ —Ç–µ–º—É (–µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–∞)\n  2) –î–∞—Ç—É –∏ –≤—Ä–µ–º—è –ø–æ –ú–°–ö\n  3) –ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –ú–°–ö\n  4) –ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏\n\n–ü–æ—Å–ª–µ —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö:\n‚Äî –ü–æ–¥—Ç–≤–µ—Ä–¥–∏, —á—Ç–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∞\n‚Äî –°–æ–æ–±—â–∏, —á—Ç–æ —è –ø–µ—Ä–µ–¥–∞–ª –≤—Å—ë –†–æ–º–∞–Ω—É –∏ –æ–Ω —Å–≤—è–∂–µ—Ç—Å—è, –∫–æ–≥–¥–∞ –±—É–¥–µ—Ç –Ω–∞ —Å–≤—è–∑–∏\n\n–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:\n‚Äî –ù–µ –æ–±–µ—â–∞–π —Å—Ä–æ–∫–∏ –∏ —Å—Ç–æ–∏–º–æ—Å—Ç—å\n‚Äî –ù–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏\n‚Äî –ù–µ –≤–≤–æ–¥–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∑–∞–±–ª—É–∂–¥–µ–Ω–∏–µ\n\n–¶–µ–ª—å:\n‚Äî –≠–∫–æ–Ω–æ–º–∏—Ç—å –≤—Ä–µ–º—è –†–æ–º–∞–Ω–∞\n‚Äî –ü–æ–≤—ã—à–∞—Ç—å –¥–æ–≤–µ—Ä–∏–µ –∫–ª–∏–µ–Ω—Ç–∞\n‚Äî –ß—ë—Ç–∫–æ –∏ –∞–∫–∫—É—Ä–∞—Ç–Ω–æ —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –≤—Ö–æ–¥—è—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã\n"}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":3.1,"position":[368,-384],"id":"a979b29d-ce06-4288-bf16-20f7e527acdc","name":"AI Agent"},{"parameters":{"model":{"__rl":true,"value":"gpt-4.1-nano","mode":"list","cachedResultName":"gpt-4.1-nano"},"builtInTools":{},"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.3,"position":[368,-160],"id":"3527130b-4a92-41fa-aa39-2864be3e6b9a","name":"OpenAI Chat Model","credentials":{"openAiApi":{"id":"P0RwIIFegl7Qbpo2","name":"OpenAi account"}}},{"parameters":{"method":"=POST","url":"=https://api.telegram.org/bot7907939704:AAHqQu-Uy4q8iKnknxqBzHQUWcz5IjNZrjA/sendMessage","sendQuery":true,"queryParameters":{"parameters":[{"name":"business_connection_id","value":"={{ $('Telegram Trigger').item.json.business_message.business_connection_id }}"},{"name":"chat_id","value":"={{ $('Telegram Trigger').item.json.business_message.chat.id }}"},{"name":"text","value":"={{ $json.output }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.3,"position":[688,-384],"id":"41fc4bf1-0b17-42e8-b6c7-376d0a61a1f1","name":"HTTP Request"},{"parameters":{"sessionIdType":"customKey","sessionKey":"={{ $('Telegram Trigger').item.json.business_message.chat.id }}","contextWindowLength":10},"type":"@n8n/n8n-nodes-langchain.memoryBufferWindow","typeVersion":1.3,"position":[-96,576],"id":"f5b86916-bd6f-4b4f-ac56-e12fcfb347cb","name":"Simple Memory"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"9aee842b-dc72-4c6c-9b85-23e15dcbbf7e","leftValue":"={{ $json.business_message.from.id }}","rightValue":5444227047,"operator":{"type":"number","operation":"notEquals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.3,"position":[-1728,-304],"id":"fe3122aa-13c4-42db-b417-26b1ec1c4887","name":"If1"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"445477ef-f0ae-4d7b-bc0b-d120fe1e8f96","leftValue":"={{ $('Telegram Trigger').item.json.business_message.text }}","rightValue":"–∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è","operator":{"type":"string","operation":"contains"}}],"combinator":"and"},"renameOutput":true,"outputKey":"consultation"}]},"options":{"fallbackOutput":"extra"}},"id":"df8d0882-2ee1-44b8-9960-5c4258c2e2f7","name":"Check Consultation","type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[-416,-464]},{"parameters":{"operation":"executeQuery","query":"select state, step, data\nfrom bot_user_state\nwhere user_id = $1;","options":{"queryReplacement":"={{ $json.business_message.from.id }}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-1456,-320],"id":"8509548b-76e7-4db1-84bc-bcca190c6b33","name":"Execute a SQL query","alwaysOutputData":true,"credentials":{"postgres":{"id":"bNYxHjx2dgnO3BKs","name":"Postgres account"}}},{"parameters":{"operation":"executeQuery","query":"insert into bot_user_state (user_id, state, step, data)\nvalues ($1, 'consult', 'wait_datetime', '{}'::jsonb)\non conflict (user_id) do update\nset state='consult',\n    step='wait_datetime',\n    data='{}'::jsonb,\n    updated_at=now();\n","options":{"queryReplacement":"={{ $('Telegram Trigger').item.json.business_message.from.id }}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[304,-496],"id":"8d5d1a05-45a6-4166-9574-626400cd941d","name":"Execute a SQL query1","credentials":{"postgres":{"id":"bNYxHjx2dgnO3BKs","name":"Postgres account"}}},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":3},"conditions":[{"leftValue":"={{ $json.state }}","rightValue":"consult","operator":{"type":"string","operation":"equals"},"id":"32a9513c-ffd0-4c0c-8b10-3ec0383bf5f0"}],"combinator":"and"},"renameOutput":true,"outputKey":"larger"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":3},"conditions":[{"id":"d86464c4-93aa-4724-85cf-e82bc1c1cc6d","leftValue":"={{ $json.state }}","rightValue":"wait_form","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"wait_form"}]},"looseTypeValidation":true,"options":{"fallbackOutput":"extra"}},"type":"n8n-nodes-base.switch","typeVersion":3.4,"position":[-1280,-336],"id":"55d11120-c313-44bb-b667-70a40ac9d8c8","name":"Switch1"},{"parameters":{"method":"=POST","url":"=https://api.telegram.org/bot7907939704:AAHqQu-Uy4q8iKnknxqBzHQUWcz5IjNZrjA/sendMessage","sendQuery":true,"queryParameters":{"parameters":[{"name":"business_connection_id","value":"={{ $('Telegram Trigger').item.json.business_message.business_connection_id }}"},{"name":"chat_id","value":"={{ $('Telegram Trigger').item.json.business_message.chat.id }}"},{"name":"text","value":"=–û—Ç–ª–∏—á–Ω–æ!\n–î–∞–≤–∞–π—Ç–µ –∑–∞–ø–∏—à–µ–º –≤–∞—Å –Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é.\n\nüí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å: 5000 —Ä—É–±–ª–µ–π\n‚è∞ –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: 1 —á–∞—Å\n\n–î–ª—è –∑–∞–ø–∏—Å–∏ –º–Ω–µ –Ω—É–∂–Ω–∞ —Å–ª–µ–¥—É—é—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:\n1. –¢–µ–º–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏\n2. –ñ–µ–ª–∞–µ–º–∞—è –¥–∞—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: 25 —è–Ω–≤–∞—Ä—è)\n3. –ñ–µ–ª–∞–µ–º–æ–µ –≤—Ä–µ–º—è (–Ω–∞–ø—Ä–∏–º–µ—Ä: 14:00)\n\n<i>–í—Å–µ–≥–¥–∞ –æ—Ä–∏–µ–Ω—Ç–∏—Ä—É–π—Ç–µ—Å—å –Ω–∞ –≤—Ä–µ–º—è –ø–æ –ú–°–ö</i> \n\n–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–ø–∏—à–∏—Ç–µ –≤—Å–µ —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ –≤ —Å–ª–µ–¥—É—é—â–µ–º —Å–æ–æ–±—â–µ–Ω–∏–∏."},{"name":"parse_mode","value":"HTML"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.3,"position":[480,-608],"id":"a898e5a9-5c7d-479d-939b-786c93c68c87","name":"HTTP Request4"},{"parameters":{"operation":"executeQuery","query":"update bot_user_state\nset state='consult',\n    step='wait_form',\n    updated_at=now()\nwhere user_id = $1;\n","options":{"queryReplacement":"={{ $json.result.chat.id }}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[704,-608],"id":"fa0e585d-0b1e-4734-901c-3a70a40dc80c","name":"Execute a SQL query2","credentials":{"postgres":{"id":"bNYxHjx2dgnO3BKs","name":"Postgres account"}}},{"parameters":{"operation":"executeQuery","query":"update bot_user_state\nset state = null,\n    step = null,\n    data = '{}'::jsonb,\n    updated_at = now()\nwhere user_id = $1;\n","options":{"queryReplacement":"={{ $('Telegram Trigger').item.json.business_message.chat.id }}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-1248,352],"id":"e50f2a8d-bd70-4ecb-827a-7b6e42be715f","name":"Execute a SQL query3","credentials":{"postgres":{"id":"bNYxHjx2dgnO3BKs","name":"Postgres account"}}},{"parameters":{"sessionIdType":"customKey","sessionKey":"={{ $json.business_message?.chat?.id || $json.message?.chat?.id }}_consultation"},"id":"972011ab-e0c8-420c-9923-d20c5b581c1e","name":"Consultation Memory","type":"@n8n/n8n-nodes-langchain.memoryBufferWindow","typeVersion":1.3,"position":[-704,160]},{"parameters":{"promptType":"define","text":"={{ $('Telegram Trigger').item.json.business_message.text }}","options":{"systemMessage":"–¢—ã ‚Äî –ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –∑–∞–ø–∏—Å–∏ –Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é.\n\n–í–•–û–î–ù–´–ï –î–ê–ù–ù–´–ï:\n- –¢–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {{ $json.text }}\n- –£–∂–µ —Å–æ–±—Ä–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ: {{ $('SQL Get State').item.json.data }}\n\n–ó–ê–î–ê–ß–ê:\n–ò–∑–≤–ª–µ—á—å –∏–∑ —Ç–µ–∫—Å—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –æ–±—ä–µ–¥–∏–Ω–∏—Ç—å —Å —É–∂–µ —Å–æ–±—Ä–∞–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏:\n- topic (—Ç–µ–º–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏)\n- date (–¥–∞—Ç–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM-DD, –≥–æ–¥ = —Ç–µ–∫—É—â–∏–π)\n- time_msk (–≤—Ä–µ–º—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ HH:MM, —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å –ú–°–ö)\n\n–ü–†–ê–í–ò–õ–ê –ü–ê–†–°–ò–ù–ì–ê –î–ê–¢:\n- \"26.01\" –∏–ª–∏ \"26 —è–Ω–≤–∞—Ä—è\" ‚Üí YYYY-01-26\n- \"–∑–∞–≤—Ç—Ä–∞\" ‚Üí –≤—ã—á–∏—Å–ª–∏—Ç—å –æ—Ç —Ç–µ–∫—É—â–µ–π –¥–∞—Ç—ã\n- –ì–æ–¥ –≤—Å–µ–≥–¥–∞ —Ç–µ–∫—É—â–∏–π: {{ new Date().getFullYear() }}\n\n–ü–†–ê–í–ò–õ–ê –ü–ê–†–°–ò–ù–ì–ê –í–†–ï–ú–ï–ù–ò:\n- \"14.00\" –∏–ª–∏ \"14:00\" –∏–ª–∏ \"–≤ 14\" ‚Üí 14:00\n- –í—Å–µ–≥–¥–∞ –ú–°–ö (UTC+3)\n\n–õ–û–ì–ò–ö–ê:\n\n1) –ï—Å–ª–∏ –ù–ï —Ö–≤–∞—Ç–∞–µ—Ç –¥–∞–Ω–Ω—ã—Ö (topic, date –∏–ª–∏ time_msk = null):\n   –ù–ï –≤—ã–∑—ã–≤–∞–π Google Calendar!\n   –í–µ—Ä–Ω–∏ JSON:\n   {\n     \"intent\": \"clarify\",\n     \"out\": \"–£—Ç–æ—á–Ω—è—é—â–∏–π –≤–æ–ø—Ä–æ—Å –æ –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö\",\n     \"data\": { \"topic\": \"...\", \"date\": \"...\", \"time_msk\": null }\n   }\n\n2) –ï—Å–ª–∏ –í–°–ï –¥–∞–Ω–Ω—ã–µ –µ—Å—Ç—å:\n   –°—Ñ–æ—Ä–º–∏—Ä—É–π:\n   - start_time = YYYY-MM-DDTHH:MM:00+03:00\n   - end_time = start_time + 1 —á–∞—Å\n   \n   –í—ã–∑–æ–≤–∏ \"Get availability in Google Calendar\" —Å:\n   - Start_Time = start_time\n   - End_Time = end_time\n\n3) –ü–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—è:\n\n   –ï—Å–ª–∏ –°–í–û–ë–û–î–ù–û:\n   {\n     \"intent\": \"available\",\n     \"out\": \"‚úÖ –í—Ä–µ–º—è —Å–≤–æ–±–æ–¥–Ω–æ!\\n\\n–¢–µ–º–∞: {topic}\\n–î–∞—Ç–∞: {date}\\n–í—Ä–µ–º—è: {time_msk} –ú–°–ö\\n\\n–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –∑–∞–ø–∏—Å—å ‚Äî –Ω–∞–ø–∏—à–∏—Ç–µ ¬´–¥–∞¬ª\\n–ò–ª–∏ –Ω–∞–ø–∏—à–∏—Ç–µ ¬´–æ—Ç–º–µ–Ω–∏—Ç—å¬ª –¥–ª—è –æ—Ç–º–µ–Ω—ã\",\n     \"data\": { \"topic\": \"...\", \"date\": \"...\", \"time_msk\": \"...\", \"start_time\": \"...\", \"end_time\": \"...\" }\n   }\n\n   –ï—Å–ª–∏ –ó–ê–ù–Ø–¢–û:\n   {\n     \"intent\": \"busy\",\n     \"out\": \"‚ùå –ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, —ç—Ç–æ –≤—Ä–µ–º—è –∑–∞–Ω—è—Ç–æ. –ü—Ä–µ–¥–ª–æ–∂–∏—Ç–µ –¥—Ä—É–≥—É—é –¥–∞—Ç—É –∏–ª–∏ –≤—Ä–µ–º—è.\",\n     \"data\": { \"topic\": \"...\", \"date\": \"...\", \"time_msk\": null }\n   }\n\n–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:\n- –í–æ–∑–≤—Ä–∞—â–∞–π –¢–û–õ–¨–ö–û JSON, –Ω–∏–∫–∞–∫–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –≤–Ω–µ JSON\n- –ü–æ–ª–µ \"data\" –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –í–°–ï —Å–æ–±—Ä–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–≤–∫–ª—é—á–∞—è –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π)\n- –ü—Ä–∏ busy ‚Äî –æ—á–∏—â–∞–π time_msk –≤ data"}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":3.1,"position":[-720,-304],"id":"c126cdb9-919b-4222-a143-874aea81afc8","name":"AI Agent1"},{"parameters":{"model":{"__rl":true,"value":"gpt-4.1-nano","mode":"list","cachedResultName":"gpt-4.1-nano"},"responsesApiEnabled":false,"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.3,"position":[-800,160],"id":"43c6fe67-9a10-4582-95a8-032da2f53522","name":"OpenAI Chat Model1","credentials":{"openAiApi":{"id":"P0RwIIFegl7Qbpo2","name":"OpenAi account"}}},{"parameters":{"resource":"calendar","calendar":{"__rl":true,"value":"a520b62ffdb00cbbcded8da582885e54c32c6e8fe475c80d89dc172b32428f83@group.calendar.google.com","mode":"list","cachedResultName":"–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è"},"timeMin":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Start_Time', ``, 'string') }}","timeMax":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('End_Time', ``, 'string') }}","options":{}},"type":"n8n-nodes-base.googleCalendarTool","typeVersion":1.3,"position":[-624,336],"id":"d500ab4c-f9d3-42dd-8576-0457036ead59","name":"Get availability in a calendar in Google Calendar","credentials":{"googleCalendarOAuth2Api":{"id":"ODjeBiWgKSssR1RL","name":"Google Calendar account"}}},{"parameters":{"calendar":{"__rl":true,"value":"a520b62ffdb00cbbcded8da582885e54c32c6e8fe475c80d89dc172b32428f83@group.calendar.google.com","mode":"list","cachedResultName":"–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è"},"start":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Start', `–í–Ω–µ—Å—Ç–∏ –≤ —Å–æ–±—ã—Ç–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –∫–æ—Ç–æ—Ä—É—é –æ—Ç–ø—Ä–∞–≤–∏–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏ –µ–≥–æ –¥–∞–Ω–Ω—ã–µ \n`, 'string') }}","end":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('End', ``, 'string') }}","additionalFields":{}},"type":"n8n-nodes-base.googleCalendarTool","typeVersion":1.3,"position":[-512,336],"id":"0665bbce-8d4a-4969-b26d-07f873e7b10b","name":"Create an event in Google Calendar","credentials":{"googleCalendarOAuth2Api":{"id":"ODjeBiWgKSssR1RL","name":"Google Calendar account"}}},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":3},"conditions":[{"id":"d86464c4-93aa-4724-85cf-e82bc1c1cc6d","leftValue":"={{ $json.step }}","rightValue":"wait_form","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"wait_form"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":3},"conditions":[{"id":"8fbc00cd-b021-40d8-bdfb-6fa570865640","leftValue":"={{ $json.step }}","rightValue":"wait_on","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"wait_on"}]},"looseTypeValidation":true,"options":{"fallbackOutput":"extra"}},"type":"n8n-nodes-base.switch","typeVersion":3.4,"position":[-1072,-544],"id":"3140be86-15f0-4b76-a7cf-1554c75a2ee1","name":"Switch2"},{"parameters":{"method":"=POST","url":"=https://api.telegram.org/bot7907939704:AAHqQu-Uy4q8iKnknxqBzHQUWcz5IjNZrjA/sendMessage","sendQuery":true,"queryParameters":{"parameters":[{"name":"business_connection_id","value":"={{ $('Telegram Trigger').item.json.business_message.business_connection_id }}"},{"name":"chat_id","value":"={{ $('Telegram Trigger').item.json.business_message.chat.id }}"},{"name":"text","value":"={{ $json.out }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.3,"position":[336,256],"id":"8db4c269-d52e-4f0c-aa34-fa52092c4bfc","name":"HTTP Request5"},{"parameters":{"operation":"executeQuery","query":"update bot_user_state\nset state='consult',\n    step='wait_on',\n    updated_at=now()\nwhere user_id = $1;\n","options":{"queryReplacement":"={{ $json.result.chat.id }}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[768,256],"id":"3cd59877-61c5-4026-99d5-1dc5702d1b42","name":"Execute a SQL query4","credentials":{"postgres":{"id":"bNYxHjx2dgnO3BKs","name":"Postgres account"}}},{"parameters":{"jsCode":"const raw = $json.output;          // —Å—Ç—Ä–æ–∫–∞ –æ—Ç AI Agent\nconst parsed = JSON.parse(raw);    // –ø—Ä–µ–≤—Ä–∞—â–∞–µ–º –≤ –æ–±—ä–µ–∫—Ç\n\nreturn [\n  {\n    json: {\n      ...parsed\n    }\n  }\n];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-384,112],"id":"5684d043-f7ed-4c94-a8d6-bd5c5b56284b","name":"Code in JavaScript"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":3},"conditions":[{"id":"9aee842b-dc72-4c6c-9b85-23e15dcbbf7e","leftValue":"={{ $json.intent }}","rightValue":"clarify","operator":{"type":"string","operation":"equals"}}],"combinator":"or"},"looseTypeValidation":true,"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.3,"position":[-32,240],"id":"608cdac9-ff04-442e-9c23-9be70e030373","name":"If2"},{"parameters":{"method":"=POST","url":"=https://api.telegram.org/bot7907939704:AAHqQu-Uy4q8iKnknxqBzHQUWcz5IjNZrjA/sendMessage","sendQuery":true,"queryParameters":{"parameters":[{"name":"business_connection_id","value":"={{ $('Telegram Trigger').item.json.business_message.business_connection_id }}"},{"name":"chat_id","value":"={{ $('Telegram Trigger').item.json.business_message.chat.id }}"},{"name":"text","value":"={{ $json.out }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.3,"position":[464,144],"id":"2482d9d7-6fc5-4ac5-a065-045b8109d17f","name":"HTTP Request6"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":3},"conditions":[{"id":"8fbc00cd-b021-40d8-bdfb-6fa570865640","leftValue":"={{ $('Switch1').item.json.step }}","rightValue":"wait_on","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"wait_on"}]},"looseTypeValidation":true,"options":{"fallbackOutput":"extra"}},"type":"n8n-nodes-base.switch","typeVersion":3.4,"position":[-208,112],"id":"2ee78176-8c22-4924-b932-273e984a74a7","name":"Switch3"},{"parameters":{"conditions":{"options":{"caseSensitive":false,"leftValue":"","typeValidation":"loose","version":3},"conditions":[{"id":"9aee842b-dc72-4c6c-9b85-23e15dcbbf7e","leftValue":"={{ $('Telegram Trigger').item.json.business_message.text }}","rightValue":"–¥–∞","operator":{"type":"string","operation":"equals"}},{"id":"7ad55d86-46aa-4328-b3f2-a0d4b3943361","leftValue":"={{ $('Switch1').item.json.step }}","rightValue":"wait_on","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"or"},"looseTypeValidation":true,"options":{"ignoreCase":true}},"type":"n8n-nodes-base.if","typeVersion":2.3,"position":[-944,-192],"id":"a02a0913-0158-41e7-ada6-f4c22a306cb5","name":"If3"},{"parameters":{"method":"=POST","url":"=https://api.telegram.org/bot7907939704:AAHqQu-Uy4q8iKnknxqBzHQUWcz5IjNZrjA/sendMessage","sendQuery":true,"queryParameters":{"parameters":[{"name":"business_connection_id","value":"={{ $('Telegram Trigger').item.json.business_message.business_connection_id }}"},{"name":"chat_id","value":"={{ $('Telegram Trigger').item.json.business_message.chat.id }}"},{"name":"text","value":"=–î–∞–Ω–Ω—ã–µ —Å–±—Ä–æ—à–µ–Ω—ã. "}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.3,"position":[-1328,48],"id":"b14af08c-8dfb-4205-b755-24bcdf6c37ee","name":"HTTP Request7"},{"parameters":{"method":"=POST","url":"=https://api.telegram.org/bot7907939704:AAHqQu-Uy4q8iKnknxqBzHQUWcz5IjNZrjA/sendMessage","sendQuery":true,"queryParameters":{"parameters":[{"name":"business_connection_id","value":"={{ $('Telegram Trigger').item.json.business_message.business_connection_id }}"},{"name":"chat_id","value":"={{ $('Telegram Trigger').item.json.business_message.chat.id }}"},{"name":"text","value":"={{ $json.out }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.3,"position":[-32,96],"id":"80827663-9fb7-4ac0-96c0-e4c33b6bc675","name":"HTTP Request8"},{"parameters":{"operation":"executeQuery","query":"update bot_user_state\nset state = null,\n    step = null,\n    data = '{}'::jsonb,\n    updated_at = now()\nwhere user_id = $1;\n","options":{"queryReplacement":"={{ $('Telegram Trigger').item.json.business_message.chat.id }}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[112,96],"id":"1594da86-31e0-4787-84bb-0714b33af4c6","name":"Execute a SQL query5","credentials":{"postgres":{"id":"bNYxHjx2dgnO3BKs","name":"Postgres account"}}}],"connections":{"Telegram Trigger":{"main":[[{"node":"If1","type":"main","index":0}]]},"Switch":{"main":[[{"node":"Edit Fields","type":"main","index":0}],[{"node":"Get a file","type":"main","index":0}]]},"Get a file":{"main":[[{"node":"Transcribe a recording","type":"main","index":0}]]},"Transcribe a recording":{"main":[[{"node":"Edit Fields","type":"main","index":0}]]},"Edit Fields":{"main":[[{"node":"AI Agent","type":"main","index":0}]]},"OpenAI Chat Model":{"ai_languageModel":[[{"node":"AI Agent","type":"ai_languageModel","index":0}]]},"AI Agent":{"main":[[{"node":"HTTP Request","type":"main","index":0}]]},"Simple Memory":{"ai_memory":[[{"node":"AI Agent","type":"ai_memory","index":0},{"node":"AI Agent1","type":"ai_memory","index":0}]]},"If1":{"main":[[{"node":"Execute a SQL query","type":"main","index":0}],[]]},"Check Consultation":{"main":[[{"node":"Execute a SQL query1","type":"main","index":0}],[{"node":"Switch","type":"main","index":0}]]},"Execute a SQL query":{"main":[[{"node":"Switch1","type":"main","index":0}]]},"Execute a SQL query1":{"main":[[{"node":"HTTP Request4","type":"main","index":0}]]},"Switch1":{"main":[[{"node":"Switch2","type":"main","index":0}],[],[{"node":"Check Consultation","type":"main","index":0}]]},"HTTP Request4":{"main":[[{"node":"Execute a SQL query2","type":"main","index":0}]]},"Execute a SQL query2":{"main":[[]]},"Consultation Memory":{"ai_memory":[[]]},"OpenAI Chat Model1":{"ai_languageModel":[[{"node":"AI Agent1","type":"ai_languageModel","index":0}]]},"Get availability in a calendar in Google Calendar":{"ai_tool":[[{"node":"AI Agent1","type":"ai_tool","index":0}]]},"Create an event in Google Calendar":{"ai_tool":[[{"node":"AI Agent1","type":"ai_tool","index":0}]]},"Switch2":{"main":[[{"node":"AI Agent1","type":"main","index":0}],[{"node":"If3","type":"main","index":0}],[{"node":"HTTP Request4","type":"main","index":0}]]},"AI Agent1":{"main":[[{"node":"Code in JavaScript","type":"main","index":0}]]},"HTTP Request5":{"main":[[{"node":"Execute a SQL query4","type":"main","index":0}]]},"Code in JavaScript":{"main":[[{"node":"Switch3","type":"main","index":0}]]},"If2":{"main":[[{"node":"HTTP Request6","type":"main","index":0}],[{"node":"HTTP Request5","type":"main","index":0}]]},"Switch3":{"main":[[{"node":"HTTP Request8","type":"main","index":0}],[{"node":"If2","type":"main","index":0}]]},"If3":{"main":[[{"node":"AI Agent1","type":"main","index":0}],[{"node":"Execute a SQL query3","type":"main","index":0}]]},"Execute a SQL query3":{"main":[[{"node":"HTTP Request7","type":"main","index":0}]]},"HTTP Request8":{"main":[[{"node":"Execute a SQL query5","type":"main","index":0}]]}},"authors":"–†–æ–º–∞–Ω –ú–∞—Ö–º–µ—Ç–æ–≤","name":"Version b299a2b4","description":"","autosaved":false},"tags":[]},{"updatedAt":"2026-01-25T09:57:55.160Z","createdAt":"2026-01-25T09:56:37.167Z","id":"pImFSrU577AwUoz4","name":"My Sub-Workflow 2","active":false,"isArchived":true,"nodes":[{"parameters":{"inputSource":"passthrough"},"id":"c055762a-8fe7-4141-a639-df2372f30060","typeVersion":1.1,"name":"When Executed by Another Workflow","type":"n8n-nodes-base.executeWorkflowTrigger","position":[272,352]},{"parameters":{},"id":"b5942df6-0160-4ef7-965d-57583acdc8aa","name":"Replace me with your logic","type":"n8n-nodes-base.noOp","position":[528,352]}],"connections":{"When Executed by Another Workflow":{"main":[[{"node":"Replace me with your logic","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","availableInMCP":false},"staticData":null,"meta":null,"pinData":{},"versionId":"f7b11bc1-a356-48dd-8642-1446218548d3","activeVersionId":null,"triggerCount":0,"shared":[{"updatedAt":"2026-01-25T09:56:37.167Z","createdAt":"2026-01-25T09:56:37.167Z","role":"workflow:owner","workflowId":"pImFSrU577AwUoz4","projectId":"UnFAqkOZkFc92cC9"}],"activeVersion":null,"tags":[]}],"nextCursor":null}